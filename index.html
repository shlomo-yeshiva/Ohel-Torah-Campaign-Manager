<!DOCTYPE html>
<html lang="he" dir="rtl">
   <head>
      <base target="_top">
      <meta charset="utf-8">
      <!-- הגדרות PWA ומובייל -->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
      <meta name="mobile-web-app-capable" content="yes">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
      <meta name="theme-color" content="#D4A574">
      <title>ניהול חדר הת״ת</title>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
      <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css">
      <!-- הסתרת הבאנר התכלת של Google Apps Script - גרסה אגרסיבית מאוד -->
      <script>
         (function() {
           // CSS אגרסיבי מאוד - הסתרת כל דבר תכלת/כחול
           var style = document.createElement('style');
           style.id = 'hide-google-banner-style';
           style.textContent = `
             /* הסתרת כל div בראש body ללא ID או class שלנו */
             body > div:first-child:not([id]):not([class*="navbar"]):not([class*="container"]):not([class*="content"]) {
               display: none !important;
               visibility: hidden !important;
               height: 0 !important;
               overflow: hidden !important;
               margin: 0 !important;
               padding: 0 !important;
               max-height: 0 !important;
               opacity: 0 !important;
               position: absolute !important;
               left: -9999px !important;
               pointer-events: none !important;
             }
             /* הסתרת כל div עם רקע תכלת/כחול */
             div[style*="e8f0fe"],
             div[style*="rgb(232, 240, 254)"],
             div[style*="rgb(240, 248, 255)"],
             div[style*="232, 240, 254"],
             div[style*="240, 248, 255"],
             div[style*="background-color: rgb(232, 240, 254)"],
             div[style*="background-color:rgb(232, 240, 254)"],
             div[style*="background: rgb(232, 240, 254)"],
             div[style*="background:rgb(232, 240, 254)"] {
               display: none !important;
               visibility: hidden !important;
               height: 0 !important;
               max-height: 0 !important;
               opacity: 0 !important;
               position: absolute !important;
               left: -9999px !important;
               pointer-events: none !important;
             }
             div[aria-label*="application was created"],
             div[aria-label*="This application"],
             div[aria-label*="Learn more"],
             div[aria-label*="created by a Google Apps Script"] {
               display: none !important;
               visibility: hidden !important;
               height: 0 !important;
               opacity: 0 !important;
               position: absolute !important;
               left: -9999px !important;
               pointer-events: none !important;
             }
             /* הסתרת כל div עם טקסט של הבאנר */
             div:has-text("This application was created"),
             div:has-text("application was created"),
             div:has-text("Learn more") {
               display: none !important;
               visibility: hidden !important;
               height: 0 !important;
               opacity: 0 !important;
               position: absolute !important;
               left: -9999px !important;
               pointer-events: none !important;
             }
           `;
           (document.head || document.documentElement).appendChild(style);
           
           // רובוט שילחץ על כפתור ה-X של הבאנר במהירות עצומה
           function clickBannerCloseButton() {
             try {
               if (!document.body) return;
               
               // חיפוש כל הכפתורים האפשריים של הבאנר
               var possibleCloseButtons = [
                 // כפתורי X רגילים
                 'button[aria-label*="Close"]',
                 'button[aria-label*="close"]',
                 'button[aria-label*="סגור"]',
                 'button[title*="Close"]',
                 'button[title*="close"]',
                 '.close',
                 '[role="button"][aria-label*="Close"]',
                 '[role="button"][aria-label*="close"]',
                 // כפתורים בתוך div עם הטקסט של הבאנר
                 'div[aria-label*="application was created"] button',
                 'div[aria-label*="This application"] button',
                 // כפתורים בתוך div עם רקע תכלת
                 'div[style*="e8f0fe"] button',
                 'div[style*="rgb(232, 240, 254)"] button',
                 'div[style*="rgb(240, 248, 255)"] button'
               ];
               
               // ניסיון למצוא כפתור X בכל האפשרויות
               for (var i = 0; i < possibleCloseButtons.length; i++) {
                 try {
                   var buttons = document.querySelectorAll(possibleCloseButtons[i]);
                   for (var j = 0; j < buttons.length; j++) {
                     var btn = buttons[j];
                     if (btn && btn.offsetParent !== null) { // כפתור גלוי
                       // לחיצה מהירה מאוד
                       btn.click();
                       btn.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));
                       // גם ניסיון עם touch event (למובייל) - רק אם נתמך
                       try {
                         var touchEvent = new Event('touchstart', { bubbles: true, cancelable: true });
                         btn.dispatchEvent(touchEvent);
                       } catch(e) {}
                     }
                   }
                 } catch(e) {}
               }
               
               // חיפוש אגרסיבי יותר - כל כפתור בתוך div עם רקע תכלת
               try {
                 var allDivs = document.querySelectorAll('div');
                 for (var k = 0; k < allDivs.length; k++) {
                   try {
                     var div = allDivs[k];
                     if (!div || !div.parentNode) continue;
                     
                     var bg = window.getComputedStyle(div).backgroundColor;
                     var text = (div.textContent || '').toLowerCase();
                     
                     if ((bg && (bg.includes('232') || bg.includes('240') || bg.includes('254'))) ||
                         text.includes('application was created') ||
                         text.includes('this application')) {
                       // חיפוש כפתור X בתוך הדיב הזה
                       var closeBtn = div.querySelector('button, [role="button"], .close, [aria-label*="close" i]');
                       if (closeBtn && closeBtn.offsetParent !== null) {
                         closeBtn.click();
                         closeBtn.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));
                       }
                     }
                   } catch(e) {}
                 }
               } catch(e) {}
             } catch(e) {
               // שגיאה - נמשיך
             }
           }
           
           // פונקציה להסרת הבאנר - גרסה אגרסיבית מאוד
           function removeBanner() {
             try {
               // בדיקה ש-body קיים
               if (!document.body) return;
               
               // קודם כל - ניסיון ללחוץ על כפתור ה-X במהירות עצומה
               clickBannerCloseButton();
               
               // הסרת כל div בראש body ללא ID או class שלנו
               var children = Array.from(document.body.children);
               for (var i = 0; i < children.length; i++) {
                 var child = children[i];
                 if (!child || child.tagName !== 'DIV') continue;
                 
                 // בדיקה אם זה הבאנר
                 var hasId = child.id && child.id.length > 0;
                 var hasOurClass = child.classList.contains('navbar') || 
                                   child.classList.contains('container') || 
                                   child.classList.contains('content');
                 
                 if (!hasId && !hasOurClass) {
                   try {
                     var bg = window.getComputedStyle(child).backgroundColor;
                     var text = (child.textContent || '').toLowerCase();
                     var ariaLabel = (child.getAttribute('aria-label') || '').toLowerCase();
                     var styleAttr = (child.getAttribute('style') || '').toLowerCase();
                     
                     // בדיקה אם זה הבאנר לפי רקע, טקסט או style
                     if ((bg && (bg.includes('232') || bg.includes('240') || bg.includes('254') || bg.includes('rgb(232'))) ||
                         text.includes('application was created') ||
                         text.includes('this application') ||
                         text.includes('learn more') ||
                         ariaLabel.includes('application was created') ||
                         styleAttr.includes('e8f0fe') ||
                         styleAttr.includes('232, 240, 254')) {
                       child.remove();
                       continue;
                     }
                     
                     // אם הגובה קטן מ-100px ולא יש לנו class, נסה להסיר
                     if (child.offsetHeight < 100 && child.offsetHeight > 0) {
                       child.remove();
                     }
                   } catch(e) {
                     // אם יש שגיאה, נסה להסיר בכל מקרה אם אין ID
                     try {
                       if (!hasId) child.remove();
                     } catch(e2) {}
                   }
                 }
               }
               
               // הסרת כל div עם הטקסט של הבאנר - חיפוש בכל העץ
               try {
                 var allDivs = document.querySelectorAll('div');
                 for (var i = 0; i < allDivs.length; i++) {
                   try {
                     var div = allDivs[i];
                     if (!div || !div.parentNode) continue;
                     
                     var text = (div.textContent || '').toLowerCase();
                     var ariaLabel = (div.getAttribute('aria-label') || '').toLowerCase();
                     var styleAttr = (div.getAttribute('style') || '').toLowerCase();
                     var hasId = div.id && div.id.length > 0;
                     var hasOurClass = div.classList.contains('navbar') || 
                                       div.classList.contains('container') || 
                                       div.classList.contains('content') ||
                                       div.classList.contains('card') ||
                                       div.classList.contains('modal');
                     
                     // בדיקה אם זה הבאנר
                     if (!hasId && !hasOurClass) {
                       try {
                         var bg = window.getComputedStyle(div).backgroundColor;
                         
                         if ((text.includes('application was created') || 
                              text.includes('this application') ||
                              text.includes('learn more') ||
                              ariaLabel.includes('application was created') ||
                              (bg && (bg.includes('232') || bg.includes('240') || bg.includes('254') || bg.includes('rgb(232'))) ||
                              styleAttr.includes('e8f0fe') ||
                              styleAttr.includes('232, 240, 254')) &&
                             div.offsetHeight < 200) {
                           div.remove();
                           continue;
                         }
                       } catch(e) {}
                     }
                   } catch(e) {
                     continue;
                   }
                 }
               } catch(e) {}
             } catch(e) {
               // שגיאה כללית - פשוט נמשיך
             }
           }
           
           // הרצה מיידית רק אם body קיים
           if (document.body) {
             removeBanner();
           } else {
             // נחכה ל-body
             var checkBody = setInterval(function() {
               if (document.body) {
                 clearInterval(checkBody);
                 removeBanner();
               }
             }, 10);
           }
           
           // MutationObserver לעקוב אחרי שינויים ב-DOM - עם לחיצה מהירה מאוד על X
           if (window.MutationObserver) {
             try {
               var observer = new MutationObserver(function(mutations) {
                 // לחיצה מהירה מאוד על כפתור X לפני הסרת הבאנר
                 clickBannerCloseButton();
                 removeBanner();
               });
               
               // התחלת תצפית מיד כש-body קיים
               if (document.body) {
                 observer.observe(document.body, {
                   childList: true,
                   subtree: true,
                   attributes: true,
                   attributeFilter: ['style', 'class']
                 });
               } else {
                 // נחכה ל-body
                 var checkBodyObserver = setInterval(function() {
                   if (document.body) {
                     clearInterval(checkBodyObserver);
                     observer.observe(document.body, {
                       childList: true,
                       subtree: true,
                       attributes: true,
                       attributeFilter: ['style', 'class']
                     });
                   }
                 }, 10);
               }
             } catch(e) {}
           }
           
           // הרצה תקופתית - גם עם לחיצה מהירה על X
           var intervals = [0, 10, 20, 30, 50, 100, 200, 300, 500, 800, 1000, 1500, 2000, 3000];
           intervals.forEach(function(delay) {
             setTimeout(function() {
               clickBannerCloseButton();
               removeBanner();
             }, delay);
           });
           
           // הרצה מהירה מאוד - כל 25ms (יותר אגרסיבי)
           setInterval(function() {
             clickBannerCloseButton();
             removeBanner();
           }, 25);
           
           // גם כשהדף נטען לגמרי
           if (document.readyState === 'loading') {
             document.addEventListener('DOMContentLoaded', removeBanner);
           } else {
             removeBanner();
           }
           window.addEventListener('load', removeBanner);
         })();
      </script>
      <style>
         /* הסתרת הבאנר התכלת של Google Apps Script - CSS אגרסיבי מאוד */
         /* הסתרת כל div בראש body ללא ID */
         body > div:first-child:not([id]):not([class*="navbar"]):not([class*="container"]):not([class*="content"]) {
         display: none !important;
         visibility: hidden !important;
         height: 0 !important;
         overflow: hidden !important;
         margin: 0 !important;
         padding: 0 !important;
         max-height: 0 !important;
         opacity: 0 !important;
         position: absolute !important;
         left: -9999px !important;
         pointer-events: none !important;
         z-index: -9999 !important;
         }
         div[aria-label*="application was created"],
         div[aria-label*="This application"],
         div[aria-label*="Learn more"],
         div[aria-label*="created by a Google Apps Script"],
         div[style*="e8f0fe"],
         div[style*="rgb(232, 240, 254)"],
         div[style*="rgb(240, 248, 255)"],
         div[style*="232, 240, 254"],
         div[style*="240, 248, 255"],
         div[style*="background-color: rgb(232, 240, 254)"],
         div[style*="background-color:rgb(232, 240, 254)"],
         div[style*="background: rgb(232, 240, 254)"],
         div[style*="background:rgb(232, 240, 254)"] {
         display: none !important;
         visibility: hidden !important;
         height: 0 !important;
         max-height: 0 !important;
         opacity: 0 !important;
         position: absolute !important;
         left: -9999px !important;
         pointer-events: none !important;
         z-index: -9999 !important;
         }
         html, body {
         height: 100%;
         margin: 0;
         padding: 0;
         }
         body {
         font-family: 'Heebo', sans-serif;
         background-color: #F5E6D3;
         background-image: url('https://i.postimg.cc/ZRMCLxgW/lwgw-t-t-dhws.png');
         background-size: cover;
         background-position: center;
         background-attachment: fixed;
         background-repeat: no-repeat;
         display: flex;
         flex-direction: column;
         min-height: 100vh;
         padding-top: 0 !important;
         margin-top: 0 !important;
         top: 0 !important;
         -webkit-tap-highlight-color: transparent;
         overscroll-behavior-y: none;
         }
         /* Navbar - לא יתפוס מקום נוסף */
         .navbar {
         flex-shrink: 0;
         }
         /* אזור התוכן - יתפוס את כל המקום הפנוי */
         #itemsView.active,
         #statsView.active,
         #profitsView.active,
         #salesHistoryView.active,
         #categoriesView.active,
         #categoriesBrowseView.active {
         flex: 1 0 auto;
         display: flex;
         flex-direction: column;
         }
         /* Container בתוך התצוגות */
         #itemsView.active .container,
         #statsView.active .container,
         #profitsView.active .container,
         #salesHistoryView.active .container,
         #categoriesView.active .container,
         #categoriesBrowseView.active .container {
         flex: 1 0 auto;
         }
         /* הסתרת הבאנר - גישה נוספת - הסרת כל div ראשון ללא ID */
         html > body > div:first-child:not([id]):not([class*="navbar"]):not([class*="container"]):not([class*="content"]) {
         display: none !important;
         height: 0 !important;
         visibility: hidden !important;
         opacity: 0 !important;
         position: absolute !important;
         left: -9999px !important;
         pointer-events: none !important;
         z-index: -9999 !important;
         overflow: hidden !important;
         margin: 0 !important;
         padding: 0 !important;
         max-height: 0 !important;
         }
         /* הסתרת הבאנר - גישה נוספת */
         html > body > div:first-child:not([id]):not([class]):not([class*="navbar"]):not([class*="container"]) {
         display: none !important;
         height: 0 !important;
         visibility: hidden !important;
         opacity: 0 !important;
         position: absolute !important;
         left: -9999px !important;
         pointer-events: none !important;
         }
         /* הסתרת כל div עם רקע תכלת/כחול בהיר */
         div[style*="background"]:not([id]):not([class]) {
         background: transparent !important;
         }
         .navbar {
         position: sticky;
         top: 0;
         z-index: 1000;
         background: #D4A574;
         box-shadow: 0 1px 3px rgba(0,0,0,0.1);
         padding-top: env(safe-area-inset-top);
         padding-bottom: 0;
         min-height: 75px;
         }
         .navbar-logo {
         height: 75px;
         width: auto;
         max-width: 280px;
         object-fit: contain;
         margin-left: 10px;
         filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
         }
         .navbar-brand {
         display: flex;
         align-items: center;
         gap: 10px;
         font-size: 1.3rem;
         font-weight: bold;
         z-index: 2;
         position: relative;
         }
         .main-nav-menu {
         display: flex;
         gap: 4px;
         align-items: stretch;
         justify-content: center;
         flex: 1;
         margin: 0 auto;
         height: 100%;
         position: absolute;
         left: 50%;
         transform: translateX(-50%);
         z-index: 1;
         }
         .main-nav-menu .nav-link {
         color: white;
         padding: 0 20px;
         border-radius: 0;
         font-size: 0.95rem;
         transition: all 0.3s;
         border: none;
         background: transparent;
         display: flex;
         align-items: center;
         justify-content: center;
         height: 100%;
         min-height: 75px;
         }
         .main-nav-menu .nav-link:hover {
         background: rgba(255,255,255,0.1);
         color: white;
         }
         .main-nav-menu .nav-link.active {
         background: white;
         color: #8d6e63;
         font-weight: 600;
         height: 100%;
         margin: 0;
         align-self: stretch;
         }
         .navbar .container-fluid {
         min-height: 75px;
         display: flex;
         align-items: stretch;
         padding: 0 15px;
         position: relative;
         justify-content: space-between;
         }
         .navbar {
         padding: 0;
         }
         .categories-dropdown {
         position: relative;
         }
         .categories-dropdown .nav-link {
         cursor: pointer;
         }
         #categoriesArrow {
         display: inline-block;
         transition: transform 0.3s ease;
         }
         .categories-menu {
         position: absolute;
         top: 100%;
         right: 0;
         background: white;
         box-shadow: 0 4px 20px rgba(0,0,0,0.15);
         border-radius: 8px;
         display: none;
         z-index: 1001;
         width: 900px;
         max-width: 95vw;
         margin-top: 5px;
         overflow: hidden;
         }
         @media (max-width: 768px) {
         .categories-menu {
         width: 95vw;
         right: 0;
         left: 0;
         margin: 5px auto 0;
         }
         }
         .categories-menu.show {
         display: flex;
         }
         .categories-menu-left {
         flex: 2;
         padding: 20px;
         background: #f8f9fa;
         max-height: 600px;
         overflow-y: auto;
         }
         .categories-menu-right {
         flex: 1;
         padding: 15px 0;
         background: white;
         border-right: 1px solid #e0e0e0;
         max-height: 600px;
         overflow-y: auto;
         min-width: 200px;
         }
         .category-list-item {
         padding: 12px 20px;
         cursor: pointer;
         transition: all 0.2s;
         border-right: 3px solid transparent;
         display: flex;
         justify-content: space-between;
         align-items: center;
         color: #333;
         font-size: 0.9rem;
         }
         .category-list-item:hover {
         background: #f0f0f0;
         border-right-color: #D4A574;
         }
         .category-list-item.active {
         background: #f8f9fa;
         border-right-color: #D4A574;
         font-weight: 600;
         color: #8d6e63;
         }
         .category-products-grid {
         display: grid;
         grid-template-columns: repeat(4, 1fr);
         gap: 15px;
         }
         @media (max-width: 992px) {
         .category-products-grid {
         grid-template-columns: repeat(3, 1fr);
         }
         }
         @media (max-width: 768px) {
         .category-products-grid {
         grid-template-columns: repeat(2, 1fr);
         }
         }
         .category-product-item {
         background: white;
         border-radius: 8px;
         padding: 10px;
         text-align: center;
         cursor: pointer;
         transition: all 0.2s;
         border: 1px solid #e0e0e0;
         }
         .category-product-item:hover {
         box-shadow: 0 4px 12px rgba(0,0,0,0.1);
         transform: translateY(-2px);
         }
         .category-product-item img {
         width: 100%;
         height: 120px;
         object-fit: cover;
         border-radius: 6px;
         margin-bottom: 8px;
         }
         .category-product-item .product-name {
         font-size: 0.85rem;
         font-weight: 500;
         color: #333;
         margin: 0;
         }
         .categories-menu-title {
         font-size: 1.1rem;
         font-weight: 600;
         margin-bottom: 15px;
         color: #333;
         padding-bottom: 10px;
         border-bottom: 2px solid #D4A574;
         }
         .card-item {
         border: 1px solid #e8e8e8;
         border-radius: 12px;
         overflow: hidden;
         transition: box-shadow 0.2s ease;
         background: white;
         box-shadow: 0 1px 3px rgba(0,0,0,0.08);
         display: flex;
         flex-direction: column;
         }
         .card-item:hover {
         box-shadow: 0 2px 8px rgba(0,0,0,0.12);
         border-color: #d0d0d0;
         }
         .card-img-top {
         height: 250px;
         width: 100%;
         object-fit: contain; 
         background-color: #ffffff;
         padding: 8px;
         border-bottom: 1px solid #f0f0f0;
         }
         .price-badge {
         background: #D4A574;
         color: white;
         padding: 4px 12px;
         border-radius: 6px;
         font-weight: 600;
         font-size: 0.85rem;
         display: inline-block;
         }
         /* --- Lightbox --- */
         #imageViewer {
         display: none;
         position: fixed;
         z-index: 9999;
         left: 0;
         top: 0;
         width: 100%;
         height: 100%;
         background-color: rgba(0, 0, 0, 0.95);
         display: flex;
         justify-content: center;
         align-items: center;
         overflow: hidden; 
         }
         #fullImage {
         max-width: 100vw;
         max-height: 90vh;
         width: auto;
         height: auto;
         object-fit: contain;
         transition: none;
         cursor: zoom-in;
         }
         /* --- מצב זום פעיל --- */
         #imageViewer.active-zoom {
         display: block; 
         overflow: auto; 
         -webkit-overflow-scrolling: touch; 
         }
         /* הגדרת זום למובייל (ברירת מחדל) */
         #imageViewer.active-zoom #fullImage {
         max-width: none;
         max-height: none;
         width: 250%;
         margin: 0;
         cursor: zoom-out;
         }
         /* --- תיקון למחשב (Desktop) --- */
         @media (min-width: 992px) {
         #imageViewer.active-zoom #fullImage {
         width: auto;      
         height: auto;
         min-width: 100%;  
         max-width: 100%;
         margin: 0 auto;   
         }
         }
         .close-viewer-btn {
         position: fixed; 
         top: 20px;
         left: 20px;
         color: white;
         font-size: 30px;
         background: rgba(0,0,0,0.6);
         border-radius: 50%;
         width: 45px;
         height: 45px;
         display: flex;
         align-items: center;
         justify-content: center;
         cursor: pointer;
         z-index: 10001;
         border: 2px solid rgba(255,255,255,0.3);
         }
         .viewer-hint {
         position: fixed;
         bottom: 30px;
         width: 100%;
         text-align: center;
         color: rgba(255,255,255,0.6);
         font-size: 0.8rem;
         pointer-events: none;
         z-index: 10001;
         }
         .traffic-light-container {
         display: flex;
         gap: 3px;
         background: #f8f9fa;
         padding: 3px 5px;
         border-radius: 20px;
         border: 1px solid #e9ecef;
         }
         .dot {
         width: 9px;
         height: 9px;
         border-radius: 50%;
         opacity: 0.15; 
         transition: all 0.3s;
         }
         .dot.active {
         opacity: 1;
         transform: scale(1.2);
         box-shadow: 0 0 4px rgba(0,0,0,0.2);
         }
         .dot-0 { background-color: #6c757d; }
         .dot-1 { background-color: #198754; }
         .dot-2 { background-color: #fd7e14; }
         .dot-3 { background-color: #dc3545; }
         .status-option {
         cursor: pointer;
         width: 30px;
         height: 30px;
         margin: 0 5px;
         border: 2px solid transparent;
         }
         .status-option:hover { opacity: 0.6; }
         .status-option.selected {
         opacity: 1;
         transform: scale(1.2);
         border-color: #333;
         }
         .company-badge {
         font-size: 0.7rem;
         background-color: #6d4c41;
         color: #ffffff;
         padding: 2px 6px;
         border-radius: 4px;
         font-weight: 600;
         max-width: 80px;
         overflow: hidden;
         text-overflow: ellipsis;
         white-space: nowrap;
         }
         .company-badge.border {
         border: 1px solid #5d4037 !important;
         }
         .size-badge {
         font-size: 0.75rem;
         background-color: #5d4037;
         color: #ffffff;
         padding: 4px 8px;
         border-radius: 6px;
         font-weight: 600;
         display: inline-block;
         margin-right: 6px;
         box-shadow: 0 1px 3px rgba(0,0,0,0.2);
         }
         /* Pagination בסגנון AliExpress */
         .ali-pagination-container {
         display: flex;
         align-items: center;
         justify-content: center;
         gap: 8px;
         flex-wrap: wrap;
         padding: 12px 0;
         }
         .ali-pagination-btn {
         min-width: 36px;
         height: 36px;
         padding: 0 12px;
         border: 1px solid #e0e0e0;
         background: #fff;
         color: #333;
         border-radius: 4px;
         cursor: pointer;
         display: flex;
         align-items: center;
         justify-content: center;
         font-size: 14px;
         transition: all 0.2s ease;
         font-weight: 500;
         }
         .ali-pagination-btn:hover:not(.disabled):not(.active) {
         border-color: #D4A574;
         color: #D4A574;
         background: #f9f7f4;
         }
         .ali-pagination-btn.active {
         background: #D4A574;
         border-color: #D4A574;
         color: #fff;
         font-weight: 600;
         }
         .ali-pagination-btn.disabled {
         opacity: 0.5;
         cursor: not-allowed;
         background: #f5f5f5;
         }
         .ali-pagination-ellipsis {
         padding: 0 8px;
         color: #999;
         font-weight: 500;
         }
         .ali-pagination-jump {
         display: flex;
         align-items: center;
         gap: 6px;
         margin-right: 12px;
         padding-right: 12px;
         border-right: 1px solid #e0e0e0;
         }
         .ali-pagination-jump-text {
         font-size: 14px;
         color: #666;
         white-space: nowrap;
         }
         .ali-pagination-input {
         width: 50px;
         height: 32px;
         padding: 0 8px;
         border: 1px solid #e0e0e0;
         border-radius: 4px;
         text-align: center;
         font-size: 14px;
         transition: border-color 0.2s;
         }
         .ali-pagination-input:focus {
         outline: none;
         border-color: #D4A574;
         box-shadow: 0 0 0 2px rgba(212, 165, 116, 0.1);
         }
         .pagination-wrapper {
         display: flex;
         flex-direction: column;
         align-items: center;
         width: 100%;
         }
         .pagination-info {
         margin-bottom: 8px;
         }
         @media (max-width: 768px) {
         .ali-pagination-container {
         gap: 4px;
         }
         .ali-pagination-btn {
         min-width: 32px;
         height: 32px;
         padding: 0 8px;
         font-size: 12px;
         }
         .ali-pagination-jump {
         margin-right: 8px;
         padding-right: 8px;
         }
         .ali-pagination-jump-text {
         font-size: 12px;
         }
         }
         .image-upload-label {
         display: flex;
         width: 100%;
         height: 200px;
         border: 2px dashed #D4A574;
         border-radius: 12px;
         align-items: center;
         justify-content: center;
         cursor: pointer;
         background-position: center;
         background-size: contain;
         background-repeat: no-repeat;
         background-color: #F5E6D3;
         position: relative;
         transition: all 0.3s;
         }
         .image-upload-label.has-image {
         background-color: #ffffff !important;
         background-size: contain;
         }
         .image-upload-label:hover {
         border-color: #B8956A;
         background-color: #F0E0C8;
         }
         .image-upload-label.has-image:hover {
         background-color: #ffffff !important;
         }
         .image-upload-label i { font-size: 2.5rem; color: #D4A574; }
         .image-upload-label.has-image i { opacity: 0; }
         /* עורך תמונות */
         .image-editor-container {
         max-width: 100%;
         max-height: 500px;
         overflow: hidden;
         background: #f5f5f5;
         border-radius: 8px;
         padding: 10px;
         }
         .image-editor-container img {
         max-width: 100%;
         max-height: 500px;
         display: block;
         }
         #imageEditorModal .modal-body {
         max-height: 70vh;
         overflow-y: auto;
         }
         /* Responsive - כרטיסיות */
         #salesHistoryView .container {
         max-width: 90%;
         margin: 0 auto;
         }
         #itemsView .container,
         #statsView .container,
         #profitsView .container,
         #categoriesView .container {
         max-width: 90%;
         margin: 0 auto;
         }
         @media (max-width: 768px) {
         #salesHistoryView .container,
         #itemsView .container,
         #statsView .container,
         #profitsView .container,
         #categoriesView .container {
         max-width: 100%;
         padding-left: 10px;
         padding-right: 10px;
         }
         .calendar-container {
         max-width: 100%;
         }
         }
         /* שיפור ניווט לטבלט */
         @media (min-width: 768px) and (max-width: 1024px) {
         .navbar {
         padding: 0.5rem 1rem;
         min-height: 70px;
         }
         .nav-link {
         padding: 0.5rem 0.75rem;
         font-size: 0.85rem;
         white-space: nowrap;
         min-height: 70px;
         }
         .main-nav-menu {
         flex-wrap: wrap;
         justify-content: center;
         position: absolute;
         left: 50%;
         transform: translateX(-50%);
         gap: 2px;
         }
         .navbar-brand {
         font-size: 1.1rem;
         }
         .navbar-logo {
         height: 65px;
         max-width: 240px;
         }
         .navbar .container-fluid {
         min-height: 70px;
         }
         .calendar-container {
         max-width: 240px;
         }
         #salesHistoryView .container,
         #itemsView .container,
         #statsView .container,
         #profitsView .container,
         #categoriesView .container {
         max-width: 95%;
         padding-left: 15px;
         padding-right: 15px;
         }
         /* כרטיסי KPI לטבלט */
         .kpi-card {
         padding: 15px;
         }
         .kpi-card h6 {
         font-size: 0.85rem;
         }
         .stat-value {
         font-size: 1.4rem;
         }
         /* כרטיסי מוצרים לטבלט */
         .card-item {
         margin-bottom: 10px;
         }
         .card-item .card-body {
         padding: 12px;
         }
         /* טבלאות לטבלט */
         .table-responsive {
         font-size: 0.9rem;
         }
         .table th,
         .table td {
         padding: 8px 6px;
         font-size: 0.85rem;
         }
         /* מודלים לטבלט */
         .modal-dialog {
         max-width: 90%;
         margin: 1rem auto;
         }
         /* סטטיסטיקות לטבלט */
         .stats-card {
         padding: 15px;
         margin-bottom: 15px;
         }
         .stats-card h6 {
         font-size: 1rem;
         }
         /* פילטרים לטבלט */
         .form-select-sm,
         .form-control-sm {
         font-size: 0.8rem;
         padding: 0.35rem 0.65rem;
         }
         /* Pagination לטבלט */
         .ali-pagination-container {
         flex-wrap: wrap;
         gap: 4px;
         }
         .ali-pagination-btn {
         padding: 6px 12px;
         font-size: 0.85rem;
         }
         /* גרפים לטבלט */
         canvas {
         max-height: 250px !important;
         }
         /* Carousel לטבלט */
         .products-carousel-container {
         padding: 0 30px;
         }
         .product-card-carousel {
         min-width: 140px;
         max-width: 140px;
         }
         }
         @media (min-width: 1025px) {
         .calendar-container {
         max-width: 280px;
         }
         }
         /* התאמות נוספות לטבלטים - שיפור חוויית משתמש */
         @media (min-width: 768px) and (max-width: 1024px) {
         /* שיפור תצוגת כרטיסי מוצרים */
         .col-6.col-md-4.col-lg-3 {
         flex: 0 0 50%;
         max-width: 50%;
         }
         /* שיפור תצוגת כרטיסי KPI */
         .row.g-2 .col-6 {
         flex: 0 0 50%;
         max-width: 50%;
         }
         .row.g-2 .col-6.col-md-4 {
         flex: 0 0 50%;
         max-width: 50%;
         }
         /* שיפור תצוגת פילטרים */
         .row.g-2 .col-12.col-md-6.col-lg-3 {
         flex: 0 0 50%;
         max-width: 50%;
         }
         /* שיפור תצוגת טבלאות */
         .table {
         font-size: 0.9rem;
         }
         /* שיפור תצוגת מודלים */
         .modal-content {
         border-radius: 12px;
         }
         .modal-body {
         padding: 1.25rem;
         }
         /* שיפור תצוגת תמונות במוצרים */
         .card-img-top {
         height: 180px;
         object-fit: cover;
         }
         /* שיפור תצוגת כפתורים */
         .btn {
         font-size: 0.9rem;
         padding: 0.5rem 1rem;
         }
         .btn-sm {
         font-size: 0.8rem;
         padding: 0.4rem 0.8rem;
         }
         /* שיפור תצוגת חיפוש */
         .input-group {
         margin-bottom: 15px;
         }
         /* שיפור תצוגת קטגוריות */
         .category-list-item {
         padding: 12px 15px;
         font-size: 0.9rem;
         }
         /* שיפור תצוגת סטטיסטיקות */
         .stats-card canvas {
         max-height: 250px;
         }
         /* שיפור תצוגת גרפים */
         #quantityChart,
         #valueChart,
         #profitChart {
         max-height: 250px !important;
         }
         /* שיפור תצוגת רשימות */
         .low-stock-item,
         .out-of-stock-item {
         padding: 10px;
         font-size: 0.9rem;
         }
         /* שיפור תצוגת Pagination */
         .pagination-wrapper {
         margin-top: 20px;
         margin-bottom: 15px;
         }
         .ali-pagination-container {
         justify-content: center;
         }
         /* שיפור תצוגת FAB */
         .fab-btn {
         width: 50px;
         height: 50px;
         font-size: 22px;
         bottom: 15px;
         left: 15px;
         }
         /* שיפור תצוגת תצוגת קטגוריות */
         .categories-sidebar-shein {
         width: 220px;
         }
         /* שיפור תצוגת תמונות */
         .image-upload-label {
         min-height: 200px;
         }
         }
         .fab-btn {
         position: fixed;
         bottom: 20px;
         left: 20px;
         width: 56px;
         height: 56px;
         border-radius: 50%;
         box-shadow: 0 2px 8px rgba(0,0,0,0.15);
         z-index: 1000;
         display: flex;
         align-items: center;
         justify-content: center;
         font-size: 24px;
         background: #D4A574;
         color: white;
         border: none;
         transition: box-shadow 0.2s;
         }
         .fab-btn:hover {
         box-shadow: 0 3px 10px rgba(0,0,0,0.2);
         }
         .category-scroll {
         overflow-x: auto;
         white-space: nowrap;
         padding: 10px 0;
         -webkit-overflow-scrolling: touch;
         }
         .nav-pills .nav-link {
         border-radius: 20px;
         margin-left: 6px;
         background: white;
         border: 1px solid #e0e0e0;
         color: #495057;
         padding: 0.4rem 1rem;
         }
         .nav-pills .nav-link.active {
         background: #D4A574;
         color: white;
         border-color: #D4A574;
         }
         /* סטטיסטיקות */
         .stats-card {
         background: white;
         border-radius: 12px;
         padding: 20px;
         box-shadow: 0 2px 8px rgba(0,0,0,0.1);
         margin-bottom: 15px;
         }
         .stats-card h6 {
         color: #666;
         font-size: 0.85rem;
         margin-bottom: 10px;
         }
         .stats-card .stat-value {
         font-size: 1.8rem;
         font-weight: 700;
         color: #D4A574;
         }
         .kpi-card {
         background: white;
         color: #333;
         border-radius: 8px;
         padding: 18px;
         box-shadow: 0 1px 3px rgba(0,0,0,0.1);
         margin-bottom: 15px;
         border: 1px solid #e8e8e8;
         }
         .kpi-card h6 {
         color: #666;
         font-size: 0.85rem;
         margin-bottom: 10px;
         font-weight: 500;
         }
         .kpi-card .stat-value {
         font-size: 1.8rem;
         font-weight: 600;
         color: #333;
         }
         .stat-value-small {
         font-size: 1.3rem;
         font-weight: 600;
         }
         .calc-section {
         border-right: 1px solid #dee2e6;
         padding-right: 20px;
         }
         .calc-section-last {
         padding-left: 0;
         }
         @media (max-width: 767.98px) {
         .calc-section {
         border-right: none;
         border-bottom: 1px solid #dee2e6;
         padding-right: 0;
         padding-bottom: 20px;
         margin-bottom: 20px;
         }
         .calc-section-last {
         border-bottom: none;
         padding-bottom: 0;
         margin-bottom: 0;
         }
         }
         .low-stock-item {
         background: #fff3cd;
         border-right: 4px solid #ffc107;
         padding: 12px;
         border-radius: 8px;
         margin-bottom: 10px;
         }
         /* עיצוב לסינון ומיון */
         .form-select-sm {
         font-size: 0.875rem;
         padding: 0.375rem 0.75rem;
         border: 1px solid #e0e0e0;
         border-radius: 6px;
         }
         .form-label.small {
         font-size: 0.75rem;
         font-weight: 500;
         color: #666;
         margin-bottom: 0.25rem;
         }
         .low-stock-item.danger {
         background: #fff3cd;
         border-right-color: #D4A574;
         }
         #itemsView, #statsView, #profitsView, #salesHistoryView, #categoriesView, #categoriesBrowseView {
         display: none !important;
         }
         #itemsView.active {
         display: block !important;
         }
         #statsView.active {
         display: block !important;
         }
         #profitsView.active {
         display: block !important;
         }
         #salesHistoryView.active {
         display: block !important;
         }
         #categoriesView.active {
         display: block !important;
         }
         #categoriesBrowseView.active {
         display: flex !important;
         }
         /* עיצוב Sidebar בסגנון SHEIN */
         .categories-sidebar-shein {
         position: sticky;
         top: 65px;
         height: calc(100vh - 65px);
         }
         .categories-sidebar-shein .category-list-item {
         padding: 15px 20px;
         cursor: pointer;
         transition: all 0.2s;
         border-right: 3px solid transparent;
         display: flex;
         justify-content: space-between;
         align-items: center;
         color: #333;
         font-size: 0.95rem;
         border-bottom: 1px solid #f0f0f0;
         }
         .categories-sidebar-shein .category-list-item:hover {
         background: #f8f9fa;
         border-right-color: #D4A574;
         }
         .categories-sidebar-shein .category-list-item.active {
         background: #f8f9fa;
         border-right-color: #D4A574;
         font-weight: 600;
         color: #8d6e63;
         }
         .categories-sidebar-shein .category-list-item .bs-cate-text {
         flex: 1;
         }
         .categories-sidebar-shein .category-list-item i {
         color: #999;
         font-size: 0.8rem;
         }
         @media (max-width: 768px) {
         .categories-sidebar-shein {
         width: 200px !important;
         }
         }
         .content-overlay {
         background: white;
         border-radius: 8px;
         padding: 20px;
         margin: 15px;
         box-shadow: 0 1px 3px rgba(0,0,0,0.08);
         }
         .container {
         position: relative;
         z-index: 1;
         }
         .card-item, .stats-card, .kpi-card {
         background: white;
         }
         /* Footer */
         .app-footer {
         background: #2d2d2d;
         color: #D4A574;
         padding: 20px 0;
         border-top: 2px solid #D4A574;
         box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
         position: relative;
         width: 100%;
         flex-shrink: 0;
         margin-top: auto;
         }
         .footer-content {
         max-width: 1200px;
         margin: 0 auto;
         padding: 0 20px;
         text-align: center;
         }
         .footer-text {
         font-size: 0.9rem;
         font-weight: 500;
         color: #D4A574;
         letter-spacing: 0.5px;
         }
         @media (max-width: 768px) {
         .footer-text {
         font-size: 0.8rem;
         }
         }
         /* אינדיקטור טעינה קל ומהיר */
         .app-loader {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background: rgba(255, 255, 255, 0.95);
         display: flex;
         flex-direction: column;
         justify-content: center;
         align-items: center;
         z-index: 9999;
         transition: opacity 0.3s ease-out;
         font-family: 'Heebo', sans-serif;
         opacity: 1;
         pointer-events: auto;
         }
         .app-loader.hidden {
         opacity: 0;
         pointer-events: none;
         }
         .loader-spinner {
         width: 50px;
         height: 50px;
         border: 4px solid #f3f3f3;
         border-top: 4px solid #D4A574;
         border-radius: 50%;
         animation: spin 0.8s linear infinite;
         }
         @keyframes spin {
         0% { transform: rotate(0deg); }
         100% { transform: rotate(360deg); }
         }
         .loader-text {
         margin-top: 20px;
         color: #333;
         font-size: 1rem;
         font-weight: 500;
         }
         /* התאמה לטבלטים */
         @media (min-width: 768px) and (max-width: 1024px) {
         .loader-spinner {
         width: 45px;
         height: 45px;
         border-width: 3px;
         }
         .loader-text {
         font-size: 0.95rem;
         margin-top: 15px;
         }
         }
         /* Carousel למוצרים */
         .products-carousel-container {
         position: relative;
         width: 100%;
         overflow: hidden;
         }
         .products-carousel {
         display: flex;
         gap: 15px;
         overflow-x: auto;
         overflow-y: hidden;
         scroll-behavior: smooth;
         padding: 10px 0;
         -webkit-overflow-scrolling: touch;
         scrollbar-width: thin;
         }
         .products-carousel::-webkit-scrollbar {
         height: 6px;
         }
         .products-carousel::-webkit-scrollbar-track {
         background: #f1f1f1;
         border-radius: 10px;
         }
         .products-carousel::-webkit-scrollbar-thumb {
         background: #D4A574;
         border-radius: 10px;
         }
         .carousel-nav-btn {
         position: absolute;
         top: 50%;
         transform: translateY(-50%);
         background: rgba(212, 165, 116, 0.9);
         color: white;
         border: none;
         width: 40px;
         height: 40px;
         border-radius: 50%;
         display: flex;
         align-items: center;
         justify-content: center;
         cursor: pointer;
         z-index: 10;
         font-size: 1.2rem;
         transition: all 0.3s;
         box-shadow: 0 2px 8px rgba(0,0,0,0.2);
         }
         .carousel-nav-btn:hover {
         background: rgba(212, 165, 116, 1);
         transform: translateY(-50%) scale(1.1);
         }
         .carousel-nav-btn:active {
         transform: translateY(-50%) scale(0.95);
         }
         .carousel-prev {
         right: 10px;
         }
         .carousel-next {
         left: 10px;
         }
         .product-card-carousel {
         min-width: 200px;
         max-width: 200px;
         background: white;
         border-radius: 12px;
         padding: 15px;
         box-shadow: 0 2px 8px rgba(0,0,0,0.1);
         transition: all 0.3s;
         border: 1px solid #e0e0e0;
         }
         .product-card-carousel:hover {
         box-shadow: 0 4px 12px rgba(212, 165, 116, 0.3);
         transform: translateY(-3px);
         }
         .product-card-carousel img {
         width: 100%;
         height: 200px;
         object-fit: contain;
         border-radius: 8px;
         margin-bottom: 10px;
         background-color: #ffffff;
         padding: 5px;
         }
         .product-card-carousel .product-name {
         font-weight: 600;
         font-size: 0.9rem;
         color: #333;
         margin-bottom: 8px;
         overflow: hidden;
         text-overflow: ellipsis;
         white-space: nowrap;
         }
         .product-card-carousel .product-info {
         font-size: 0.85rem;
         color: #666;
         margin-bottom: 5px;
         }
         .product-card-carousel .product-value {
         font-weight: 700;
         color: #D4A574;
         font-size: 1rem;
         }
         @media (max-width: 768px) {
         .product-card-carousel {
         min-width: 160px;
         max-width: 160px;
         }
         .carousel-nav-btn {
         width: 35px;
         height: 35px;
         font-size: 1rem;
         }
         }
      </style>
   </head>
   <body>
      <!-- אינדיקטור טעינה -->
      <div id="appLoader" class="app-loader">
         <div class="loader-spinner"></div>
         <div class="loader-text">טוען נתונים...</div>
      </div>
      <nav class="navbar navbar-dark">
         <div class="container-fluid d-flex align-items-center justify-content-between">
            <span class="navbar-brand mb-0 h1 fw-bold">
            <img src="https://i.postimg.cc/ZRMCLxgW/lwgw-t-t-dhws.png" alt="לוגו" class="navbar-logo">
            <span class="d-none d-md-inline">ניהול הת״ת</span>
            </span>
            <div class="main-nav-menu">
               <a class="nav-link active" href="javascript:void(0)" onclick="switchView('items', event)" id="navItems">ניהול הת״ת</a>
               <a class="nav-link" href="javascript:void(0)" onclick="switchView('categoriesBrowse', event)" id="navCategoriesMenu">קטגוריות</a>
               <a class="nav-link" href="javascript:void(0)" onclick="switchView('stats', event)" id="navStats">סטטיסטיקות</a>
               <a class="nav-link" href="javascript:void(0)" onclick="switchView('profits', event)" id="navProfits">רווחים</a>
               <a class="nav-link" href="javascript:void(0)" onclick="switchView('salesHistory', event)" id="navSalesHistory">היסטוריית מכירות</a>
               <a class="nav-link" href="javascript:void(0)" onclick="switchView('categories', event)" id="navCategories">נהל מדורים</a>
            </div>
            <div class="d-flex align-items-center gap-2" style="width: 220px; justify-content: flex-end;">
               <button id="syncButton" class="btn btn-light btn-sm" onclick="syncWithSalesSystems()" style="font-size: 0.85rem; padding: 8px 12px; min-width: 100px; white-space: nowrap;">
               <i class="bi bi-arrow-repeat"></i> <span class="d-none d-md-inline">סנכרן</span>
               </button>
            </div>
         </div>
      </nav>
      <!-- תצוגת פריטים -->
      <div id="itemsView" class="active">
         <div class="container px-2 mt-2">
            <!-- חיפוש -->
            <div class="input-group mt-3 mb-2">
               <span class="input-group-text bg-white border-end-0 ps-3"><i class="bi bi-search text-muted"></i></span>
               <input type="text" id="searchInput" class="form-control border-start-0 py-2" placeholder="חפש מוצר, חברה, הערות..." onkeyup="filterItems()">
            </div>
            <!-- מיון וסינון מתקדם -->
            <div class="row g-2 mb-3">
               <div class="col-12 col-md-6 col-lg-3">
                  <label class="form-label small text-muted mb-1">מיון לפי:</label>
                  <select id="sortBy" class="form-select form-select-sm" onchange="filterItems()">
                     <option value="all">הכל (ללא מיון)</option>
                     <option value="name">שם מוצר (א-ב)</option>
                     <option value="name-desc">שם מוצר (ב-א)</option>
                     <option value="sold">נמכר הכי הרבה</option>
                     <option value="sold-desc">נמכר הכי פחות</option>
                     <option value="quantity">כמות במלאי (גבוה לנמוך)</option>
                     <option value="quantity-desc">כמות במלאי (נמוך לגבוה)</option>
                     <option value="price">מחיר (גבוה לנמוך)</option>
                     <option value="price-desc">מחיר (נמוך לגבוה)</option>
                     <option value="profit">רווח (גבוה לנמוך)</option>
                     <option value="profit-desc">רווח (נמוך לגבוה)</option>
                     <option value="value">ערך כולל (גבוה לנמוך)</option>
                     <option value="value-desc">ערך כולל (נמוך לגבוה)</option>
                  </select>
               </div>
               <div class="col-12 col-md-6 col-lg-3">
                  <label class="form-label small text-muted mb-1">סינון לפי מלאי:</label>
                  <select id="filterStock" class="form-select form-select-sm" onchange="filterItems()">
                     <option value="all">הכל</option>
                     <option value="in-stock">במלאי</option>
                     <option value="out-of-stock">אזל מהמלאי</option>
                     <option value="low-stock">מלאי נמוך (פחות מ-5)</option>
                     <option value="zero">אפס במלאי</option>
                  </select>
               </div>
               <div class="col-12 col-md-6 col-lg-3">
                  <label class="form-label small text-muted mb-1">סינון לפי תמונה:</label>
                  <select id="filterImage" class="form-select form-select-sm" onchange="filterItems()">
                     <option value="all">הכל</option>
                     <option value="with-image">עם תמונה</option>
                     <option value="no-image">ללא תמונה</option>
                  </select>
               </div>
               <div class="col-12 col-md-6 col-lg-3">
                  <label class="form-label small text-muted mb-1">סינון לפי קטגוריה:</label>
                  <select id="filterCategory" class="form-select form-select-sm" onchange="filterItems()">
                     <option value="all">כל הקטגוריות</option>
                  </select>
               </div>
            </div>
            <div id="contentArea" class="pb-3"></div>
         </div>
      </div>
      <!-- תצוגת רווחים ומלאי -->
      <div id="profitsView">
         <div class="container px-2 mt-2 pb-3">
            <div class="content-overlay">
               <div class="text-center mb-4">
                  <h5 class="fw-bold"><i class="bi bi-cash-coin me-2"></i>שליטה מלאה על רווחים ומלאי</h5>
               </div>
               <div class="row g-3 mb-3">
                  <div class="col-6">
                     <div class="kpi-card">
                        <h6><i class="bi bi-arrow-up-circle me-1"></i>סה"כ הכנסות</h6>
                        <div class="stat-value" id="totalRevenue">₪0</div>
                     </div>
                  </div>
                  <div class="col-6">
                     <div class="kpi-card">
                        <h6><i class="bi bi-arrow-down-circle me-1"></i>סה"כ הוצאות</h6>
                        <div class="stat-value" id="totalExpenses">₪0</div>
                     </div>
                  </div>
                  <div class="col-12">
                     <div class="kpi-card">
                        <h6><i class="bi bi-graph-up-arrow me-1"></i>רווח נקי</h6>
                        <div class="stat-value" id="netProfit">₪0</div>
                     </div>
                  </div>
               </div>
               <div class="stats-card">
                  <h6 class="fw-bold mb-3"><i class="bi bi-bar-chart me-2"></i>גרף רווחים</h6>
                  <canvas id="profitChart" style="max-height: 300px;"></canvas>
               </div>
            </div>
         </div>
      </div>
      <!-- תצוגת קטגוריות בסגנון SHEIN -->
      <div id="categoriesBrowseView">
         <div class="container-fluid px-0 mt-2" style="display: flex; height: calc(100vh - 65px);">
            <!-- Sidebar קטגוריות - צד שמאל -->
            <div class="categories-sidebar-shein" style="width: 250px; background: white; border-left: 1px solid #e0e0e0; overflow-y: auto; flex-shrink: 0;">
               <div style="padding: 20px 0;">
                  <h6 class="fw-bold mb-3 px-3" style="font-size: 1rem; color: #333;">קטגוריות</h6>
                  <div id="categoriesListMenu"></div>
               </div>
            </div>
            <!-- תוכן ראשי - צד ימין -->
            <div class="categories-content-shein" style="flex: 1; overflow-y: auto; padding: 20px;">
               <div class="content-overlay">
                  <h5 class="fw-bold mb-4" id="categoryMenuTitle">כל המוצרים</h5>
                  <div id="allProductsInMenu">
                     <div class="text-center text-muted py-5">
                        <i class="bi bi-folder display-1 opacity-25"></i>
                        <p class="mt-3">בחר קטגוריה משמאל כדי לראות את המוצרים</p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <!-- תצוגת ניהול מדורים -->
      <div id="categoriesView">
         <div class="container px-2 mt-2 pb-3">
            <div class="content-overlay">
               <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="fw-bold mb-0"><i class="bi bi-folder me-2"></i>נהל מדורים</h5>
                  <button class="btn btn-sm" style="background: #D4A574; color: white; border: none;" onclick="showAddCategoryModal()">
                  <i class="bi bi-plus-circle me-1"></i>הוסף מדור
                  </button>
               </div>
               <div id="categoriesList">
                  <div class="text-center text-muted py-5">
                     <i class="bi bi-folder display-1 opacity-25"></i>
                     <p class="mt-3">טוען מדורים...</p>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <!-- מודל הוספת מדור -->
      <div class="modal fade" id="categoryModal" tabindex="-1" data-bs-backdrop="static">
         <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
            <div class="modal-content">
               <div class="modal-header border-0 pb-0">
                  <h5 class="modal-title fw-bold" id="categoryModalTitle">הוסף מדור חדש</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
               </div>
               <div class="modal-body pt-2">
                  <form id="categoryForm">
                     <input type="hidden" id="oldCategoryName" value="">
                     <div class="mb-3">
                        <label class="form-label small text-muted mb-0">שם המדור</label>
                        <input type="text" class="form-control" id="categoryName" required placeholder="לדוגמה: מאכלים, אביזרים">
                     </div>
                  </form>
               </div>
               <div class="modal-footer border-0 pt-0">
                  <button type="button" class="btn btn-light w-100 mb-2" data-bs-dismiss="modal">ביטול</button>
                  <button type="button" class="btn btn-primary w-100" onclick="saveCategory()" style="background: #D4A574; border: none; color: white;">שמור</button>
               </div>
            </div>
         </div>
      </div>
      <!-- תצוגת היסטוריית מכירות -->
      <div id="salesHistoryView">
         <div class="container px-2 mt-2 pb-3">
            <div class="content-overlay">
               <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="fw-bold mb-0"><i class="bi bi-clock-history me-2"></i>היסטוריית מכירות</h5>
                  <div class="btn-group" role="group">
                     <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                     <i class="bi bi-download me-1"></i>ייצא לאקסל
                     </button>
                     <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="exportSalesHistoryToExcel('sales')">
                           <i class="bi bi-cart-check me-2"></i>הכנסות בלבד
                           </a>
                        </li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="exportSalesHistoryToExcel('purchases')">
                           <i class="bi bi-box-seam me-2"></i>הוצאות בלבד
                           </a>
                        </li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="exportSalesHistoryToExcel('all')">
                           <i class="bi bi-file-earmark-spreadsheet me-2"></i>הכל (מכירות + קניות)
                           </a>
                        </li>
                        <li>
                           <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="exportSalesHistoryToExcel('summary')">
                           <i class="bi bi-file-text me-2"></i>סיכום בלבד
                           </a>
                        </li>
                        <li>
                           <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="exportSalesHistoryToExcel('sales', 'מערכת מוכרים')">
                           <i class="bi bi-person-check me-2"></i>מערכת מוכרים בלבד
                           </a>
                        </li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="exportSalesHistoryToExcel('sales', 'דוא&amp;quot;ל')">
                           <i class="bi bi-envelope me-2"></i>דוא"ל בלבד
                           </a>
                        </li>
                     </ul>
                  </div>
               </div>
               <!-- אינדיקטור טעינה -->
               <div id="salesHistoryLoadingIndicator" class="alert alert-info d-none mb-3" style="background: linear-gradient(135deg, #D4A574, #B8956A); color: white; border: none;">
                  <div class="d-flex align-items-center justify-content-center">
                     <div class="spinner-border spinner-border-sm me-2" role="status" style="color: white;"></div>
                     <span class="fw-bold">טוען היסטוריה...</span>
                  </div>
               </div>
               <!-- סינון לפי יום/שבוע/חודש -->
               <div class="row g-2 mb-3">
                  <div class="col-12 col-md-4">
                     <label class="form-label small text-muted mb-1">סוג דו&amp;quot;ח</label>
                     <select class="form-control form-control-sm" id="salesHistoryPeriodType" onchange="updateSalesHistoryFilters()">
                        <option value="daily">יומי</option>
                        <option value="weekly">שבועי</option>
                        <option value="monthly">חודשי</option>
                     </select>
                  </div>
                  <div class="col-12 col-md-4" id="salesHistoryDateFilter">
                     <label class="form-label small text-muted mb-1">תאריך</label>
                     <input type="date" class="form-control form-control-sm" id="salesHistoryDate" onchange="loadSalesHistory()">
                  </div>
                  <div class="col-12 col-md-4" id="salesHistoryWeekFilter" style="display: none;">
                     <label class="form-label small text-muted mb-1">חודש</label>
                     <input type="month" class="form-control form-control-sm" id="salesHistoryMonth" onchange="updateSalesHistoryWeekSelector()">
                  </div>
                  <div class="col-12 col-md-4" id="salesHistoryWeekSelector" style="display: none;">
                     <label class="form-label small text-muted mb-1">שבוע</label>
                     <select class="form-control form-control-sm" id="salesHistoryWeek" onchange="loadSalesHistory()">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                     </select>
                  </div>
                  <div class="col-12 col-md-4" id="salesHistoryMonthFilter" style="display: none;">
                     <label class="form-label small text-muted mb-1">חודש</label>
                     <input type="month" class="form-control form-control-sm" id="salesHistoryMonthOnly" onchange="loadSalesHistory()">
                  </div>
               </div>
               <!-- טבלת היסטוריה -->
               <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                  <table class="table table-hover table-striped" style="background: white; border-radius: 8px;">
                     <thead style="position: sticky; top: 0; background: #D4A574; z-index: 10;">
                        <tr>
                           <th>תאריך</th>
                           <th>שעה</th>
                           <th>סוג</th>
                           <th>מוצר</th>
                           <th>קטגוריה</th>
                           <th>כמות</th>
                           <th>מחיר</th>
                           <th>סה"כ</th>
                           <th>מקור</th>
                        </tr>
                     </thead>
                     <tbody id="salesHistoryTableBody">
                        <tr>
                           <td colspan="9" class="text-center text-muted py-4">
                              <i class="bi bi-hourglass-split me-2"></i>טוען נתונים...
                           </td>
                        </tr>
                     </tbody>
                  </table>
               </div>
               <!-- סיכום -->
               <div class="row g-2 mt-3">
                  <div class="col-12 col-md-4">
                     <div class="kpi-card p-3">
                        <small class="text-muted d-block mb-1">סה"כ מכירות</small>
                        <div class="stat-value text-success" id="salesHistoryTotalSales">₪0</div>
                     </div>
                  </div>
                  <div class="col-12 col-md-4">
                     <div class="kpi-card p-3">
                        <small class="text-muted d-block mb-1">סה"כ קניות</small>
                        <div class="stat-value text-danger" id="salesHistoryTotalPurchases">₪0</div>
                     </div>
                  </div>
                  <div class="col-12 col-md-4">
                     <div class="kpi-card p-3">
                        <small class="text-muted d-block mb-1">רווח נטו</small>
                        <div class="stat-value" id="salesHistoryNetProfit">₪0</div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <!-- תצוגת סטטיסטיקות -->
      <div id="statsView">
         <div class="container px-2 mt-2 pb-3">
            <div class="content-overlay">
               <div class="text-center mb-4">
                  <h5 class="fw-bold"><i class="bi bi-bar-chart me-2"></i>דשבורד סטטיסטיקות</h5>
               </div>
               <!-- כרטיסי KPI -->
               <div class="row g-2 mb-3">
                  <div class="col-6 col-md-4">
                     <div class="kpi-card">
                        <h6><i class="bi bi-box-seam me-1"></i>סה"כ פריטים</h6>
                        <div class="stat-value" id="statTotalItems">0</div>
                     </div>
                  </div>
                  <div class="col-6 col-md-4">
                     <div class="kpi-card">
                        <h6><i class="bi bi-stack me-1"></i>סה"כ כמות</h6>
                        <div class="stat-value" id="statTotalQuantity">0</div>
                     </div>
                  </div>
                  <div class="col-6 col-md-4">
                     <div class="kpi-card">
                        <h6><i class="bi bi-currency-shekel me-1"></i>סה"כ ערך מלאי</h6>
                        <div class="stat-value" id="statTotalValue">₪0</div>
                     </div>
                  </div>
                  <div class="col-6 col-md-4">
                     <div class="kpi-card">
                        <h6><i class="bi bi-exclamation-triangle me-1"></i>מלאי נמוך</h6>
                        <div class="stat-value" id="statLowStock">0</div>
                     </div>
                  </div>
                  <div class="col-6 col-md-4">
                     <div class="kpi-card">
                        <h6><i class="bi bi-cart-check me-1 text-success"></i>סה"כ נמכר</h6>
                        <div class="stat-value text-success" id="statTotalSold">0</div>
                     </div>
                  </div>
                  <div class="col-6 col-md-4">
                     <div class="kpi-card">
                        <h6><i class="bi bi-percent me-1 text-info"></i>אחוז מלאי</h6>
                        <div class="stat-value text-info" id="statStockPercentage">0%</div>
                     </div>
                  </div>
                  <div class="col-6 col-md-4">
                     <div class="kpi-card">
                        <h6><i class="bi bi-grid-3x3 me-1 text-warning"></i>קטגוריות</h6>
                        <div class="stat-value text-warning" id="statTotalCategories">0</div>
                     </div>
                  </div>
                  <div class="col-6 col-md-4">
                     <div class="kpi-card">
                        <h6><i class="bi bi-calculator me-1"></i>ממוצע מחיר</h6>
                        <div class="stat-value" id="statAveragePrice">₪0</div>
                     </div>
                  </div>
                  <div class="col-6 col-md-4">
                     <div class="kpi-card">
                        <h6><i class="bi bi-star me-1 text-primary"></i>המוצר המוביל</h6>
                        <div class="stat-value text-primary" style="font-size: 1rem;" id="statTopProduct">-</div>
                     </div>
                  </div>
               </div>
               <!-- סטטיסטיקות לפי קטגוריות -->
               <div class="stats-card mb-3">
                  <h6 class="fw-bold mb-3"><i class="bi bi-pie-chart me-2"></i>פילוח לפי קטגוריות</h6>
                  <div id="categoryBreakdown" class="table-responsive">
                     <table class="table table-sm table-hover">
                        <thead class="table-light">
                           <tr>
                              <th>קטגוריה</th>
                              <th class="text-center">פריטים</th>
                              <th class="text-center">כמות</th>
                              <th class="text-end">ערך (₪)</th>
                           </tr>
                        </thead>
                        <tbody id="categoryBreakdownBody">
                           <tr>
                              <td colspan="4" class="text-center text-muted">טוען...</td>
                           </tr>
                        </tbody>
                     </table>
                  </div>
               </div>
               <!-- גרף פריטים עם כמות גבוהה -->
               <div class="stats-card mb-3">
                  <h6 class="fw-bold mb-3"><i class="bi bi-bar-chart me-2"></i>פריטים עם הכמות הגבוהה ביותר</h6>
                  <canvas id="quantityChart" style="max-height: 300px;"></canvas>
               </div>
               <!-- גרף פריטים לפי ערך -->
               <div class="stats-card mb-3">
                  <h6 class="fw-bold mb-3"><i class="bi bi-currency-shekel me-2"></i>פריטים לפי ערך כולל</h6>
                  <canvas id="valueChart" style="max-height: 300px;"></canvas>
               </div>
               <!-- כל המוצרים - Carousel (מוסתר בהתחלה) -->
               <div class="stats-card mb-3" id="allProductsSection" style="display: none;">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                     <h6 class="fw-bold mb-0"><i class="bi bi-grid me-2"></i>כל המוצרים (<span id="allProductsCount">0</span>)</h6>
                     <button class="btn btn-sm btn-secondary" onclick="hideAllProducts()">
                     <i class="bi bi-arrow-up-circle me-1"></i>הסתר
                     </button>
                  </div>
                  <div id="allProductsCarousel" class="products-carousel-container">
                     <button class="carousel-nav-btn carousel-prev" onclick="scrollAllProductsCarousel('prev')">
                     <i class="bi bi-chevron-right"></i>
                     </button>
                     <div class="products-carousel" id="allProductsList">
                        <!-- יטען כאן -->
                     </div>
                     <button class="carousel-nav-btn carousel-next" onclick="scrollAllProductsCarousel('next')">
                     <i class="bi bi-chevron-left"></i>
                     </button>
                  </div>
               </div>
               <!-- רשימת פריטים שצריך להזמין -->
               <div class="stats-card mb-3">
                  <h6 class="fw-bold mb-3"><i class="bi bi-cart-plus me-2"></i>פריטים שצריך להזמין (מלאי נמוך)</h6>
                  <div id="lowStockList">
                     <div class="text-center text-muted py-3">
                        <i class="bi bi-check-circle fs-1 opacity-25"></i>
                        <p class="mt-2">אין פריטים עם מלאי נמוך</p>
                     </div>
                  </div>
               </div>
               <!-- רשימת מוצרים שחסרים לגמרי -->
               <div class="stats-card">
                  <h6 class="fw-bold mb-3"><i class="bi bi-x-circle-fill me-2" style="color: #dc3545;"></i>מוצרים שחסרים לגמרי (<span id="outOfStockCount">0</span>)</h6>
                  <div id="outOfStockList">
                     <div class="text-center text-muted py-3">
                        <i class="bi bi-check-circle fs-1 opacity-25"></i>
                        <p class="mt-2">אין מוצרים חסרים</p>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <button class="fab-btn" onclick="openModal('add')">
      <i class="bi bi-plus-lg"></i>
      </button>
      <!-- מציג תמונות (Lightbox) -->
      <div id="imageViewer" style="display: none;" onclick="closeImageViewer(event)">
         <span class="close-viewer-btn">&times;</span>
         <img id="fullImage" src="" onclick="toggleZoom(event)">
         <div id="viewerHint" class="viewer-hint">לחץ להגדלה</div>
      </div>
      <!-- מודל עריכה/הוספה -->
      <div class="modal fade" id="itemModal" tabindex="-1" data-bs-backdrop="static">
         <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
            <div class="modal-content">
               <div class="modal-header border-0 pb-0">
                  <h5 class="modal-title fw-bold" id="modalTitle">פרטי מוצר</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
               </div>
               <div class="modal-body pt-2">
                  <form id="itemForm">
                     <input type="hidden" id="itemRowIndex">
                     <div class="mb-3">
                        <label for="itemImageInput" class="image-upload-label shadow-sm" id="imagePreviewContainer" style="background-color: #ffffff;">
                        <i class="bi bi-camera-fill"></i>
                        </label>
                        <input type="file" id="itemImageInput" class="d-none" accept="image/*" capture="environment" onchange="handleImageSelect(this)">
                        <div class="text-center mt-1">
                           <small class="text-muted">לחץ לצילום/העלאה או ערוך תמונה קיימת</small>
                           <div id="editImageButtonContainer" style="display: none; margin-top: 8px;">
                              <button type="button" class="btn btn-sm btn-outline-primary" onclick="editCurrentImage()">
                              <i class="bi bi-pencil me-1"></i>ערוך תמונה
                              </button>
                           </div>
                        </div>
                     </div>
                     <div class="row g-2 mb-2">
                        <div class="col-8">
                           <label class="form-label small text-muted mb-0">שם המוצר</label>
                           <input type="text" class="form-control" id="itemName" required>
                        </div>
                        <div class="col-4">
                           <label class="form-label small text-muted mb-0">כמות במלאי</label>
                           <input type="number" class="form-control" id="itemQuantity" required min="0">
                        </div>
                     </div>
                     <div class="row g-2 mb-2">
                        <div class="col-12">
                           <label class="form-label small text-muted mb-0">קטגוריה</label>
                           <div class="input-group">
                              <select class="form-control" id="itemCategory" required>
                                 <option value="">טוען קטגוריות...</option>
                              </select>
                              <button type="button" class="btn btn-outline-secondary" onclick="showAddCategoryInput()" title="הוסף קטגוריה חדשה">
                              <i class="bi bi-plus-lg"></i>
                              </button>
                           </div>
                           <div id="newCategoryInput" class="mt-2" style="display: none;">
                              <input type="text" class="form-control" id="newCategoryName" placeholder="שם קטגוריה חדשה">
                              <button type="button" class="btn btn-sm btn-primary mt-1 w-100" onclick="addNewCategory()" style="background: #D4A574; border: none; color: white;">הוסף קטגוריה</button>
                           </div>
                        </div>
                     </div>
                     <div class="row g-2 mb-2">
                        <div class="col-6">
                           <label class="form-label small text-muted mb-0">מותג / חברה</label>
                           <input type="text" class="form-control" id="itemCompany" placeholder="לדוגמה: Zara">
                        </div>
                        <div class="col-6">
                           <label class="form-label small text-muted mb-0">מחיר מכירה (₪)</label>
                           <input type="number" class="form-control" id="itemPrice" placeholder="0" min="0" step="0.01">
                           <small class="text-muted">מחיר למכירה</small>
                        </div>
                     </div>
                     <div class="row g-2 mb-2">
                        <div class="col-6">
                           <label class="form-label small text-muted mb-0">מחיר קנייה מהספק (₪)</label>
                           <input type="number" class="form-control" id="itemPurchasePrice" placeholder="0" min="0" step="0.01">
                           <small class="text-muted">כמה שילמת עבור המוצר</small>
                        </div>
                        <div class="col-6">
                           <label class="form-label small text-muted mb-0">מידה</label>
                           <input type="text" class="form-control" id="itemSize" placeholder="לדוגמה: S, M, L, XL">
                           <small class="text-muted">מידה (אופציונלי)</small>
                        </div>
                     </div>
                     <input type="hidden" id="itemStatus" value="0">
                     <div class="mb-3">
                        <label class="form-label small text-muted mb-0">מיקום / הערות</label>
                        <textarea class="form-control" id="itemNotes" rows="2"></textarea>
                     </div>
                  </form>
               </div>
               <div class="modal-footer border-0 pt-0">
                  <div id="deleteItemButtonContainer" style="display: none;">
                     <button type="button" class="btn btn-danger w-100 mb-2" onclick="deleteItemFromModal()" style="border: none;">
                     <i class="bi bi-trash me-1"></i>מחק מוצר
                     </button>
                  </div>
                  <button type="button" class="btn btn-light w-100 mb-2" data-bs-dismiss="modal">ביטול</button>
                  <div id="updateButtonContainer" style="display: none;" class="w-100 mb-2">
                     <button type="button" class="btn btn-success w-100" onclick="updateItemOnlyChanges()" style="border: none;">
                     <i class="bi bi-pencil-square me-1"></i>עדכן רק שינויים
                     </button>
                  </div>
                  <button type="button" class="btn btn-primary w-100" onclick="submitItem()" style="background: #D4A574; border: none; color: white;">שמור</button>
               </div>
            </div>
         </div>
      </div>
      <!-- מודל עריכת תמונה -->
      <div class="modal fade" id="imageEditorModal" tabindex="-1" data-bs-backdrop="static">
         <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
               <div class="modal-header border-0 pb-0">
                  <h5 class="modal-title fw-bold">עריכת תמונה</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="cancelImageEdit()"></button>
               </div>
               <div class="modal-body pt-2">
                  <div class="mb-3">
                     <div class="image-editor-container" style="max-width: 100%; margin: 0 auto;">
                        <img id="imageToEdit" style="max-width: 100%; display: block;">
                     </div>
                  </div>
                  <div class="d-flex gap-2 justify-content-center flex-wrap mb-3">
                     <button type="button" class="btn btn-sm btn-outline-secondary" onclick="rotateImage(90)">
                     <i class="bi bi-arrow-clockwise"></i> סיבוב ימינה
                     </button>
                     <button type="button" class="btn btn-sm btn-outline-secondary" onclick="rotateImage(-90)">
                     <i class="bi bi-arrow-counterclockwise"></i> סיבוב שמאלה
                     </button>
                     <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetImage()">
                     <i class="bi bi-arrow-counterclockwise"></i> איפוס
                     </button>
                  </div>
                  <div class="alert alert-info small mb-0">
                     <i class="bi bi-info-circle me-1"></i>
                     גרור את הפינות כדי לחתוך את התמונה. לחץ על "שמור" כדי לאשר.
                  </div>
               </div>
               <div class="modal-footer border-0 pt-0">
                  <button type="button" class="btn btn-light" onclick="cancelImageEdit()">ביטול</button>
                  <button type="button" class="btn btn-primary" onclick="saveEditedImage()" style="background: #D4A574; border: none; color: white;">
                  <i class="bi bi-check-lg me-1"></i>שמור תמונה
                  </button>
               </div>
            </div>
         </div>
      </div>
      <!-- Footer -->
      <footer class="app-footer">
         <div class="footer-content">
            <div class="footer-text">
               נבנה ע״י S.C. פיתוח תוכנות ואתרים 2025 כל הזכיות שמורות
            </div>
         </div>
      </footer>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
      <script>
         let currentSheet = '';
         let allData = [];
         let itemModal;
         let currentImageBase64 = null;
         let imageEditor = null;
         let imageEditorModal = null;
         let originalImageForEdit = null;
         let currentView = 'items';
         let quantityChart = null;
         let valueChart = null;
         let profitChart = null;
         let categoryModal = null;
         
         // Cache מהיר עם timestamps
         const dataCache = {
           items: null,
           timestamp: null,
           category: null,
           cacheTimeout: 30000, // 30 שניות
           statistics: null,
           statisticsTimestamp: null,
           profits: null,
           profitsTimestamp: null
         };
         
         function invalidateCache(key) {
           if (key === 'all') {
             dataCache.items = null;
             dataCache.timestamp = null;
             dataCache.statistics = null;
             dataCache.statisticsTimestamp = null;
             dataCache.profits = null;
             dataCache.profitsTimestamp = null;
           } else {
             dataCache[key] = null;
           }
         }
         
         const statusLabels = ["לא ידוע", "חדש", "משומש", "תקול"];
         
         function switchView(view, event) {
           if (event) {
             event.preventDefault();
             event.stopPropagation();
           }
           
           currentView = view;
           
           // עדכון תפריט ניווט - הסרת active מכל הכפתורים
           document.querySelectorAll('.main-nav-menu .nav-link').forEach(link => {
             link.classList.remove('active');
           });
           
           // הסתרת כל התצוגות כולל תצוגת הקטגוריות
           const views = ['itemsView', 'statsView', 'profitsView', 'salesHistoryView', 'categoriesView', 'categoriesBrowseView'];
           views.forEach(viewId => {
             const element = document.getElementById(viewId);
             if (element) {
               element.classList.remove('active');
             }
           });
           
           // הצגת התצוגה הנכונה
           if (view === 'items') {
             const itemsView = document.getElementById('itemsView');
             const navItems = document.getElementById('navItems');
             if (itemsView) {
               itemsView.classList.add('active');
               // איפוס הקטגוריה כדי לטעון את כל המוצרים כשעוברים ל"ניהול התוכן"
               currentSheet = '';
               loadData();
             }
             if (navItems) navItems.classList.add('active');
           } else if (view === 'stats') {
             const statsView = document.getElementById('statsView');
             const navStats = document.getElementById('navStats');
             if (statsView) {
               statsView.classList.add('active');
               loadStatistics();
             }
             if (navStats) navStats.classList.add('active');
           } else if (view === 'profits') {
             const profitsView = document.getElementById('profitsView');
             const navProfits = document.getElementById('navProfits');
             if (profitsView) {
               profitsView.classList.add('active');
               loadProfits();
             }
             if (navProfits) navProfits.classList.add('active');
           } else if (view === 'salesHistory') {
             const salesHistoryView = document.getElementById('salesHistoryView');
             const navSalesHistory = document.getElementById('navSalesHistory');
             if (salesHistoryView) {
               salesHistoryView.classList.add('active');
               // טעינת היסטוריה בפתיחה
               const now = new Date();
               const dateStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
               const dateInput = document.getElementById('salesHistoryDate');
               if (dateInput) {
                 dateInput.value = dateStr;
               }
               // טעינת ההיסטוריה
               loadSalesHistory();
             }
             if (navSalesHistory) navSalesHistory.classList.add('active');
           } else if (view === 'categoriesBrowse') {
             const categoriesBrowseView = document.getElementById('categoriesBrowseView');
             const navCategoriesMenu = document.getElementById('navCategoriesMenu');
             if (categoriesBrowseView) {
               categoriesBrowseView.classList.add('active');
               loadCategoriesMenu();
             }
             if (navCategoriesMenu) navCategoriesMenu.classList.add('active');
           } else if (view === 'categories') {
             const categoriesView = document.getElementById('categoriesView');
             const navCategories = document.getElementById('navCategories');
             if (categoriesView) {
               categoriesView.classList.add('active');
               loadCategories();
             }
             if (navCategories) navCategories.classList.add('active');
           }
           
           return false;
         }
         
         function loadProfits() {
           // בדיקת cache מהיר
           const now = Date.now();
           if (dataCache.profits && dataCache.profitsTimestamp && 
               (now - dataCache.profitsTimestamp) < 60000) { // 60 שניות cache לרווחים
             const profits = dataCache.profits;
             document.getElementById('totalRevenue').innerText = formatPrice(profits.totalRevenue);
             document.getElementById('totalExpenses').innerText = formatPrice(profits.totalExpenses);
             document.getElementById('netProfit').innerText = formatPrice(profits.netProfit);
             if (profitChart) profitChart.destroy();
             const ctx = document.getElementById('profitChart').getContext('2d');
             profitChart = new Chart(ctx, {
               type: 'bar',
               data: {
                 labels: profits.itemsSold.map(item => item.name),
                 datasets: [{
                   label: 'רווח (₪)',
                   data: profits.itemsSold.map(item => item.profit),
                   backgroundColor: 'rgba(212, 165, 116, 0.8)',
                   borderColor: '#8d6e63',
                   borderWidth: 1
                 }]
               },
               options: {
                 responsive: true,
                 maintainAspectRatio: false,
                 plugins: { legend: { display: false } },
                 scales: { y: { beginAtZero: true } }
               }
             });
             return;
           }
           
           // הוספת timeout למניעת תקיעות
           let timeoutId = setTimeout(function() {
             const profitsContent = profitsView ? profitsView.querySelector('.content-overlay') : null;
             if (profitsContent && profitsContent.querySelector('.spinner-border')) {
               profitsContent.innerHTML = '<div class="alert alert-warning">הטעינה לוקחת זמן רב. נסה לרענן את הדף (F5) או לנסות שוב.</div>';
             }
           }, 30000); // 30 שניות
           
           google.script.run
             .withSuccessHandler(function(profits) {
               clearTimeout(timeoutId);
               // שמירה ב-cache עם timestamp
               dataCache.profits = profits;
               dataCache.profitsTimestamp = Date.now();
               document.getElementById('totalRevenue').innerText = formatPrice(profits.totalRevenue);
               document.getElementById('totalExpenses').innerText = formatPrice(profits.totalExpenses);
               document.getElementById('netProfit').innerText = formatPrice(profits.netProfit);
               if (profitChart) profitChart.destroy();
               const ctx = document.getElementById('profitChart').getContext('2d');
               profitChart = new Chart(ctx, {
                 type: 'bar',
                 data: {
                   labels: profits.itemsSold.map(item => item.name),
                   datasets: [{
                     label: 'רווח (₪)',
                     data: profits.itemsSold.map(item => item.profit),
                     backgroundColor: 'rgba(212, 165, 116, 0.8)',
                     borderColor: '#8d6e63',
                     borderWidth: 1
                   }]
                 },
                 options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   plugins: { legend: { display: false } },
                   scales: { y: { beginAtZero: true } }
                 }
               });
             })
             .withFailureHandler(function(error) {
               clearTimeout(timeoutId);
               const profitsView = document.getElementById('profitsView');
               if (profitsView) {
                 const profitsContent = profitsView.querySelector('.content-overlay');
                 if (profitsContent) {
                   profitsContent.innerHTML = '<div class="alert alert-danger mt-3">שגיאה בטעינת הנתונים: ' + (error.message || 'נסה לרענן את הדף') + '</div>';
                 }
               }
             })
             .getProfits();
         }
         
         // פונקציות להיסטוריית מכירות - מדור חדש
         let dailyChart = null;
         let weeklyChart = null;
         let monthlyChart = null;
         
         // משתנים לטבלת היסטוריית מכירות
         let currentSalesHistoryPeriod = 'daily';
         let currentSalesHistoryData = null;
         
         // טעינת חישובים יומיים
         function loadDailyCalculations() {
           const dateInput = document.getElementById('dailyCalcDate');
           if (!dateInput) return;
           if (!dateInput.value) {
             // אם אין בחירה, נקבע את היום הנוכחי
             const now = new Date();
             dateInput.value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
           }
           const date = dateInput.value;
           
           // הצגת אינדיקטור טעינה
           const loadingIndicator = document.getElementById('calculationsLoadingIndicator');
           if (loadingIndicator) {
             loadingIndicator.classList.remove('d-none');
             loadingIndicator.querySelector('span').textContent = 'טוען חישוב יומי...';
           }
           
           google.script.run
             .withSuccessHandler(function(data) {
               // הסתרת אינדיקטור טעינה
               if (loadingIndicator) {
                 loadingIndicator.classList.add('d-none');
               }
               
               document.getElementById('dailyPurchases').textContent = formatPrice(data.totalPurchases || 0);
               document.getElementById('dailyProfitFromSales').textContent = formatPrice(data.totalProfitFromSales || 0);
               document.getElementById('dailyNetProfit').textContent = formatPrice(data.netProfit || 0);
               window.dailyCalculationsData = data;
               
               // עדכון הטבלה המפורטת אם נבחר דו"ח יומי
               const reportType = document.querySelector('input[name="reportType"]:checked');
               if (reportType && reportType.value === 'daily') {
                 if (data.allHistory) {
                   displaySalesHistory(data.allHistory);
                   updateSalesHistorySummary({
                     totalSales: data.totalProfitFromSales || 0,
                     totalPurchases: data.totalPurchases || 0,
                     netProfit: data.netProfit || 0
                   });
                 }
               }
               
               // ציור גרף יומי
               drawDailyChart(data, date);
             })
             .withFailureHandler(function(error) {
               // הסתרת אינדיקטור טעינה
               const loadingIndicator = document.getElementById('calculationsLoadingIndicator');
               if (loadingIndicator) {
                 loadingIndicator.classList.add('d-none');
               }
               
               console.error('שגיאה בטעינת חישובים יומיים:', error);
               Swal.fire({
                 icon: 'error',
                 title: 'שגיאה',
                 text: error.message || 'שגיאה בטעינת חישובים יומיים',
                 confirmButtonColor: '#D4A574'
               });
               
               // נסה לבדוק מה קורה
           google.script.run
                 .withSuccessHandler(function(debugInfo) {
                   console.log('Debug info:', debugInfo);
                   if (debugInfo && !debugInfo.success) {
                     Swal.fire({
                       icon: 'warning',
                       title: 'בעיה בזיהוי נתונים',
                       text: 'לא נמצאו נתונים עבור התאריך המבוקש. אנא בדוק את הלוגים ב-Apps Script.',
                       confirmButtonColor: '#D4A574'
                     });
                   }
                 })
                 .withFailureHandler(function() {})
                 .debugSalesHistory(date);
               
               document.getElementById('dailyPurchases').textContent = '₪0';
               document.getElementById('dailyProfitFromSales').textContent = '₪0';
               document.getElementById('dailyNetProfit').textContent = '₪0';
             })
             .getDailyCalculations(date);
         }
         
         // ציור גרף יומי
         function drawDailyChart(data, date) {
           const ctx = document.getElementById('dailyChart');
           if (!ctx) return;
           
           if (dailyChart) {
             dailyChart.destroy();
           }
           
           dailyChart = new Chart(ctx, {
             type: 'bar',
             data: {
               labels: ['הוצאות לקניות', 'הכנסות מרווח', 'רווח נטו'],
               datasets: [{
                 label: 'סכום (₪)',
                 data: [
                   data.totalPurchases || 0,
                   data.totalProfitFromSales || 0,
                   data.netProfit || 0
                 ],
                 backgroundColor: [
                   'rgba(220, 53, 69, 0.7)', // אדום להוצאות
                   'rgba(40, 167, 69, 0.7)', // ירוק להכנסות
                   'rgba(212, 165, 116, 0.7)' // חום לרווח נטו
                 ],
                 borderColor: [
                   'rgba(220, 53, 69, 1)',
                   'rgba(40, 167, 69, 1)',
                   'rgba(212, 165, 116, 1)'
                 ],
                 borderWidth: 2
               }]
             },
             options: {
               responsive: true,
               maintainAspectRatio: false,
               plugins: {
                 legend: {
                   display: false
                 },
                 title: {
                   display: true,
                   text: 'חישוב יומי - ' + date,
                   font: {
                     size: 14,
                     weight: 'bold'
                   }
                 }
               },
               scales: {
                 y: {
                   beginAtZero: true,
                   ticks: {
                     callback: function(value) {
                       return '₪' + value.toFixed(0);
                     }
                   }
                 }
               }
             }
           });
         }
         
         // עדכון בחירת שבוע לפי החודש
         function updateWeeklyWeekSelector() {
           const monthInput = document.getElementById('weeklyCalcMonth');
           const weekSelect = document.getElementById('weeklyCalcWeek');
           if (!monthInput || !monthInput.value) {
             const now = new Date();
             monthInput.value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
           }
           loadWeeklyCalculations();
         }
         
         // טעינת חישובים שבועיים
         function loadWeeklyCalculations() {
           const monthInput = document.getElementById('weeklyCalcMonth');
           const weekSelect = document.getElementById('weeklyCalcWeek');
           if (!monthInput) return;
           if (!monthInput.value) {
             const now = new Date();
             monthInput.value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
           }
           const [year, month] = monthInput.value.split('-').map(Number);
           const week = parseInt(weekSelect ? weekSelect.value : 1) || 1;
           
           // הצגת אינדיקטור טעינה
           const loadingIndicator = document.getElementById('calculationsLoadingIndicator');
           if (loadingIndicator) {
             loadingIndicator.classList.remove('d-none');
             loadingIndicator.querySelector('span').textContent = 'טוען חישוב שבועי...';
           }
           
           google.script.run
             .withSuccessHandler(function(data) {
               // הסתרת אינדיקטור טעינה
               if (loadingIndicator) {
                 loadingIndicator.classList.add('d-none');
               }
               
               document.getElementById('weeklyPurchases').textContent = formatPrice(data.totalPurchases || 0);
               document.getElementById('weeklyProfitFromSales').textContent = formatPrice(data.totalProfitFromSales || 0);
               document.getElementById('weeklyNetProfit').textContent = formatPrice(data.netProfit || 0);
               window.weeklyCalculationsData = data;
               
               // עדכון הטבלה המפורטת אם נבחר דו"ח שבועי
               const reportType = document.querySelector('input[name="reportType"]:checked');
               if (reportType && reportType.value === 'weekly') {
                 if (data.allHistory) {
                   displaySalesHistory(data.allHistory);
                   updateSalesHistorySummary({
                     totalSales: data.totalProfitFromSales || 0,
                     totalPurchases: data.totalPurchases || 0,
                     netProfit: data.netProfit || 0
                   });
                 }
               }
               
               // ציור גרף שבועי
               drawWeeklyChart(data, year, month, week);
             })
             .withFailureHandler(function(error) {
               // הסתרת אינדיקטור טעינה
               const loadingIndicator = document.getElementById('calculationsLoadingIndicator');
               if (loadingIndicator) {
                 loadingIndicator.classList.add('d-none');
               }
               
               Swal.fire('שגיאה', error.message || 'שגיאה בטעינת חישובים שבועיים', 'error');
               document.getElementById('weeklyPurchases').textContent = '₪0';
               document.getElementById('weeklyProfitFromSales').textContent = '₪0';
               document.getElementById('weeklyNetProfit').textContent = '₪0';
             })
             .getWeeklyCalculations(year, month, week);
         }
         
         // ציור גרף שבועי
         function drawWeeklyChart(data, year, month, week) {
           const ctx = document.getElementById('weeklyChart');
           if (!ctx) return;
           
           if (weeklyChart) {
             weeklyChart.destroy();
           }
           
           const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
           const monthName = monthNames[month - 1] || month;
           
           weeklyChart = new Chart(ctx, {
             type: 'bar',
             data: {
               labels: ['הוצאות לקניות', 'הכנסות מרווח', 'רווח נטו'],
               datasets: [{
                 label: 'סכום (₪)',
                 data: [
                   data.totalPurchases || 0,
                   data.totalProfitFromSales || 0,
                   data.netProfit || 0
                 ],
                 backgroundColor: [
                   'rgba(220, 53, 69, 0.7)', // אדום להוצאות
                   'rgba(40, 167, 69, 0.7)', // ירוק להכנסות
                   'rgba(212, 165, 116, 0.7)' // חום לרווח נטו
                 ],
                 borderColor: [
                   'rgba(220, 53, 69, 1)',
                   'rgba(40, 167, 69, 1)',
                   'rgba(212, 165, 116, 1)'
                 ],
                 borderWidth: 2
               }]
             },
             options: {
               responsive: true,
               maintainAspectRatio: false,
               plugins: {
                 legend: {
                   display: false
                 },
                 title: {
                   display: true,
                   text: 'חישוב שבועי - ' + monthName + ' ' + year + ', שבוע ' + week,
                   font: {
                     size: 14,
                     weight: 'bold'
                   }
                 }
               },
               scales: {
                 y: {
                   beginAtZero: true,
                   ticks: {
                     callback: function(value) {
                       return '₪' + value.toFixed(0);
                     }
                   }
                 }
               }
             }
           });
         }
         
         // טעינת חישובים חודשיים
         function loadMonthlyCalculations() {
           const monthInput = document.getElementById('monthlyCalcMonth');
           if (!monthInput) return;
           if (!monthInput.value) {
             // אם אין בחירה, נקבע את החודש הנוכחי
             const now = new Date();
             monthInput.value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
           }
           const [year, month] = monthInput.value.split('-').map(Number);
           
           // הצגת אינדיקטור טעינה
           const loadingIndicator = document.getElementById('calculationsLoadingIndicator');
           if (loadingIndicator) {
             loadingIndicator.classList.remove('d-none');
             loadingIndicator.querySelector('span').textContent = 'טוען חישוב חודשי...';
           }
           
           google.script.run
             .withSuccessHandler(function(data) {
               // הסתרת אינדיקטור טעינה
               if (loadingIndicator) {
                 loadingIndicator.classList.add('d-none');
               }
               
               document.getElementById('monthlyPurchases').textContent = formatPrice(data.totalPurchases || 0);
               document.getElementById('monthlyProfitFromSales').textContent = formatPrice(data.totalProfitFromSales || 0);
               document.getElementById('monthlyNetProfit').textContent = formatPrice(data.netProfit || 0);
               window.monthlyCalculationsData = data;
               
               // עדכון הטבלה המפורטת אם נבחר דו"ח חודשי
               const reportType = document.querySelector('input[name="reportType"]:checked');
               if (reportType && reportType.value === 'monthly') {
                 if (data.allHistory) {
                   displaySalesHistory(data.allHistory);
                   updateSalesHistorySummary({
                     totalSales: data.totalProfitFromSales || 0,
                     totalPurchases: data.totalPurchases || 0,
                     netProfit: data.netProfit || 0
                   });
                 }
               }
               
               // ציור גרף חודשי
               drawMonthlyChart(data, year, month);
             })
             .withFailureHandler(function(error) {
               // הסתרת אינדיקטור טעינה
               const loadingIndicator = document.getElementById('calculationsLoadingIndicator');
               if (loadingIndicator) {
                 loadingIndicator.classList.add('d-none');
               }
               
               Swal.fire('שגיאה', error.message || 'שגיאה בטעינת חישובים חודשיים', 'error');
               document.getElementById('monthlyPurchases').textContent = '₪0';
               document.getElementById('monthlyProfitFromSales').textContent = '₪0';
               document.getElementById('monthlyNetProfit').textContent = '₪0';
             })
             .getMonthlyCalculations(year, month);
         }
         
         // ציור גרף חודשי
         function drawMonthlyChart(data, year, month) {
           const ctx = document.getElementById('monthlyChart');
           if (!ctx) return;
           
           if (monthlyChart) {
             monthlyChart.destroy();
           }
           
           const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
           const monthName = monthNames[month - 1] || month;
           
           monthlyChart = new Chart(ctx, {
             type: 'bar',
             data: {
               labels: ['הוצאות לקניות', 'הכנסות מרווח', 'רווח נטו'],
               datasets: [{
                 label: 'סכום (₪)',
                 data: [
                   data.totalPurchases || 0,
                   data.totalProfitFromSales || 0,
                   data.netProfit || 0
                 ],
                 backgroundColor: [
                   'rgba(220, 53, 69, 0.7)', // אדום להוצאות
                   'rgba(40, 167, 69, 0.7)', // ירוק להכנסות
                   'rgba(212, 165, 116, 0.7)' // חום לרווח נטו
                 ],
                 borderColor: [
                   'rgba(220, 53, 69, 1)',
                   'rgba(40, 167, 69, 1)',
                   'rgba(212, 165, 116, 1)'
                 ],
                 borderWidth: 2
               }]
             },
             options: {
               responsive: true,
               maintainAspectRatio: false,
               plugins: {
                 legend: {
                   display: false
                 },
                 title: {
                   display: true,
                   text: 'חישוב חודשי - ' + monthName + ' ' + year,
                   font: {
                     size: 14,
                     weight: 'bold'
                   }
                 }
               },
               scales: {
                 y: {
                   beginAtZero: true,
                   ticks: {
                     callback: function(value) {
                       return '₪' + value.toFixed(0);
                     }
                   }
                 }
               }
             }
           });
         }
         
         // טעינת דו"ח מפורט לפי הסוג שנבחר
         function loadDetailedReport() {
           const reportType = document.querySelector('input[name="reportType"]:checked');
           if (!reportType) return;
           
           // טעינת הטבלה המפורטת לפי הסוג שנבחר
           const type = reportType.value;
           const tableBody = document.getElementById('salesHistoryTableBody');
           if (tableBody) {
             tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="bi bi-hourglass-split me-2"></i>טוען נתונים...</td></tr>';
           }
         
           if (type === 'daily') {
             const dateInput = document.getElementById('dailyCalcDate');
             if (!dateInput || !dateInput.value) {
               if (tableBody) {
                 tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="bi bi-calendar-day me-2"></i>נא לבחור תאריך</td></tr>';
               }
               return;
             }
             const date = dateInput.value;
             
             // נשתמש בנתונים שכבר נטענו אם יש
             if (window.dailyCalculationsData && window.dailyCalculationsData.allHistory) {
               displaySalesHistory(window.dailyCalculationsData.allHistory);
               updateSalesHistorySummary({
                 totalSales: window.dailyCalculationsData.totalProfitFromSales || 0,
                 totalPurchases: window.dailyCalculationsData.totalPurchases || 0,
                 netProfit: window.dailyCalculationsData.netProfit || 0
               });
             } else {
             google.script.run
               .withSuccessHandler(function(data) {
                   if (data && data.allHistory) {
                     displaySalesHistory(data.allHistory);
                     updateSalesHistorySummary({
                       totalSales: data.totalProfitFromSales || 0,
                       totalPurchases: data.totalPurchases || 0,
                       netProfit: data.netProfit || 0
                     });
                   } else {
                     if (tableBody) {
                       tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="bi bi-inbox me-2"></i>אין נתונים להצגה</td></tr>';
                     }
                   }
               })
               .withFailureHandler(function(error) {
                   console.error('שגיאה בטעינת דו"ח יומי:', error);
                   if (tableBody) {
                     tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger py-4">שגיאה בטעינת נתונים</td></tr>';
                   }
                 })
                 .getDailyCalculations(date);
             }
           } else if (type === 'weekly') {
             const monthInput = document.getElementById('weeklyCalcMonth');
             const weekSelect = document.getElementById('weeklyCalcWeek');
             if (!monthInput || !monthInput.value || !weekSelect) {
               if (tableBody) {
                 tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="bi bi-calendar-week me-2"></i>נא לבחור חודש ושבוע</td></tr>';
               }
               return;
             }
             const [year, month] = monthInput.value.split('-').map(Number);
             const week = parseInt(weekSelect.value) || 1;
             
             // נשתמש בנתונים שכבר נטענו אם יש
             if (window.weeklyCalculationsData && window.weeklyCalculationsData.allHistory) {
               displaySalesHistory(window.weeklyCalculationsData.allHistory);
               updateSalesHistorySummary({
                 totalSales: window.weeklyCalculationsData.totalProfitFromSales || 0,
                 totalPurchases: window.weeklyCalculationsData.totalPurchases || 0,
                 netProfit: window.weeklyCalculationsData.netProfit || 0
               });
             } else {
             google.script.run
               .withSuccessHandler(function(data) {
                   if (data && data.allHistory) {
                     displaySalesHistory(data.allHistory);
                     updateSalesHistorySummary({
                       totalSales: data.totalProfitFromSales || 0,
                       totalPurchases: data.totalPurchases || 0,
                       netProfit: data.netProfit || 0
                     });
                   } else {
                     if (tableBody) {
                       tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="bi bi-inbox me-2"></i>אין נתונים להצגה</td></tr>';
                     }
                   }
               })
               .withFailureHandler(function(error) {
                   console.error('שגיאה בטעינת דו"ח שבועי:', error);
                   if (tableBody) {
                     tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger py-4">שגיאה בטעינת נתונים</td></tr>';
                   }
                 })
                 .getWeeklyCalculations(year, month, week);
             }
           } else if (type === 'monthly') {
             const monthInput = document.getElementById('monthlyCalcMonth');
             if (!monthInput || !monthInput.value) {
               if (tableBody) {
                 tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="bi bi-calendar-month me-2"></i>נא לבחור חודש</td></tr>';
               }
               return;
             }
             const [year, month] = monthInput.value.split('-').map(Number);
             
             // נשתמש בנתונים שכבר נטענו אם יש
             if (window.monthlyCalculationsData && window.monthlyCalculationsData.allHistory) {
               displaySalesHistory(window.monthlyCalculationsData.allHistory);
               updateSalesHistorySummary({
                 totalSales: window.monthlyCalculationsData.totalProfitFromSales || 0,
                 totalPurchases: window.monthlyCalculationsData.totalPurchases || 0,
                 netProfit: window.monthlyCalculationsData.netProfit || 0
               });
             } else {
             google.script.run
               .withSuccessHandler(function(data) {
                   if (data && data.allHistory) {
                     displaySalesHistory(data.allHistory);
                     updateSalesHistorySummary({
                       totalSales: data.totalProfitFromSales || 0,
                       totalPurchases: data.totalPurchases || 0,
                       netProfit: data.netProfit || 0
                     });
                   } else {
                     if (tableBody) {
                       tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="bi bi-inbox me-2"></i>אין נתונים להצגה</td></tr>';
                     }
                   }
               })
               .withFailureHandler(function(error) {
                   console.error('שגיאה בטעינת דו"ח חודשי:', error);
                   if (tableBody) {
                     tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger py-4">שגיאה בטעינת נתונים</td></tr>';
                   }
                 })
                 .getMonthlyCalculations(year, month);
             }
           }
         }
         
         // הצגת דו"ח מפורט - מעבר לטבלה המפורטת
         function showDetailedReport(type) {
           // בחירת הסוג הנכון ברדיו בוטונים
           const reportTypeInput = document.querySelector(`input[name="reportType"][value="${type}"]`);
           if (reportTypeInput) {
             reportTypeInput.checked = true;
           }
           
           // טעינת הדו"ח המפורט
           loadDetailedReport();
           
           // גלילה לטבלה המפורטת
           setTimeout(function() {
             const tableContainer = document.getElementById('salesHistoryTableBody');
             if (tableContainer) {
               tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
             }
           }, 100);
         }
         
         
         // יצוא דו"ח מפורט לאקסל לפי תקופה (יומי/שבועי/חודשי)
         function exportDetailedReportForPeriod(reportType, exportType) {
           // אישור לפני יצוא
           const exportTypeNames = {
             'all': 'מסכם (מכירות + קניות)',
             'sales': 'רק מכירות',
             'purchases': 'רק קניות'
           };
           
           const periodNames = {
             'daily': 'יומי',
             'weekly': 'שבועי',
             'monthly': 'חודשי'
           };
           
           Swal.fire({
             title: 'ייצוא לאקסל',
             html: `<div style="text-align: right; direction: rtl;">
               <p>האם ברצונך לייצא <strong>${exportTypeNames[exportType]}</strong> של החישוב ה<strong>${periodNames[reportType]}</strong>?</p>
             </div>`,
             icon: 'question',
             showCancelButton: true,
             confirmButtonText: 'כן, ייצא',
             cancelButtonText: 'ביטול',
             confirmButtonColor: '#D4A574'
           }).then((result) => {
             if (result.isConfirmed) {
               Swal.fire({
                 title: 'מייצא לאקסל...',
                 text: 'אנא המתן',
                 allowOutsideClick: false,
                 didOpen: () => {
                   Swal.showLoading();
                 }
               });
         
               // קביעת הפרמטרים לפי הסוג
               if (reportType === 'daily') {
                 const dateInput = document.getElementById('dailyCalcDate');
                 if (!dateInput || !dateInput.value) {
                   Swal.fire('שגיאה', 'נא לבחור תאריך בחישוב היומי', 'error');
                   return;
                 }
                 google.script.run
                   .withSuccessHandler(function(url) {
                     Swal.close();
                     window.open(url, '_blank');
                     Swal.fire({
                       icon: 'success',
                       title: 'היצוא הושלם בהצלחה!',
                       text: 'הקובץ נפתח בחלון חדש',
                       timer: 2000,
                       showConfirmButton: false
                     });
                   })
                   .withFailureHandler(function(error) {
                     Swal.fire('שגיאה', error.message || 'שגיאה בייצוא לאקסל', 'error');
                   })
                   .exportDetailedReportToExcel('daily', exportType, dateInput.value);
               } else if (reportType === 'weekly') {
                 const monthInput = document.getElementById('weeklyCalcMonth');
                 const weekSelect = document.getElementById('weeklyCalcWeek');
                 if (!monthInput || !monthInput.value || !weekSelect) {
                   Swal.fire('שגיאה', 'נא לבחור חודש ושבוע בחישוב השבועי', 'error');
                   return;
                 }
                 const [year, month] = monthInput.value.split('-').map(Number);
                 const week = parseInt(weekSelect.value) || 1;
                 google.script.run
                   .withSuccessHandler(function(url) {
                     Swal.close();
                     window.open(url, '_blank');
                     Swal.fire({
                       icon: 'success',
                       title: 'היצוא הושלם בהצלחה!',
                       text: 'הקובץ נפתח בחלון חדש',
                       timer: 2000,
                       showConfirmButton: false
                     });
                   })
                   .withFailureHandler(function(error) {
                     Swal.fire('שגיאה', error.message || 'שגיאה בייצוא לאקסל', 'error');
                   })
                   .exportDetailedReportToExcel('weekly', exportType, year, month, week);
               } else if (reportType === 'monthly') {
                 const monthInput = document.getElementById('monthlyCalcMonth');
                 if (!monthInput || !monthInput.value) {
                   Swal.fire('שגיאה', 'נא לבחור חודש בחישוב החודשי', 'error');
                   return;
                 }
                 const [year, month] = monthInput.value.split('-').map(Number);
                 google.script.run
                   .withSuccessHandler(function(url) {
                     Swal.close();
                     window.open(url, '_blank');
                     Swal.fire({
                       icon: 'success',
                       title: 'היצוא הושלם בהצלחה!',
                       text: 'הקובץ נפתח בחלון חדש',
                       timer: 2000,
                       showConfirmButton: false
                     });
                   })
                   .withFailureHandler(function(error) {
                     Swal.fire('שגיאה', error.message || 'שגיאה בייצוא לאקסל', 'error');
                   })
                   .exportDetailedReportToExcel('monthly', exportType, year, month);
               }
             }
           });
         }
         
         // רינדור היסטוריית יום
         function renderDailySalesHistory(summary, date) {
           const tbody = document.getElementById('dailySalesTableBody');
           const statsContainer = document.getElementById('dailyStatsContainer');
           
           if (!summary) {
             if (tbody) {
             tbody.innerHTML = `
               <tr>
                   <td colspan="7" class="text-center text-muted py-5">
                   <i class="bi bi-inbox display-1 opacity-25"></i>
                     <p class="mt-3">אין נתונים להצגה</p>
                 </td>
               </tr>
             `;
             }
             if (statsContainer) {
               statsContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">אין נתונים לתאריך זה</div></div>';
             }
             return;
           }
           
           const salesItems = (summary.sales && summary.sales.items) ? summary.sales.items : [];
           
           if (salesItems.length === 0) {
             if (tbody) {
               tbody.innerHTML = `
                 <tr>
                   <td colspan="7" class="text-center text-muted py-5">
                     <i class="bi bi-inbox display-1 opacity-25"></i>
                     <p class="mt-3">אין מכירות לתאריך זה</p>
                   </td>
                 </tr>
               `;
             }
             if (statsContainer) {
               statsContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">אין נתונים לתאריך זה</div></div>';
             }
             return;
           }
           
           // רינדור טבלה
           let html = '';
           let totalQuantity = 0;
           let totalRevenue = 0;
           
           salesItems.forEach(function(sale) {
             const quantity = parseFloat(sale.quantity) || 0;
             const price = parseFloat(sale.price) || 0;
             const total = quantity * price;
             totalQuantity += quantity;
             totalRevenue += total;
             
             html += `
               <tr>
                 <td>${formatDateHebrew(sale.date || date)}</td>
                 <td>${sale.time || ''}</td>
                 <td>${sale.itemName || ''}</td>
                 <td>${sale.category || ''}</td>
                 <td>${quantity}</td>
                 <td>${formatPrice(price)}</td>
                 <td><strong>${formatPrice(total)}</strong></td>
               </tr>
             `;
           });
           
           if (tbody) tbody.innerHTML = html;
           
           // רינדור סטטיסטיקות
           const totalExpenses = summary.addedItems ? (parseFloat(summary.addedItems.totalCost) || 0) : 0;
           const netProfit = totalRevenue - totalExpenses;
           
           if (statsContainer) {
             statsContainer.innerHTML = `
               <div class="col-12 col-md-3">
                 <div class="stats-card text-center">
                   <small class="text-muted d-block mb-1">סה"כ מכירות</small>
                   <strong class="text-primary">${salesItems.length}</strong>
                 </div>
               </div>
               <div class="col-12 col-md-3">
                 <div class="stats-card text-center">
                   <small class="text-muted d-block mb-1">סה"כ כמות</small>
                   <strong class="text-info">${totalQuantity}</strong>
                 </div>
               </div>
               <div class="col-12 col-md-3">
                 <div class="stats-card text-center">
                   <small class="text-muted d-block mb-1">סה"כ הכנסות</small>
                   <strong class="text-success">${formatPrice(totalRevenue)}</strong>
                 </div>
               </div>
               <div class="col-12 col-md-3">
                 <div class="stats-card text-center">
                   <small class="text-muted d-block mb-1">רווח נקי</small>
                   <strong class="${netProfit >= 0 ? 'text-success' : 'text-danger'}">${formatPrice(netProfit)}</strong>
                 </div>
               </div>
             `;
           }
           
           // שמירת נתונים לייצוא
           window.currentDailySummary = summary;
           window.currentDailyDate = date;
         }
         
         // טעינת היסטוריית שבוע
         function loadWeeklySalesHistory() {
           const dateInput = document.getElementById('weeklyDateInput');
           const date = dateInput ? dateInput.value : null;
           
           if (!date) {
             const today = new Date();
             const todayStr = today.getFullYear() + '-' + 
               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
               String(today.getDate()).padStart(2, '0');
             if (dateInput) dateInput.value = todayStr;
             loadWeeklySalesHistory();
             return;
           }
           
           // חישוב תחילת וסוף השבוע
           const selectedDate = new Date(date + 'T00:00:00');
           const dayOfWeek = selectedDate.getDay();
           const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // יום ראשון = 0, אז -6 כדי להגיע לראשון
           const startDate = new Date(selectedDate);
           startDate.setDate(selectedDate.getDate() + diff);
           const endDate = new Date(startDate);
           endDate.setDate(startDate.getDate() + 6);
           
           const startDateStr = startDate.getFullYear() + '-' + 
             String(startDate.getMonth() + 1).padStart(2, '0') + '-' + 
             String(startDate.getDate()).padStart(2, '0');
           const endDateStr = endDate.getFullYear() + '-' + 
             String(endDate.getMonth() + 1).padStart(2, '0') + '-' + 
             String(endDate.getDate()).padStart(2, '0');
           
           // עדכון תצוגת השבוע
           const weekDisplay = document.getElementById('selectedWeekRange');
           if (weekDisplay) {
             weekDisplay.textContent = `${formatDateHebrew(startDateStr)} - ${formatDateHebrew(endDateStr)}`;
           }
           
           const tbody = document.getElementById('weeklySalesTableBody');
           const statsContainer = document.getElementById('weeklyStatsContainer');
           if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3"><div class="spinner-border spinner-border-sm" role="status"></div> טוען נתונים...</td></tr>';
           
           google.script.run
             .withSuccessHandler(function(summary) {
               renderWeeklySalesHistory(summary, startDateStr, endDateStr);
             })
             .withFailureHandler(function(error) {
               if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-3">שגיאה בטעינת הנתונים: ${error.message}</td></tr>`;
             })
             .getWeeklySummary(startDateStr, endDateStr);
         }
         
         // רינדור היסטוריית שבוע
         function renderWeeklySalesHistory(summary, startDate, endDate) {
           const tbody = document.getElementById('weeklySalesTableBody');
           const statsContainer = document.getElementById('weeklyStatsContainer');
           
           if (!summary) {
             if (tbody) {
               tbody.innerHTML = `
                 <tr>
                   <td colspan="7" class="text-center text-muted py-5">
                     <i class="bi bi-inbox display-1 opacity-25"></i>
                     <p class="mt-3">אין נתונים להצגה</p>
                   </td>
                 </tr>
               `;
             }
             if (statsContainer) {
               statsContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">אין נתונים לשבוע זה</div></div>';
             }
             return;
           }
           
           const salesItems = (summary.sales && summary.sales.items) ? summary.sales.items : [];
           
           if (salesItems.length === 0) {
             if (tbody) {
               tbody.innerHTML = `
                 <tr>
                   <td colspan="7" class="text-center text-muted py-5">
                     <i class="bi bi-inbox display-1 opacity-25"></i>
                     <p class="mt-3">אין מכירות לשבוע זה</p>
                   </td>
                 </tr>
               `;
             }
             if (statsContainer) {
               statsContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">אין נתונים לשבוע זה</div></div>';
             }
             return;
           }
           
           // רינדור טבלה
           let html = '';
           let totalQuantity = 0;
           let totalRevenue = 0;
           
           salesItems.forEach(function(sale) {
             const quantity = parseFloat(sale.quantity) || 0;
             const price = parseFloat(sale.price) || 0;
             const total = quantity * price;
             totalQuantity += quantity;
             totalRevenue += total;
             
             html += `
               <tr>
                 <td>${formatDateHebrew(sale.date)}</td>
                 <td>${sale.time || ''}</td>
                 <td>${sale.itemName || ''}</td>
                 <td>${sale.category || ''}</td>
                 <td>${quantity}</td>
                 <td>${formatPrice(price)}</td>
                 <td><strong>${formatPrice(total)}</strong></td>
               </tr>
             `;
           });
           
           if (tbody) tbody.innerHTML = html;
           
           // רינדור סטטיסטיקות
           const totalExpenses = summary.addedItems ? (parseFloat(summary.addedItems.totalCost) || 0) : 0;
           const netProfit = totalRevenue - totalExpenses;
           
           if (statsContainer) {
             statsContainer.innerHTML = `
               <div class="col-12 col-md-3">
                 <div class="stats-card text-center">
                   <small class="text-muted d-block mb-1">סה"כ מכירות</small>
                   <strong class="text-primary">${salesItems.length}</strong>
               </div>
               </div>
               <div class="col-12 col-md-3">
                 <div class="stats-card text-center">
                   <small class="text-muted d-block mb-1">סה"כ כמות</small>
                   <strong class="text-info">${totalQuantity}</strong>
                 </div>
               </div>
               <div class="col-12 col-md-3">
                 <div class="stats-card text-center">
                   <small class="text-muted d-block mb-1">סה"כ הכנסות</small>
                   <strong class="text-success">${formatPrice(totalRevenue)}</strong>
                 </div>
               </div>
               <div class="col-12 col-md-3">
                 <div class="stats-card text-center">
                   <small class="text-muted d-block mb-1">רווח נקי</small>
                   <strong class="${netProfit >= 0 ? 'text-success' : 'text-danger'}">${formatPrice(netProfit)}</strong>
                 </div>
               </div>
             `;
           }
           
           // שמירת נתונים לייצוא
           window.currentWeeklySummary = summary;
           window.currentWeeklyDateRange = { start: startDate, end: endDate };
         }
         
         // טעינת היסטוריית חודש
         function loadMonthlySalesHistory() {
           const dateInput = document.getElementById('monthlyDateInput');
           const monthValue = dateInput ? dateInput.value : null;
           
           if (!monthValue) {
             const today = new Date();
             const monthStr = today.getFullYear() + '-' + 
               String(today.getMonth() + 1).padStart(2, '0');
             if (dateInput) dateInput.value = monthStr;
             loadMonthlySalesHistory();
             return;
           }
           
           const parts = monthValue.split('-');
           const year = parseInt(parts[0]);
           const month = parseInt(parts[1]);
           
           const tbody = document.getElementById('monthlySalesTableBody');
           const statsContainer = document.getElementById('monthlyStatsContainer');
           if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3"><div class="spinner-border spinner-border-sm" role="status"></div> טוען נתונים...</td></tr>';
           
           google.script.run
             .withSuccessHandler(function(summary) {
               renderMonthlySalesHistory(summary, year, month);
             })
             .withFailureHandler(function(error) {
               if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-3">שגיאה בטעינת הנתונים: ${error.message}</td></tr>`;
             })
             .getMonthlySummary(year, month);
         }
         
         // רינדור היסטוריית חודש
         function renderMonthlySalesHistory(summary, year, month) {
           const tbody = document.getElementById('monthlySalesTableBody');
           const statsContainer = document.getElementById('monthlyStatsContainer');
           
           if (!summary) {
             if (tbody) {
               tbody.innerHTML = `
                 <tr>
                   <td colspan="7" class="text-center text-muted py-5">
                     <i class="bi bi-inbox display-1 opacity-25"></i>
                     <p class="mt-3">אין נתונים להצגה</p>
                   </td>
                 </tr>
               `;
             }
             if (statsContainer) {
               statsContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">אין נתונים לחודש זה</div></div>';
             }
             return;
           }
           
           const salesItems = (summary.sales && summary.sales.items) ? summary.sales.items : [];
           
           if (salesItems.length === 0) {
             if (tbody) {
               tbody.innerHTML = `
                 <tr>
                   <td colspan="7" class="text-center text-muted py-5">
                     <i class="bi bi-inbox display-1 opacity-25"></i>
                     <p class="mt-3">אין מכירות לחודש זה</p>
                   </td>
                 </tr>
               `;
             }
             if (statsContainer) {
               statsContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">אין נתונים לחודש זה</div></div>';
             }
             return;
           }
           
           // רינדור טבלה
           let html = '';
           let totalQuantity = 0;
           let totalRevenue = 0;
           
           salesItems.forEach(function(sale) {
             const quantity = parseFloat(sale.quantity) || 0;
             const price = parseFloat(sale.price) || 0;
             const total = quantity * price;
             totalQuantity += quantity;
             totalRevenue += total;
             
             html += `
               <tr>
                 <td>${formatDateHebrew(sale.date)}</td>
                 <td>${sale.time || ''}</td>
                 <td>${sale.itemName || ''}</td>
                 <td>${sale.category || ''}</td>
                 <td>${quantity}</td>
                 <td>${formatPrice(price)}</td>
                 <td><strong>${formatPrice(total)}</strong></td>
               </tr>
             `;
           });
           
           if (tbody) tbody.innerHTML = html;
           
           // רינדור סטטיסטיקות
           const totalExpenses = summary.addedItems ? (parseFloat(summary.addedItems.totalCost) || 0) : 0;
           const netProfit = totalRevenue - totalExpenses;
           
           if (statsContainer) {
             statsContainer.innerHTML = `
               <div class="col-12 col-md-3">
                 <div class="stats-card text-center">
                   <small class="text-muted d-block mb-1">סה"כ מכירות</small>
                   <strong class="text-primary">${salesItems.length}</strong>
                 </div>
               </div>
               <div class="col-12 col-md-3">
                 <div class="stats-card text-center">
                   <small class="text-muted d-block mb-1">סה"כ כמות</small>
                   <strong class="text-info">${totalQuantity}</strong>
                 </div>
               </div>
               <div class="col-12 col-md-3">
                 <div class="stats-card text-center">
                   <small class="text-muted d-block mb-1">סה"כ הכנסות</small>
                   <strong class="text-success">${formatPrice(totalRevenue)}</strong>
                 </div>
               </div>
               <div class="col-12 col-md-3">
                 <div class="stats-card text-center">
                   <small class="text-muted d-block mb-1">רווח נקי</small>
                   <strong class="${netProfit >= 0 ? 'text-success' : 'text-danger'}">${formatPrice(netProfit)}</strong>
                 </div>
               </div>
             `;
           }
           
           // שמירת נתונים לייצוא
           window.currentMonthlySummary = summary;
           window.currentMonthlyDate = { year: year, month: month };
         }
         
         // פונקציה לייצוא לאקסל
         function exportSalesHistoryExcel(periodType, exportType) {
           let dateParam = null;
           let typeParam = null;
           
           if (periodType === 'daily') {
             const dateInput = document.getElementById('dailyDateInput');
             dateParam = dateInput ? dateInput.value : null;
             typeParam = 'daily';
           } else if (periodType === 'weekly') {
             const dateInput = document.getElementById('weeklyDateInput');
             const date = dateInput ? dateInput.value : null;
             if (date) {
               const selectedDate = new Date(date + 'T00:00:00');
               const dayOfWeek = selectedDate.getDay();
               const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
               const startDate = new Date(selectedDate);
               startDate.setDate(selectedDate.getDate() + diff);
               const endDate = new Date(startDate);
               endDate.setDate(startDate.getDate() + 6);
               const startDateStr = startDate.getFullYear() + '-' + 
                 String(startDate.getMonth() + 1).padStart(2, '0') + '-' + 
                 String(startDate.getDate()).padStart(2, '0');
               const endDateStr = endDate.getFullYear() + '-' + 
                 String(endDate.getMonth() + 1).padStart(2, '0') + '-' + 
                 String(endDate.getDate()).padStart(2, '0');
               dateParam = startDateStr + '|' + endDateStr;
             }
             typeParam = 'weekly';
           } else if (periodType === 'monthly') {
             const dateInput = document.getElementById('monthlyDateInput');
             dateParam = dateInput ? dateInput.value : null;
             typeParam = 'monthly';
           }
           
           if (!dateParam) {
             Swal.fire({icon: 'warning', title: 'אזהרה', text: 'אנא בחר תאריך/שבוע/חודש לפני הייצוא'});
             return;
           }
           
           Swal.fire({
             title: 'מייצא לאקסל...',
             didOpen: () => { Swal.showLoading() },
             allowOutsideClick: false
           });
           
           google.script.run
             .withSuccessHandler(function(url) {
               Swal.fire({
                 icon: 'success',
                 title: 'הייצוא הושלם!',
                 text: 'הקובץ מוכן להורדה',
                 showCancelButton: true,
                 confirmButtonText: 'הורד קובץ',
                 cancelButtonText: 'סגור',
                 confirmButtonColor: '#D4A574'
               }).then((result) => {
                 if (result.isConfirmed) {
                   window.open(url, '_blank');
                 }
               });
             })
             .withFailureHandler(function(error) {
               Swal.fire({icon: 'error', title: 'שגיאה', text: error.message});
             })
             .exportSalesHistoryToExcelNew(typeParam, dateParam, exportType);
         }
         
         // פונקציית עזר לפורמט תאריך בעברית
         function formatDateHebrew(dateStr) {
           if (!dateStr) return '';
           try {
             const date = new Date(dateStr + 'T00:00:00');
             return date.toLocaleDateString('he-IL', { year: 'numeric', month: '2-digit', day: '2-digit' });
           } catch (e) {
             return dateStr;
           }
         }
         
         
         function loadMonthlyProfits() {
           const today = new Date();
           const year = today.getFullYear();
           const month = today.getMonth() + 1;
           const monthStr = year + '-' + String(month).padStart(2, '0');
           
           google.script.run
             .withSuccessHandler(function(profits) {
               document.getElementById('monthlyProfit').innerText = formatPrice(profits.netProfit || 0);
               document.getElementById('monthlyCalculation').innerText = formatPrice(profits.totalRevenue || 0);
               // שמירת הנתונים לשימוש במודל
               window.monthlyProfitData = profits;
             })
             .withFailureHandler(function(error) {
               document.getElementById('monthlyProfit').innerText = '₪0';
               document.getElementById('monthlyCalculation').innerText = '₪0';
             })
             .getMonthlyProfits(year, month);
         }
         
         function showMonthlyProfitDetails() {
           if (!window.monthlyProfitData) {
             Swal.fire('מידע', 'טוען נתונים...', 'info');
             loadMonthlyProfits();
             setTimeout(showMonthlyProfitDetails, 1000);
             return;
           }
         
           const data = window.monthlyProfitData;
           let html = `
             <div class="text-start">
               <h6 class="fw-bold mb-3">פרטי רווחים חודשיים</h6>
               <div class="mb-2">
                 <strong>סה"כ הכנסות:</strong> ${formatPrice(data.totalRevenue || 0)}
             </div>
               <div class="mb-2">
                 <strong>סה"כ הוצאות (קנייה מהספק):</strong> ${formatPrice(data.totalExpenses || 0)}
               </div>
               <div class="mb-2">
                 <strong>רווח נטו:</strong> <span style="color: #28a745; font-size: 1.2rem; font-weight: bold;">${formatPrice(data.netProfit || 0)}</span>
               </div>
               <hr>
               <h6 class="fw-bold mt-3 mb-2">פירוט לפי מוצרים:</h6>
               <div style="max-height: 300px; overflow-y: auto;">
           `;
         
           if (data.items && data.items.length > 0) {
             data.items.forEach(item => {
               const profit = (item.revenue || 0) - (item.expenses || 0);
               html += `
                 <div class="border rounded p-2 mb-2">
                   <strong>${item.name || 'ללא שם'}</strong>
                   <div class="small text-muted mt-1">
                     נמכר: ${item.quantity || 0} יחידות | 
                     הכנסה: ${formatPrice(item.revenue || 0)} | 
                     הוצאה: ${formatPrice(item.expenses || 0)} | 
                     רווח: <span style="color: ${profit >= 0 ? '#28a745' : '#dc3545'}">${formatPrice(profit)}</span>
                   </div>
                 </div>
               `;
             });
               } else {
             html += '<p class="text-muted">אין מכירות בחודש זה</p>';
           }
         
           html += '</div></div>';
         
           Swal.fire({
             title: 'רווחים חודשיים',
             html: html,
             width: '600px',
             confirmButtonText: 'סגור',
             confirmButtonColor: '#D4A574'
           });
         }
         
         function showMonthlyCalculation() {
           if (!window.monthlyProfitData) {
             Swal.fire('מידע', 'טוען נתונים...', 'info');
             loadMonthlyProfits();
             setTimeout(showMonthlyCalculation, 1000);
             return;
           }
         
           const data = window.monthlyProfitData;
           let html = `
             <div class="text-start">
               <h6 class="fw-bold mb-3">חישוב חודשי</h6>
               <div class="mb-2">
                 <strong>סה"כ מכירות (הכנסות):</strong> ${formatPrice(data.totalRevenue || 0)}
               </div>
               <div class="mb-2">
                 <strong>סה"כ קניות מהספק:</strong> ${formatPrice(data.totalExpenses || 0)}
               </div>
               <div class="mb-2">
                 <strong>רווח נטו:</strong> <span style="color: #28a745; font-size: 1.2rem; font-weight: bold;">${formatPrice(data.netProfit || 0)}</span>
               </div>
               <div class="mb-2">
                 <strong>אחוז רווחיות:</strong> <span style="color: #28a745; font-weight: bold;">
                   ${data.totalRevenue > 0 ? ((data.netProfit / data.totalRevenue) * 100).toFixed(2) : 0}%
                 </span>
               </div>
               <hr>
               <h6 class="fw-bold mt-3 mb-2">סיכום:</h6>
               <div class="alert alert-info">
                 <strong>הכנסות:</strong> ${formatPrice(data.totalRevenue || 0)}<br>
                 <strong>הוצאות:</strong> ${formatPrice(data.totalExpenses || 0)}<br>
                 <strong>רווח נטו:</strong> ${formatPrice(data.netProfit || 0)}
               </div>
             </div>
           `;
           
           Swal.fire({
             title: 'חישוב חודשי',
             html: html,
             width: '600px',
             confirmButtonText: 'סגור',
             confirmButtonColor: '#D4A574'
           });
         }
         
         
         function sellItem(rowIndex, itemName, category) {
           // אם rowIndex הוא 'new' או לא מספר, צריך למצוא את ה-rowIndex לפי שם המוצר
           let actualRowIndex = rowIndex;
           if (rowIndex === 'new' || rowIndex === null || rowIndex === undefined || rowIndex === '' || isNaN(parseInt(rowIndex))) {
             // נחפש את המוצר ב-allData לפי שם וקטגוריה
             const foundItem = allData.find(item => 
               item.name === itemName && (item.category === category || (!item.category && !category))
             );
             if (foundItem && foundItem.rowIndex) {
               actualRowIndex = foundItem.rowIndex;
             } else {
               Swal.fire({
                 icon: 'error', 
                 title: 'שגיאה', 
                 text: 'לא ניתן למצוא את המוצר במערכת. אנא רענן את הדף ונסה שוב.',
                 confirmButtonColor: '#D4A574'
               });
               return;
             }
           }
           
           // המרה למספר
           actualRowIndex = parseInt(actualRowIndex);
           if (isNaN(actualRowIndex) || actualRowIndex < 2) {
             Swal.fire({
               icon: 'error', 
               title: 'שגיאה', 
               text: 'מספר שורה לא תקין: ' + rowIndex + '. אנא רענן את הדף ונסה שוב.',
               confirmButtonColor: '#D4A574'
             });
             return;
           }
           
           // וידוא שיש קטגוריה
           if (!category || category === '') {
             Swal.fire({
               icon: 'error', 
               title: 'שגיאה', 
               text: 'קטגוריה לא מוגדרת. אנא רענן את הדף ונסה שוב.',
               confirmButtonColor: '#D4A574'
             });
             return;
           }
           
           Swal.fire({
             title: `מכירה: ${itemName}`,
             text: 'כמה יחידות נמכרו?',
             input: 'number',
             inputValue: 1,
             inputAttributes: {
               min: 1,
               step: 1
             },
             showCancelButton: true,
             confirmButtonText: 'אישור מכירה',
             cancelButtonText: 'ביטול',
             confirmButtonColor: '#4caf50',
             inputValidator: (value) => {
               if (!value || value <= 0) {
                 return 'חובה להזין כמות תקינה';
               }
             }
           }).then((result) => {
             if (result.isConfirmed) {
               const quantity = parseInt(result.value);
               if (isNaN(quantity) || quantity <= 0) {
                 Swal.fire({
                   icon: 'error',
                   title: 'שגיאה',
                   text: 'כמות לא תקינה',
                   confirmButtonColor: '#D4A574'
                 });
                 return;
               }
               
               Swal.fire({
                 title: 'מבצע מכירה...',
                 didOpen: () => { Swal.showLoading() },
                 allowOutsideClick: false
               });
               
               google.script.run
                 .withSuccessHandler(function(response) {
                   if (response && response.success === false) {
                     Swal.fire({
                       icon: 'error',
                       title: 'שגיאה',
                       text: response.message || 'המכירה נכשלה',
                       confirmButtonColor: '#D4A574'
                     });
                   } else {
                     Swal.fire({
                       icon: 'success',
                       title: response.message || 'המכירה בוצעה בהצלחה!',
                       timer: 1500,
                       showConfirmButton: false
                     });
                   // איפוס cache כדי לטעון נתונים מעודכנים
                   invalidateCache('all');
                   loadData();
                   }
                 })
                 .withFailureHandler(function(error) {
                   Swal.fire({
                     icon: 'error',
                     title: 'שגיאה',
                     text: error.message || 'אירעה שגיאה בעת ביצוע המכירה',
                     confirmButtonColor: '#D4A574'
                   });
                 })
                 .sellItem(category, actualRowIndex, quantity, 'מערכת מנהל');
             }
           });
         }
         
         
         // משתנים גלובליים להיסטוריה החדשה
         let currentHistoryTab = 'daily';
         let currentHistoryDate = null;
         let currentHistoryWeek = null;
         
         
         // פונקציות להיסטוריית מכירות
         function updateSalesHistoryFilters() {
           const periodType = document.getElementById('salesHistoryPeriodType') ? document.getElementById('salesHistoryPeriodType').value : 'daily';
           const dateFilter = document.getElementById('salesHistoryDateFilter');
           const weekFilter = document.getElementById('salesHistoryWeekFilter');
           const weekSelector = document.getElementById('salesHistoryWeekSelector');
           const monthFilter = document.getElementById('salesHistoryMonthFilter');
           
           if (periodType === 'daily') {
             if (dateFilter) dateFilter.style.display = 'block';
             if (weekFilter) weekFilter.style.display = 'none';
             if (weekSelector) weekSelector.style.display = 'none';
             if (monthFilter) monthFilter.style.display = 'none';
           } else if (periodType === 'weekly') {
             if (dateFilter) dateFilter.style.display = 'none';
             if (weekFilter) weekFilter.style.display = 'block';
             if (weekSelector) weekSelector.style.display = 'block';
             if (monthFilter) monthFilter.style.display = 'none';
             updateSalesHistoryWeekSelector();
           } else if (periodType === 'monthly') {
             if (dateFilter) dateFilter.style.display = 'none';
             if (weekFilter) weekFilter.style.display = 'none';
             if (weekSelector) weekSelector.style.display = 'none';
             if (monthFilter) monthFilter.style.display = 'block';
           }
           
           loadSalesHistory();
         }
         
         function updateSalesHistoryWeekSelector() {
           const monthInput = document.getElementById('salesHistoryMonth');
           const weekSelect = document.getElementById('salesHistoryWeek');
           if (!monthInput || !weekSelect) return;
           
           const monthValue = monthInput.value;
           if (!monthValue) return;
           
           const [year, month] = monthInput.value.split('-').map(Number);
           const firstDay = new Date(year, month - 1, 1);
           const lastDay = new Date(year, month, 0);
           const dayOfWeek = firstDay.getDay();
           const daysInMonth = lastDay.getDate();
           const weeksInMonth = Math.ceil((daysInMonth + dayOfWeek) / 7);
           
           weekSelect.innerHTML = '';
           for (let i = 1; i <= Math.min(weeksInMonth, 5); i++) {
             const option = document.createElement('option');
             option.value = i;
             option.textContent = i;
             weekSelect.appendChild(option);
           }
         }
         
         function loadSalesHistory() {
           const loadingIndicator = document.getElementById('salesHistoryLoadingIndicator');
           const tableBody = document.getElementById('salesHistoryTableBody');
           
           if (loadingIndicator) loadingIndicator.classList.remove('d-none');
           if (tableBody) {
             tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4"><i class="bi bi-hourglass-split me-2"></i>טוען נתונים...</td></tr>';
           }
           
           const periodType = document.getElementById('salesHistoryPeriodType') ? document.getElementById('salesHistoryPeriodType').value : 'daily';
           let dateFrom = '';
           let dateTo = '';
           
           if (periodType === 'daily') {
             const dateInput = document.getElementById('salesHistoryDate');
             if (dateInput && dateInput.value) {
               dateFrom = dateInput.value;
               dateTo = dateInput.value;
             } else {
               const today = new Date();
               dateFrom = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
               dateTo = dateFrom;
               if (dateInput) dateInput.value = dateFrom;
             }
           } else if (periodType === 'weekly') {
             const monthInput = document.getElementById('salesHistoryMonth');
             const weekSelect = document.getElementById('salesHistoryWeek');
             if (monthInput && monthInput.value && weekSelect && weekSelect.value) {
               const [year, month] = monthInput.value.split('-').map(Number);
               const week = parseInt(weekSelect.value) || 1;
               const firstDay = new Date(year, month - 1, 1);
               const dayOfWeek = firstDay.getDay();
               let startDate = new Date(firstDay);
               startDate.setDate(1 + (week - 1) * 7 - dayOfWeek);
               if (startDate.getMonth() !== month - 1) {
                 startDate = new Date(year, month - 1, 1);
               }
               let endDate = new Date(startDate);
               endDate.setDate(startDate.getDate() + 6);
               if (endDate.getMonth() !== month - 1) {
                 endDate = new Date(year, month, 0);
               }
               dateFrom = startDate.getFullYear() + '-' + String(startDate.getMonth() + 1).padStart(2, '0') + '-' + String(startDate.getDate()).padStart(2, '0');
               dateTo = endDate.getFullYear() + '-' + String(endDate.getMonth() + 1).padStart(2, '0') + '-' + String(endDate.getDate()).padStart(2, '0');
             }
           } else if (periodType === 'monthly') {
             const monthInput = document.getElementById('salesHistoryMonthOnly');
             if (monthInput && monthInput.value) {
               dateFrom = monthInput.value + '-01';
               const [year, month] = monthInput.value.split('-').map(Number);
               const lastDay = new Date(year, month, 0).getDate();
               dateTo = monthInput.value + '-' + String(lastDay).padStart(2, '0');
             }
           }
           
           if (!dateFrom) {
             if (loadingIndicator) loadingIndicator.classList.add('d-none');
             return;
           }
           
           google.script.run
             .withSuccessHandler(function(data) {
               if (loadingIndicator) loadingIndicator.classList.add('d-none');
               displaySalesHistory(data);
             })
             .withFailureHandler(function(error) {
               if (loadingIndicator) loadingIndicator.classList.add('d-none');
               console.error('שגיאה בטעינת היסטוריית מכירות:', error);
               Swal.fire({
                 icon: 'error',
                 title: 'שגיאה',
                 text: error.message || 'שגיאה בטעינת היסטוריה',
                 confirmButtonColor: '#D4A574'
               });
               if (tableBody) {
                 tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger py-4">שגיאה בטעינת נתונים</td></tr>';
               }
             })
             .getAllHistoryLive('all', dateFrom, dateTo);
         }
         
         function displaySalesHistory(data) {
           const tableBody = document.getElementById('salesHistoryTableBody');
           if (!tableBody) return;
           
           if (!data || data.length === 0) {
             tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4"><i class="bi bi-inbox me-2"></i>אין נתונים להצגה</td></tr>';
             updateSalesHistorySummary({ totalSales: 0, totalPurchases: 0, netProfit: 0 });
             return;
           }
           
           let html = '';
           let totalSales = 0;
           let totalPurchases = 0;
           
           data.forEach(function(item) {
             const date = item.date || '';
             const time = item.time || '';
             const type = item.type || 'unknown';
             const typeLabel = type === 'sales' ? '<span class="badge bg-success">מכירה</span>' : '<span class="badge bg-danger">קנייה</span>';
             const itemName = item.itemName || '';
             const category = item.category || '';
             const quantity = item.quantity || 0;
             const price = item.price || item.purchasePrice || 0;
             const total = item.total || (quantity * price);
             const source = item.source || 'מערכת מנהל';
             
             // עיצוב מקור עם צבעים שונים
             let sourceBadge = '';
             if (source === 'מערכת מוכרים') {
               sourceBadge = '<span class="badge bg-primary">מערכת מוכרים</span>';
             } else if (source === 'דוא"ל') {
               sourceBadge = '<span class="badge bg-info">דוא"ל</span>';
             } else {
               sourceBadge = '<span class="badge bg-secondary">מערכת מנהל</span>';
             }
             
             if (type === 'sales') {
               totalSales += total;
             } else {
               totalPurchases += total;
             }
             
             html += `
               <tr>
                 <td>${date}</td>
                 <td>${time}</td>
                 <td>${typeLabel}</td>
                 <td>${itemName}</td>
                 <td>${category}</td>
                 <td>${quantity}</td>
                 <td>₪${price.toFixed(2)}</td>
                 <td class="fw-bold">₪${total.toFixed(2)}</td>
                 <td>${sourceBadge}</td>
               </tr>
             `;
           });
           
           tableBody.innerHTML = html;
           updateSalesHistorySummary({
             totalSales: totalSales,
             totalPurchases: totalPurchases,
             netProfit: totalSales - totalPurchases
           });
         }
         
         function updateSalesHistorySummary(summary) {
           const totalSalesEl = document.getElementById('salesHistoryTotalSales');
           const totalPurchasesEl = document.getElementById('salesHistoryTotalPurchases');
           const netProfitEl = document.getElementById('salesHistoryNetProfit');
           
           if (totalSalesEl) totalSalesEl.textContent = formatPrice(summary.totalSales || 0);
           if (totalPurchasesEl) totalPurchasesEl.textContent = formatPrice(summary.totalPurchases || 0);
           if (netProfitEl) {
             netProfitEl.textContent = formatPrice(summary.netProfit || 0);
             netProfitEl.className = 'stat-value ' + (summary.netProfit >= 0 ? 'text-success' : 'text-danger');
           }
         }
         
         function exportSalesHistoryToExcel(exportType, sourceFilter) {
           exportType = exportType || 'all';
           sourceFilter = sourceFilter || null; // null = כל המקורות
           
           const periodType = document.getElementById('salesHistoryPeriodType') ? document.getElementById('salesHistoryPeriodType').value : 'daily';
           let dateFrom = '';
           let dateTo = '';
           
           if (periodType === 'daily') {
             const dateInput = document.getElementById('salesHistoryDate');
             if (dateInput && dateInput.value) {
               dateFrom = dateInput.value;
               dateTo = dateInput.value;
             }
           } else if (periodType === 'weekly') {
             const monthInput = document.getElementById('salesHistoryMonth');
             const weekSelect = document.getElementById('salesHistoryWeek');
             if (monthInput && monthInput.value && weekSelect && weekSelect.value) {
               const [year, month] = monthInput.value.split('-').map(Number);
               const week = parseInt(weekSelect.value) || 1;
               const firstDay = new Date(year, month - 1, 1);
               const dayOfWeek = firstDay.getDay();
               let startDate = new Date(firstDay);
               startDate.setDate(1 + (week - 1) * 7 - dayOfWeek);
               if (startDate.getMonth() !== month - 1) {
                 startDate = new Date(year, month - 1, 1);
               }
               let endDate = new Date(startDate);
               endDate.setDate(startDate.getDate() + 6);
               if (endDate.getMonth() !== month - 1) {
                 endDate = new Date(year, month, 0);
               }
               dateFrom = startDate.getFullYear() + '-' + String(startDate.getMonth() + 1).padStart(2, '0') + '-' + String(startDate.getDate()).padStart(2, '0');
               dateTo = endDate.getFullYear() + '-' + String(endDate.getMonth() + 1).padStart(2, '0') + '-' + String(endDate.getDate()).padStart(2, '0');
             }
           } else if (periodType === 'monthly') {
             const monthInput = document.getElementById('salesHistoryMonthOnly');
             if (monthInput && monthInput.value) {
               dateFrom = monthInput.value + '-01';
               const [year, month] = monthInput.value.split('-').map(Number);
               const lastDay = new Date(year, month, 0).getDate();
               dateTo = monthInput.value + '-' + String(lastDay).padStart(2, '0');
             }
           }
           
           if (!dateFrom) {
             Swal.fire({
               icon: 'warning',
               title: 'אזהרה',
               text: 'אנא בחר תאריך/שבוע/חודש',
               confirmButtonColor: '#D4A574'
             });
             return;
           }
           
             Swal.fire({
               title: 'מייצא לאקסל...',
               didOpen: () => { Swal.showLoading() },
               allowOutsideClick: false
             });
             
           // עבור סיכום בלבד
           if (exportType === 'summary') {
             google.script.run
               .withSuccessHandler(function(url) {
                 Swal.fire({
                   icon: 'success',
                   title: 'הייצוא הושלם!',
                   text: 'הקובץ מוכן להורדה',
                   showCancelButton: true,
                   confirmButtonText: 'הורד קובץ',
                   cancelButtonText: 'סגור',
                   confirmButtonColor: '#D4A574'
                 }).then((result) => {
                   if (result.isConfirmed) {
                     window.open(url, '_blank');
                   }
                 });
               })
               .withFailureHandler(function(error) {
                 Swal.fire({
                   icon: 'error',
                   title: 'שגיאה',
                   text: error.message || 'שגיאה בייצוא לאקסל',
                   confirmButtonColor: '#D4A574'
                 });
               })
               .exportAllHistoryToExcel('all', dateFrom, dateTo, 'summary');
           } else {
             // עבור הכנסות, הוצאות, או הכל
             const typeFilter = exportType === 'sales' ? 'sales' : (exportType === 'purchases' ? 'purchases' : 'all');
             
             google.script.run
               .withSuccessHandler(function(url) {
                 Swal.fire({
                   icon: 'success',
                   title: 'הייצוא הושלם!',
                   text: 'הקובץ מוכן להורדה',
                   showCancelButton: true,
                   confirmButtonText: 'הורד קובץ',
                   cancelButtonText: 'סגור',
                   confirmButtonColor: '#D4A574'
                 }).then((result) => {
                   if (result.isConfirmed) {
                     window.open(url, '_blank');
                   }
                 });
               })
               .withFailureHandler(function(error) {
                 Swal.fire({
                   icon: 'error',
                   title: 'שגיאה',
                   text: error.message || 'שגיאה בייצוא לאקסל',
                   confirmButtonColor: '#D4A574'
                 });
               })
               .exportAllHistoryToExcel(typeFilter, dateFrom, dateTo, 'full', sourceFilter);
           }
         }
         let currentHistoryMonth = null;
         let historyChart = null;
         
         // פונקציה למעבר בין כרטיסיות ההיסטוריה
         function switchHistoryTab(tabType) {
           currentHistoryTab = tabType;
           const today = new Date();
           
           if (tabType === 'daily') {
             const dateStr = today.getFullYear() + '-' + 
               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
               String(today.getDate()).padStart(2, '0');
             currentHistoryDate = dateStr;
             const datePicker = document.getElementById('dailyDatePicker');
             if (datePicker) datePicker.value = dateStr;
             loadDailySummary(dateStr);
           } else if (tabType === 'weekly') {
             // הגדרת תאריך ברירת מחדל - היום
             const datePicker = document.getElementById('weeklyDatePicker');
             if (datePicker) {
               const dateStr = today.getFullYear() + '-' + 
                 String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                 String(today.getDate()).padStart(2, '0');
               datePicker.value = dateStr;
               selectWeekFromDateInput();
             }
           } else if (tabType === 'monthly') {
             // הגדרת חודש ברירת מחדל - החודש הנוכחי
             const datePicker = document.getElementById('monthlyDatePicker');
             if (datePicker) {
               const monthStr = today.getFullYear() + '-' + 
                 String(today.getMonth() + 1).padStart(2, '0');
               datePicker.value = monthStr;
               selectMonthFromInput();
             }
           }
         }
         
         // טעינת סיכום יומי
         function loadDailySummary(date) {
           if (!date) {
             const today = new Date();
             date = today.getFullYear() + '-' + 
               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
               String(today.getDate()).padStart(2, '0');
           }
           currentHistoryDate = date;
           
           const kpiContainer = document.getElementById('dailyKPI');
           
           // הוספת timeout למניעת תקיעות
           let dailyTimeoutId = setTimeout(function() {
           if (kpiContainer) {
               kpiContainer.innerHTML = '<div class="alert alert-warning">הטעינה לוקחת זמן רב. נסה לרענן את הדף (F5) או לנסות שוב.</div>';
           }
           }, 30000); // 30 שניות
           
           google.script.run
             .withSuccessHandler(function(summary) {
               clearTimeout(dailyTimeoutId);
               renderDailySummary(summary);
             })
             .withFailureHandler(function(error) {
               clearTimeout(dailyTimeoutId);
               if (kpiContainer) {
                 kpiContainer.innerHTML = '<div class="alert alert-danger mt-3">שגיאה בטעינת הנתונים: ' + (error.message || 'נסה לרענן את הדף') + '</div>';
               }
             })
             .getDailySummary(date);
         }
         
         // רינדור סיכום יומי
         function renderDailySummary(summary) {
           const kpiContainer = document.getElementById('dailyKPI');
           if (!kpiContainer) {
             return;
           }
           
           if (!summary) {
             kpiContainer.innerHTML = '<div class="alert alert-warning mt-3">אין נתונים להצגה לתאריך זה</div>';
             return;
           }
           
           // בדיקה אם יש נתונים בכלל
           const hasSales = summary.sales && summary.sales.items && summary.sales.items.length > 0;
           const hasAddedItems = summary.addedItems && summary.addedItems.items && summary.addedItems.items.length > 0;
           
           if (!hasSales && !hasAddedItems) {
             kpiContainer.innerHTML = '<div class="alert alert-info mt-3"><i class="bi bi-info-circle me-2"></i>אין מכירות או הוספות לתאריך זה. נסה לבחור תאריך אחר או לבצע מכירה.</div>';
             return;
           }
           
           const netProfit = summary.netProfit || 0;
           const totalRevenue = summary.totalRevenue || 0;
           const totalExpenses = summary.totalExpenses || 0;
           
           kpiContainer.innerHTML = `
             <div class="col-12 col-md-4">
               <div class="kpi-card">
                 <h6><i class="bi bi-arrow-up-circle text-success me-1"></i>סה"כ הכנסות</h6>
                 <div class="stat-value text-success">${formatPrice(totalRevenue)}</div>
               </div>
             </div>
             <div class="col-12 col-md-4">
               <div class="kpi-card">
                 <h6><i class="bi bi-arrow-down-circle text-danger me-1"></i>סה"כ הוצאות</h6>
                 <div class="stat-value text-danger">${formatPrice(totalExpenses)}</div>
               </div>
             </div>
             <div class="col-12 col-md-4">
               <div class="kpi-card">
                 <h6><i class="bi bi-calculator text-primary me-1"></i>רווח נקי</h6>
                 <div class="stat-value ${netProfit >= 0 ? 'text-success' : 'text-danger'}">${formatPrice(netProfit)}</div>
               </div>
             </div>
           `;
           
           // שמירת הנתונים לשימוש בפונקציות אחרות
           window.dailySummaryData = summary;
           
           // יצירת גרף יוקרתי
           const dailyChartCanvas = document.getElementById('dailyChart');
           if (dailyChartCanvas) {
             createHistoryChart('daily', summary, dailyChartCanvas);
           }
         }
         
         // טעינת סיכום שבועי
         function loadWeeklySummary(date) {
           if (!date) date = new Date();
           
           // חישוב תחילת וסוף השבוע
           const weekRange = getWeekRange(date);
           currentHistoryWeek = weekRange;
           
           const kpiContainer = document.getElementById('weeklyKPI');
           
           // הוספת timeout למניעת תקיעות
           let weeklyTimeoutId = setTimeout(function() {
           if (kpiContainer) {
               kpiContainer.innerHTML = '<div class="alert alert-warning">הטעינה לוקחת זמן רב. נסה לרענן את הדף (F5) או לנסות שוב.</div>';
           }
           }, 30000); // 30 שניות
           
           google.script.run
             .withSuccessHandler(function(summary) {
               clearTimeout(weeklyTimeoutId);
               renderWeeklySummary(summary);
             })
             .withFailureHandler(function(error) {
               clearTimeout(weeklyTimeoutId);
               if (kpiContainer) {
                 kpiContainer.innerHTML = '<div class="alert alert-danger mt-3">שגיאה בטעינת הנתונים: ' + (error.message || 'נסה לרענן את הדף') + '</div>';
               }
             })
             .getWeeklySummary(weekRange.start, weekRange.end);
         }
         
         // רינדור סיכום שבועי
         function renderWeeklySummary(summary) {
           const kpiContainer = document.getElementById('weeklyKPI');
           if (!kpiContainer) return;
           
           const netProfit = summary.netProfit || 0;
           const totalRevenue = summary.totalRevenue || 0;
           const totalExpenses = summary.totalExpenses || 0;
           
           // עדכון תצוגת השבוע
           if (currentHistoryWeek) {
             const display = document.getElementById('selectedWeekDisplay');
             if (display) {
               display.textContent = `שבוע: ${currentHistoryWeek.start} - ${currentHistoryWeek.end}`;
             }
           }
           
           kpiContainer.innerHTML = `
             <div class="col-12 col-md-4">
               <div class="kpi-card">
                 <h6><i class="bi bi-arrow-up-circle text-success me-1"></i>סה"כ הכנסות</h6>
                 <div class="stat-value text-success">${formatPrice(totalRevenue)}</div>
               </div>
             </div>
             <div class="col-12 col-md-4">
               <div class="kpi-card">
                 <h6><i class="bi bi-arrow-down-circle text-danger me-1"></i>סה"כ הוצאות</h6>
                 <div class="stat-value text-danger">${formatPrice(totalExpenses)}</div>
               </div>
             </div>
             <div class="col-12 col-md-4">
               <div class="kpi-card">
                 <h6><i class="bi bi-calculator text-primary me-1"></i>רווח נקי</h6>
                 <div class="stat-value ${netProfit >= 0 ? 'text-success' : 'text-danger'}">${formatPrice(netProfit)}</div>
               </div>
             </div>
           `;
           
           window.weeklySummaryData = summary;
           
           // יצירת גרף יוקרתי
           createHistoryChart('weekly', summary, document.getElementById('weeklyChart'));
         }
         
         // טעינת סיכום חודשי
         function loadMonthlySummary(year, month) {
           currentHistoryMonth = { year: year, month: month };
           
           const kpiContainer = document.getElementById('monthlyKPI');
           
           // הוספת timeout למניעת תקיעות
           let monthlyTimeoutId = setTimeout(function() {
           if (kpiContainer) {
               kpiContainer.innerHTML = '<div class="alert alert-warning">הטעינה לוקחת זמן רב. נסה לרענן את הדף (F5) או לנסות שוב.</div>';
           }
           }, 30000); // 30 שניות
           
           google.script.run
             .withSuccessHandler(function(summary) {
               clearTimeout(monthlyTimeoutId);
               renderMonthlySummary(summary);
             })
             .withFailureHandler(function(error) {
               clearTimeout(monthlyTimeoutId);
               if (kpiContainer) {
                 kpiContainer.innerHTML = '<div class="alert alert-danger mt-3">שגיאה בטעינת הנתונים: ' + (error.message || 'נסה לרענן את הדף') + '</div>';
               }
             })
             .getMonthlySummary(year, month);
         }
         
         // רינדור סיכום חודשי
         function renderMonthlySummary(summary) {
           const kpiContainer = document.getElementById('monthlyKPI');
           if (!kpiContainer) return;
           
           const netProfit = summary.netProfit || 0;
           const totalRevenue = summary.totalRevenue || 0;
           const totalExpenses = summary.totalExpenses || 0;
           
           // עדכון תצוגת החודש
           if (currentHistoryMonth) {
             const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 
                                'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
             const display = document.getElementById('selectedMonthDisplay');
             if (display) {
               display.textContent = `${monthNames[currentHistoryMonth.month - 1]} ${currentHistoryMonth.year}`;
             }
           }
           
           kpiContainer.innerHTML = `
             <div class="col-12 col-md-4">
               <div class="kpi-card">
                 <h6><i class="bi bi-arrow-up-circle text-success me-1"></i>סה"כ הכנסות</h6>
                 <div class="stat-value text-success">${formatPrice(totalRevenue)}</div>
               </div>
             </div>
             <div class="col-12 col-md-4">
               <div class="kpi-card">
                 <h6><i class="bi bi-arrow-down-circle text-danger me-1"></i>סה"כ הוצאות</h6>
                 <div class="stat-value text-danger">${formatPrice(totalExpenses)}</div>
               </div>
             </div>
             <div class="col-12 col-md-4">
               <div class="kpi-card">
                 <h6><i class="bi bi-calculator text-primary me-1"></i>רווח נקי</h6>
                 <div class="stat-value ${netProfit >= 0 ? 'text-success' : 'text-danger'}">${formatPrice(netProfit)}</div>
               </div>
             </div>
           `;
           
           window.monthlySummaryData = summary;
           
           // יצירת גרף יוקרתי
           createHistoryChart('monthly', summary, document.getElementById('monthlyChart'));
         }
         
         // פונקציה להצגת/הסתרת פרטים (הגרף תמיד נראה)
         function toggleDetails(tabType) {
           const detailsContainer = document.getElementById(tabType + 'DetailsContainer');
           const chartContainer = document.getElementById(tabType + 'ChartContainer');
           
           if (!detailsContainer) return;
           
           const isVisible = detailsContainer.style.display !== 'none';
           
           if (isVisible) {
             detailsContainer.style.display = 'none';
             return;
           }
           
           // טעינת פרטים
           detailsContainer.style.display = 'block';
           detailsContainer.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
           
           let summaryData = null;
           let dateParam = null;
           
           if (tabType === 'daily' && window.dailySummaryData) {
             summaryData = window.dailySummaryData;
             dateParam = currentHistoryDate;
           } else if (tabType === 'weekly' && window.weeklySummaryData) {
             summaryData = window.weeklySummaryData;
             if (currentHistoryWeek) {
               dateParam = currentHistoryWeek.start + '|' + currentHistoryWeek.end;
             }
           } else if (tabType === 'monthly' && window.monthlySummaryData) {
             summaryData = window.monthlySummaryData;
             if (currentHistoryMonth) {
               dateParam = currentHistoryMonth.year + '-' + String(currentHistoryMonth.month).padStart(2, '0');
             }
           }
           
           if (!summaryData) {
             detailsContainer.innerHTML = '<div class="alert alert-warning">אין נתונים להצגה. אנא טען תחילה את הנתונים</div>';
             return;
           }
           
           // בניית טבלת פרטים - מכירות
           let html = '<div class="mb-4"><h6 class="fw-bold mb-3">מכירות:</h6>';
           html += '<div class="table-responsive"><table class="table table-hover table-striped"><thead class="table-light"><tr>';
           html += '<th>מוצר</th><th>קטגוריה</th><th>כמות</th><th>מחיר</th><th>סה"כ הכנסות</th></tr></thead><tbody>';
           
           let totalSalesQuantity = 0;
           let totalSalesRevenue = 0;
           
           if (summaryData.sales && summaryData.sales.items && summaryData.sales.items.length > 0) {
             summaryData.sales.items.forEach(function(sale) {
               const quantity = sale.quantity || 0;
               const price = sale.price || 0;
               const revenue = quantity * price;
               totalSalesQuantity += quantity;
               totalSalesRevenue += revenue;
               html += `<tr>
                 <td>${sale.itemName || 'ללא שם'}</td>
                 <td>${sale.category || '-'}</td>
                 <td>${quantity}</td>
                 <td>${formatPrice(price)}</td>
                 <td class="text-success">${formatPrice(revenue)}</td>
               </tr>`;
             });
           } else {
             html += '<tr><td colspan="5" class="text-center text-muted">אין מכירות</td></tr>';
           }
           
           html += `</tbody><tfoot class="table-light"><tr class="fw-bold">
             <td colspan="2">סה"כ מכירות</td>
             <td>${totalSalesQuantity}</td>
             <td>-</td>
             <td class="text-success">${formatPrice(totalSalesRevenue)}</td>
           </tr></tfoot></table></div></div>`;
           
           // בניית טבלת פרטים - קניות
           html += '<div class="mb-4"><h6 class="fw-bold mb-3">קניות (מהיבאון):</h6>';
           html += '<div class="table-responsive"><table class="table table-hover table-striped"><thead class="table-light"><tr>';
           html += '<th>מוצר</th><th>קטגוריה</th><th>כמות</th><th>מחיר קנייה</th><th>סה"כ הוצאות</th></tr></thead><tbody>';
           
           let totalPurchaseQuantity = 0;
           let totalPurchaseCost = 0;
           
           if (summaryData.addedItems && summaryData.addedItems.items && summaryData.addedItems.items.length > 0) {
             summaryData.addedItems.items.forEach(function(item) {
               const quantity = item.quantity || 0;
               const purchasePrice = item.purchasePrice || 0;
               const cost = quantity * purchasePrice;
               totalPurchaseQuantity += quantity;
               totalPurchaseCost += cost;
               html += `<tr>
                 <td>${item.itemName || 'ללא שם'}</td>
                 <td>${item.category || '-'}</td>
                 <td>${quantity}</td>
                 <td>${formatPrice(purchasePrice)}</td>
                 <td class="text-danger">${formatPrice(cost)}</td>
               </tr>`;
             });
           } else {
             html += '<tr><td colspan="5" class="text-center text-muted">אין קניות</td></tr>';
           }
           
           html += `</tbody><tfoot class="table-light"><tr class="fw-bold">
             <td colspan="2">סה"כ קניות</td>
             <td>${totalPurchaseQuantity}</td>
             <td>-</td>
             <td class="text-danger">${formatPrice(totalPurchaseCost)}</td>
           </tr></tfoot></table></div></div>`;
           
           // סיכום כללי
           const netProfit = (summaryData.totalRevenue || 0) - (summaryData.totalExpenses || 0);
           html += `<div class="alert alert-info">
             <h6 class="fw-bold mb-2">סיכום כללי:</h6>
             <div class="d-flex justify-content-between mb-1">
               <span>סה"כ הכנסות:</span>
               <strong class="text-success">${formatPrice(summaryData.totalRevenue || 0)}</strong>
             </div>
             <div class="d-flex justify-content-between mb-1">
               <span>סה"כ הוצאות:</span>
               <strong class="text-danger">${formatPrice(summaryData.totalExpenses || 0)}</strong>
             </div>
             <hr>
             <div class="d-flex justify-content-between">
               <span>רווח נקי:</span>
               <strong class="${netProfit >= 0 ? 'text-success' : 'text-danger'}" style="font-size: 1.2rem;">${formatPrice(netProfit)}</strong>
             </div>
           </div>`;
           
           detailsContainer.innerHTML = html;
           
           // יצירת גרף
           if (chartContainer) {
             chartContainer.style.display = 'block';
             createHistoryChart(tabType, summaryData, chartContainer.querySelector('canvas'));
           }
         }
         
         // יצירת גרף יוקרתי
         function createHistoryChart(tabType, summaryData, canvas) {
           if (!canvas) return;
           
           // הרס גרף קיים אם קיים
           if (window['historyChart_' + tabType]) {
             window['historyChart_' + tabType].destroy();
           }
           
           const ctx = canvas.getContext('2d');
           window['historyChart_' + tabType] = new Chart(ctx, {
             type: 'bar',
             data: {
               labels: ['הכנסות', 'הוצאות', 'רווח נקי'],
               datasets: [{
                 label: 'סכומים',
                 data: [
                   summaryData.totalRevenue || 0,
                   summaryData.totalExpenses || 0,
                   summaryData.netProfit || 0
                 ],
                 backgroundColor: [
                   'rgba(40, 167, 69, 0.85)',
                   'rgba(220, 53, 69, 0.85)',
                   'rgba(212, 165, 116, 0.85)'
                 ],
                 borderColor: [
                   'rgba(40, 167, 69, 1)',
                   'rgba(220, 53, 69, 1)',
                   'rgba(212, 165, 116, 1)'
                 ],
                 borderWidth: 3,
                 borderRadius: 8,
                 borderSkipped: false,
               }]
             },
             options: {
               responsive: true,
               maintainAspectRatio: true,
               aspectRatio: 2,
               plugins: {
                 legend: {
                   display: false
                 },
                 title: {
                   display: true,
                   text: 'סיכום פיננסי',
                   font: {
                     size: 18,
                     weight: 'bold',
                     family: 'Heebo'
                   },
                   padding: {
                     top: 10,
                     bottom: 20
                   },
                   color: '#333'
                 },
                 tooltip: {
                   backgroundColor: 'rgba(0, 0, 0, 0.8)',
                   padding: 12,
                   titleFont: {
                     size: 14,
                     weight: 'bold'
                   },
                   bodyFont: {
                     size: 13
                   },
                   callbacks: {
                     label: function(context) {
                       return '₪' + Math.abs(context.parsed.y).toLocaleString('he-IL');
                     }
                   }
                 }
               },
               scales: {
                 y: {
                   beginAtZero: true,
                   grid: {
                     color: 'rgba(0, 0, 0, 0.1)',
                     lineWidth: 1
                   },
                   ticks: {
                     callback: function(value) {
                       return '₪' + Math.abs(value).toLocaleString('he-IL');
                     },
                     font: {
                       size: 12,
                       family: 'Heebo'
                     },
                     color: '#666'
                   }
                 },
                 x: {
                   grid: {
                     display: false
                   },
                   ticks: {
                     font: {
                       size: 13,
                       weight: 'bold',
                       family: 'Heebo'
                     },
                     color: '#333'
                   }
                 }
               },
               animation: {
                 duration: 1500,
                 easing: 'easeInOutQuart'
               }
             }
           });
         }
         
         // פונקציה לקבלת טווח שבוע
         function getWeekRange(date) {
           const d = new Date(date);
           const day = d.getDay();
           const diff = d.getDate() - day + (day === 0 ? -6 : 1); // יום ראשון בשבוע
           const monday = new Date(d.setDate(diff));
           monday.setHours(0, 0, 0, 0);
           const sunday = new Date(monday);
           sunday.setDate(monday.getDate() + 6);
           sunday.setHours(23, 59, 59, 999);
           
           const formatDate = (d) => {
             return d.getFullYear() + '-' + 
               String(d.getMonth() + 1).padStart(2, '0') + '-' + 
               String(d.getDate()).padStart(2, '0');
           };
           
           return {
             start: formatDate(monday),
             end: formatDate(sunday)
           };
         }
         
         // יצוא לאקסל
         function exportHistoryToExcel(exportType) {
           let type = currentHistoryTab;
           let dateParam = null;
           
           if (type === 'daily') {
             dateParam = currentHistoryDate;
           } else if (type === 'weekly' && currentHistoryWeek) {
             dateParam = currentHistoryWeek.start + '|' + currentHistoryWeek.end;
           } else if (type === 'monthly' && currentHistoryMonth) {
             dateParam = currentHistoryMonth.year + '-' + String(currentHistoryMonth.month).padStart(2, '0');
           }
           
           if (!dateParam) {
             Swal.fire('שגיאה', 'אנא בחר תאריך/שבוע/חודש', 'error');
             return;
           }
           
           Swal.fire({
             title: 'מייצא לאקסל...',
             didOpen: () => { Swal.showLoading() },
             allowOutsideClick: false
           });
           
           google.script.run
             .withSuccessHandler(function(url) {
               Swal.fire({
                 icon: 'success',
                 title: 'הייצוא הושלם!',
                 text: 'הקובץ מוכן להורדה',
                 showCancelButton: true,
                 confirmButtonText: 'הורד קובץ',
                 cancelButtonText: 'סגור'
               }).then((result) => {
                 if (result.isConfirmed) {
                   window.open(url, '_blank');
                 }
               });
             })
             .withFailureHandler(function(error) {
               Swal.fire({icon: 'error', title: 'שגיאה', text: error.message});
             })
             .exportHistoryToExcel(type, dateParam, exportType);
         }
         
         // משתנים ללוחות שנה
         window.calendarCallbacks = {};
         
         // פונקציות ללוח שנה
         function renderCalendar(year, month, selectedDate, calendarId, onDateSelectCallback) {
           const calendarContainer = document.getElementById(calendarId);
           if (!calendarContainer) return;
           
           // שמירת הקולבק
           if (onDateSelectCallback) {
             window.calendarCallbacks[calendarId] = onDateSelectCallback;
           }
           
           const firstDay = new Date(year, month - 1, 1).getDay();
           const daysInMonth = new Date(year, month, 0).getDate();
           const today = new Date();
           const todayStr = today.getFullYear() + '-' + 
             String(today.getMonth() + 1).padStart(2, '0') + '-' + 
             String(today.getDate()).padStart(2, '0');
           
           const weekdays = ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'];
           const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 
                              'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
           
           let html = `
             <div class="calendar-header">
               <button class="calendar-nav-btn" onclick="changeMonth(-1, '${calendarId}')"><i class="bi bi-chevron-right"></i></button>
               <h6 class="mb-0">${monthNames[month - 1]} ${year}</h6>
               <button class="calendar-nav-btn" onclick="changeMonth(1, '${calendarId}')"><i class="bi bi-chevron-left"></i></button>
             </div>
             <div class="calendar-weekdays">
               ${weekdays.map(w => `<div class="calendar-weekday">${w}</div>`).join('')}
             </div>
             <div class="calendar-days">
           `;
           
           // ימים מחודש קודם
           const prevMonthDays = new Date(year, month - 1, 0).getDate();
           for (let i = firstDay - 1; i >= 0; i--) {
             const day = prevMonthDays - i;
             html += `<div class="calendar-day other-month">${day}</div>`;
           }
           
           // ימי החודש הנוכחי
           for (let day = 1; day <= daysInMonth; day++) {
             const dateStr = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
             const isSelected = selectedDate === dateStr;
             const isToday = dateStr === todayStr;
             let classes = 'calendar-day';
             if (isSelected) classes += ' selected';
             if (isToday && !isSelected) classes += ' today';
             
             // הוספת אפשרות לבחירת שבוע/חודש
             let onClickFunc = `selectDate('${dateStr}', '${calendarId}')`;
             if (calendarId === 'weeklyCalendar') {
               onClickFunc = `selectWeekFromDate('${dateStr}')`;
             } else if (calendarId === 'monthlyCalendar') {
               onClickFunc = `selectMonthFromDate('${dateStr}')`;
             }
             html += `<div class="${classes}" onclick="${onClickFunc}">${day}</div>`;
           }
           
           // ימים מחודש הבא
           const totalCells = firstDay + daysInMonth;
           const remainingCells = 42 - totalCells; // 6 שורות * 7 ימים
           for (let day = 1; day <= remainingCells; day++) {
             html += `<div class="calendar-day other-month">${day}</div>`;
           }
           
           html += '</div>';
           calendarContainer.innerHTML = html;
         }
         
         function changeMonth(delta, calendarId) {
           const container = document.getElementById(calendarId);
           if (!container) return;
           
           const header = container.querySelector('.calendar-header h6');
           if (!header) return;
           
           const text = header.textContent;
           const parts = text.split(' ');
           const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 
                              'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
           const monthIndex = monthNames.indexOf(parts[0]);
           const year = parseInt(parts[1]);
           
           let newMonth = monthIndex + 1 + delta;
           let newYear = year;
           
           if (newMonth < 1) {
             newMonth = 12;
             newYear--;
           } else if (newMonth > 12) {
             newMonth = 1;
             newYear++;
           }
           
           const selectedDate = currentHistoryDate || null;
           const callback = window.calendarCallbacks[calendarId];
           renderCalendar(newYear, newMonth, selectedDate, calendarId, callback);
         }
         
         function selectDate(dateStr, calendarId) {
           currentHistoryDate = dateStr;
           const datePicker = document.getElementById('dailyDatePicker');
           if (datePicker) datePicker.value = dateStr;
           
           const callback = window.calendarCallbacks[calendarId];
           if (callback) {
             callback(dateStr);
           } else if (calendarId === 'dailyCalendar') {
             loadDailySummary(dateStr);
           }
           
           // עדכון לוח השנה עם הסימון החדש
           const parts = dateStr.split('-');
           renderCalendar(parseInt(parts[0]), parseInt(parts[1]), dateStr, calendarId, callback);
         }
         
         
         // בחירת שבוע מתאריך
         function selectWeekFromDateInput() {
           const datePicker = document.getElementById('weeklyDatePicker');
           if (!datePicker || !datePicker.value) return;
           
           const date = new Date(datePicker.value + 'T00:00:00');
           const weekRange = getWeekRange(date);
           currentHistoryWeek = weekRange;
           
           // עדכון תצוגה
           const display = document.getElementById('selectedWeekDisplay');
           if (display) {
             display.textContent = `שבוע: ${weekRange.start} - ${weekRange.end}`;
           }
           
           // טעינת נתונים
           loadWeeklySummary(date);
         }
         
         // בחירת חודש מהקלט
         function selectMonthFromInput() {
           const datePicker = document.getElementById('monthlyDatePicker');
           if (!datePicker || !datePicker.value) return;
           
           const parts = datePicker.value.split('-');
           const year = parseInt(parts[0]);
           const month = parseInt(parts[1]);
           currentHistoryMonth = { year: year, month: month };
           
           // עדכון תצוגה
           const display = document.getElementById('selectedMonthDisplay');
           if (display) {
             const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 
                                'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
             display.textContent = `${monthNames[month - 1]} ${year}`;
           }
           
           // טעינת נתונים
           loadMonthlySummary(year, month);
         }
         
         
         
         document.addEventListener('DOMContentLoaded', function() {
           // הסתרת הבאנר התכלת של Google Apps Script - גרסה אגרסיבית מאוד
           function hideGoogleBanner() {
             try {
               // הסרת כל div בראש body ללא ID
               var bodyChildren = Array.from(document.body.children);
               bodyChildren.forEach(function(child) {
                 if (child && child.tagName === 'DIV') {
                   var hasId = child.id && child.id.length > 0;
                   var hasOurClass = child.classList.contains('navbar') || 
                                     child.classList.contains('container') || 
                                     child.classList.contains('content');
                   
                   if (!hasId && !hasOurClass) {
                     try {
                       var bg = window.getComputedStyle(child).backgroundColor;
                       var text = (child.textContent || '').toLowerCase();
                       var styleAttr = (child.getAttribute('style') || '').toLowerCase();
                       
                       if ((bg && (bg.includes('232') || bg.includes('240') || bg.includes('254'))) ||
                           text.includes('application was created') ||
                           text.includes('this application') ||
                           text.includes('learn more') ||
                           styleAttr.includes('e8f0fe')) {
                         child.remove();
                       }
                     } catch(e) {
                       // אם יש שגיאה, נסה להסיר בכל מקרה
                       if (!hasId) {
                         try {
                           child.remove();
                         } catch(e2) {}
                       }
                     }
                   }
                 }
               });
               
               // הסתרת כל div עם הטקסט של הבאנר
               const banners = document.querySelectorAll('div[aria-label*="application was created"], div[style*="e8f0fe"], div[style*="rgb(232, 240, 254)"], div[style*="rgb(240, 248, 255)"]');
               banners.forEach(banner => {
                 try {
                   var text = (banner.textContent || '').toLowerCase();
                   if (text.includes('this application was created') || 
                       text.includes('application was created') ||
                       text.includes('learn more')) {
                     banner.remove();
                   }
                 } catch(e) {}
               });
               
               // הסתרת אלמנטים שיש להם רקע תכלת
               document.querySelectorAll('div').forEach(div => {
                 try {
                   const style = window.getComputedStyle(div);
                   var bg = style.backgroundColor;
                   var text = (div.textContent || '').toLowerCase();
                   var hasId = div.id && div.id.length > 0;
                   var hasOurClass = div.classList.contains('navbar') || 
                                     div.classList.contains('container') || 
                                     div.classList.contains('content') ||
                                     div.classList.contains('card') ||
                                     div.classList.contains('modal');
                   
                   if (!hasId && !hasOurClass) {
                     if ((bg === 'rgb(232, 240, 254)' || bg === 'rgb(240, 248, 255)') ||
                         (bg && (bg.includes('232') || bg.includes('240') || bg.includes('254')))) {
                       if (text.includes('this application was created') || 
                           text.includes('application was created') ||
                           div.offsetHeight < 100) {
                         div.remove();
                       }
                     }
                   }
                 } catch(e) {}
               });
             } catch(e) {}
           }
           
           // ניסיון ראשוני להסתיר - מיד
           hideGoogleBanner();
           
           // ניסיון נוסף אחרי טעינה מלאה - יותר פעמים
           var delays = [0, 10, 20, 30, 50, 100, 200, 300, 500, 800, 1000, 1500, 2000];
           delays.forEach(function(delay) {
             setTimeout(hideGoogleBanner, delay);
           });
           
           // הסתרה מתמשכת (למקרה שהבאנר מופיע אחר כך) - כל 100ms
           setInterval(hideGoogleBanner, 100);
           
           itemModal = new bootstrap.Modal(document.getElementById('itemModal'));
           categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
           initApp();
         });
         
         function initApp() {
           // הצגת אינדיקטור טעינה
           const loader = document.getElementById('appLoader');
           if (loader) {
             loader.classList.remove('hidden');
           }
           
           google.script.run.withSuccessHandler(setupTabs).getSheetNames();
           currentSheet = '';
           loadData();
         }
         
         // פונקציה להסתרת אינדיקטור טעינה
         function hideLoader() {
           const loader = document.getElementById('appLoader');
           if (loader) {
             loader.classList.add('hidden');
             // הסרה מוחלטת אחרי האנימציה
             setTimeout(() => {
               if (loader) {
                 loader.style.display = 'none';
               }
             }, 300);
           }
         }
         
         
         function loadCategoriesMenu() {
           google.script.run.withSuccessHandler(function(sheetNames) {
             const container = document.getElementById('categoriesListMenu');
             
             // סינון גיליונות לא רצויים (אם יש כאלה)
             const hiddenCategories = ['כרטיסי קרבה ולקוחות', 'היסטוריית מכירות'];
             const filteredNames = sheetNames.filter(name => {
               if (hiddenCategories.includes(name)) return false;
               // הסתרת גיליונות זמניים של ייצוא
               if (name.startsWith('ייצוא_')) return false;
               return true;
             });
             
             let html = `
               <div class="category-list-item active" 
                    onclick="selectCategoryMenu('הכל', this, event)">
                 <span class="bs-cate-text"><i class="bi bi-grid me-1"></i>הכל</span>
                 <i class="bi bi-chevron-left"></i>
               </div>
             `;
             filteredNames.forEach((name) => {
               html += `
                 <div class="category-list-item" 
                      onclick="selectCategoryMenu('${name}', this, event)">
                   <span class="bs-cate-text">${name}</span>
                   <i class="bi bi-chevron-left"></i>
                 </div>
               `;
             });
             container.innerHTML = html;
             
             // טעינת כל המוצרים כברירת מחדל
             selectCategoryMenu('הכל', container.querySelector('.category-list-item'), null);
           }).getSheetNames();
         }
         
         function selectCategoryMenu(categoryName, element, event) {
           // מניעת סגירת התפריט
           if (event) {
             event.stopPropagation();
             event.preventDefault();
           }
           
           // עדכון הקטגוריה הפעילה ברשימה
           document.querySelectorAll('.category-list-item').forEach(item => {
             item.classList.remove('active');
           });
           if (element) element.classList.add('active');
           
           // עדכון כותרת התפריט
           const titleElement = document.getElementById('categoryMenuTitle');
           if (titleElement) {
             titleElement.innerText = categoryName === 'הכל' ? 'כל המוצרים' : categoryName;
           }
           
           // הצגת אינדיקטור טעינה מיידי
           const productsContainer = document.getElementById('allProductsInMenu');
           if (productsContainer) {
             productsContainer.innerHTML = `
               <div class="text-center text-muted py-5">
                 <div class="spinner-border spinner-border-sm mb-3" role="status" style="color: #D4A574;">
                   <span class="visually-hidden">טוען...</span>
                 </div>
                 <p class="mt-2 small">טוען מוצרים...</p>
               </div>
             `;
           }
           
           // טעינת כל המוצרים מהתוכנה
           google.script.run
             .withSuccessHandler(function(allItems) {
               // סינון לפי קטגוריה (אם צריך)
               const filteredItems = categoryName === 'הכל' 
                 ? allItems 
                 : allItems.filter(item => item.category === categoryName);
               
               renderProductsInMenu(filteredItems);
             })
             .withFailureHandler(function(error) {
               const productsContainer = document.getElementById('allProductsInMenu');
               if (productsContainer) {
                 productsContainer.innerHTML = `
                   <div class="text-center text-muted py-5">
                     <i class="bi bi-exclamation-triangle display-1 opacity-25"></i>
                     <p class="mt-3">שגיאה בטעינת הנתונים</p>
                     <small class="text-danger">${error.message || 'נסה לרענן את הדף'}</small>
                   </div>
                 `;
               }
             })
             .getAllItemsFromAllSheets();
         }
         
         function renderProductsInMenu(items) {
           const container = document.getElementById('allProductsInMenu');
           
           if (items.length === 0) {
             container.innerHTML = `
               <div class="text-center text-muted py-5">
                 <i class="bi bi-box display-1 opacity-25"></i>
                 <p class="mt-3">אין מוצרים בקטגוריה זו</p>
               </div>
             `;
             return;
           }
           
           // עיצוב איקונים מרובעים - grid בסגנון SHEIN
           let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px;">';
           items.forEach(item => {
             const itemNameSafe = (item.name || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
             const categorySafe = (item.category || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
             
             // אם יש תמונה, הצג אותה. אחרת, הצג אייקון
             const imageHtml = item.image 
               ? `<img src="${item.image}" style="width: 100%; height: 150px; object-fit: contain; background-color: #ffffff; padding: 5px; border-radius: 8px;" alt="${itemNameSafe}">`
               : `<div style="width: 100%; height: 150px; background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 2.5rem;"><i class="bi bi-image"></i></div>`;
             
             const itemData = JSON.stringify(item).replace(/'/g, "&#39;").replace(/"/g, "&quot;");
             html += `
               <div onclick="openProductFromCategory(${item.rowIndex}, '${categorySafe}')" 
                    class="product-card-square"
                    style="cursor: pointer; background: white; border-radius: 12px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; border: 2px solid transparent; overflow: hidden;">
                 ${imageHtml}
                 <div style="margin-top: 10px; text-align: center;">
                   <div style="font-size: 0.8rem; font-weight: 600; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%; line-height: 1.3;" title="${itemNameSafe}">${itemNameSafe}</div>
                   <div style="font-size: 0.75rem; color: #D4A574; font-weight: 700; margin-top: 6px;">${item.quantity} יח'</div>
                 </div>
               </div>
             `;
           });
           html += '</div>';
           container.innerHTML = html;
           
           // הוספת אפקט hover דרך CSS
           const style = document.createElement('style');
           style.textContent = `
             .product-card-square:hover {
               transform: translateY(-5px) !important;
               box-shadow: 0 6px 20px rgba(212, 165, 116, 0.4) !important;
               border-color: #D4A574 !important;
             }
           `;
           if (!document.getElementById('product-card-hover-style')) {
             style.id = 'product-card-hover-style';
             document.head.appendChild(style);
           }
         }
         
         // פתיחת מוצר לעריכה מתצוגת הקטגוריות
         function openProductFromCategory(rowIndex, category) {
           // מעבר לתצוגת המוצרים
           const itemsView = document.getElementById('itemsView');
           const navItems = document.getElementById('navItems');
           
           // הסתרת כל התצוגות
           document.querySelectorAll('.main-nav-menu .nav-link').forEach(link => {
             link.classList.remove('active');
           });
           const views = ['itemsView', 'statsView', 'profitsView', 'salesHistoryView', 'categoriesView', 'categoriesBrowseView'];
           views.forEach(viewId => {
             const element = document.getElementById(viewId);
             if (element) {
               element.classList.remove('active');
             }
           });
           
           // הצגת תצוגת המוצרים
           if (itemsView) {
             itemsView.classList.add('active');
           }
           if (navItems) navItems.classList.add('active');
           
           // הגדרת הקטגוריה
           currentSheet = category;
           
           // איפוס cache כדי לטעון נתונים מעודכנים
           invalidateCache(category);
           
           // טעינת הנתונים מהקטגוריה הספציפית
           google.script.run
             .withSuccessHandler(function(data) {
               renderItems(data);
               
               // פתיחת המודל לעריכה של המוצר
               setTimeout(function() {
                 // חיפוש המוצר לפי rowIndex
                 const item = data.find(function(item) {
                   return item.rowIndex === parseInt(rowIndex);
                 });
                 
                 if (item) {
                   // וידוא שהקטגוריה נשמרת במוצר
                   if (!item.category && category) {
                     item.category = category;
                   }
                   openModal('edit', item);
                 } else {
                   // אם לא נמצא, נסה לטעון מחדש
                   Swal.fire({
                     icon: 'warning',
                     title: 'מוצר לא נמצא',
                     text: 'המוצר לא נמצא בקטגוריה זו. נטען את הקטגוריה מחדש.',
                     confirmButtonColor: '#D4A574'
                   });
                   loadData();
                 }
               }, 500);
             })
             .withFailureHandler(function(error) {
               // שגיאה בטעינת מוצר - נציג הודעה למשתמש
               Swal.fire({
                 icon: 'error',
                 title: 'שגיאה',
                 text: error.message || 'לא ניתן לטעון את המוצר',
                 confirmButtonColor: '#D4A574'
               });
             })
             .getDataFromSheet(category || 'ללא קטגוריה');
         }
         
         function scrollToProductFromMenu(productName, category, rowIndex) {
           // הגדרת הקטגוריה לפני מעבר לתצוגה
           currentSheet = category;
           
           // מעבר לתצוגת המוצרים הרגילה (עכשיו עם הקטגוריה הנכונה)
           const itemsView = document.getElementById('itemsView');
           const navItems = document.getElementById('navItems');
           
           // הסתרת כל התצוגות
           document.querySelectorAll('.main-nav-menu .nav-link').forEach(link => {
             link.classList.remove('active');
           });
           const views = ['itemsView', 'statsView', 'profitsView', 'salesHistoryView', 'categoriesView', 'categoriesBrowseView'];
           views.forEach(viewId => {
             const element = document.getElementById(viewId);
             if (element) {
               element.classList.remove('active');
             }
           });
           
           // הצגת תצוגת המוצרים
           if (itemsView) {
             itemsView.classList.add('active');
           }
           if (navItems) navItems.classList.add('active');
           
           // טעינת הנתונים מהקטגוריה הספציפית
           document.getElementById('contentArea').innerHTML = `
             <div class="text-center mt-5">
               <div class="spinner-border" role="status" style="color: #D4A574;"></div>
               <p class="mt-2 text-muted">טוען נתונים...</p>
             </div>`;
           
           google.script.run
             .withSuccessHandler(function(data) {
               renderItems(data);
               
               // גלילה למוצר הספציפי אחרי שהרשימה נטענה
               setTimeout(function() {
                 const cards = document.querySelectorAll('.card-item');
                 let found = false;
                 cards.forEach(card => {
                   const cardTitle = card.querySelector('.card-title');
                   if (cardTitle && cardTitle.textContent.trim() === productName && !found) {
                     found = true;
                     // גלילה חלקה למוצר
                     card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     // הדגשה זמנית של הכרטיס
                     card.style.transition = 'all 0.3s ease';
                     card.style.boxShadow = '0 0 25px rgba(212, 165, 116, 0.9)';
                     card.style.transform = 'scale(1.08)';
                     card.style.zIndex = '1000';
                     
                     setTimeout(function() {
                       card.style.boxShadow = '';
                       card.style.transform = '';
                       card.style.zIndex = '';
                     }, 2500);
                   }
                 });
               }, 800);
             })
             .withFailureHandler(function(error) {
               // שגיאה בטעינת מוצר - נציג הודעה למשתמש
               Swal.fire({icon: 'error', title: 'שגיאה', text: 'לא ניתן לטעון את המוצר'});
             })
             .getDataFromSheet(category);
         }
         
         
         function setupTabs(sheetNames) {
           // הפונקציה הזו נקראת אחרי טעינת שמות הקטגוריות
           // לא צריך לעשות כלום כאן - loadData נקרא ב-initApp
         }
         
         function loadData() {
           const contentArea = document.getElementById('contentArea');
           const now = Date.now();
           
           // בדיקת cache - אם יש נתונים בטווח זמן קצר, נשתמש בהם
           if (dataCache.items && dataCache.timestamp && 
               (now - dataCache.timestamp) < dataCache.cacheTimeout &&
               dataCache.category === (currentSheet || 'all')) {
             // יש cache תקף - נשתמש בו
             renderItems(dataCache.items);
             // הסתרת אינדיקטור גם במקרה של cache
             hideLoader();
               return;
           }
           
           // טעינה מהירה - קריאה אחת בלבד
           const loadFunction = !currentSheet || currentSheet === '' 
             ? google.script.run
               .withSuccessHandler(function(data) {
               // שמירה ב-cache
                 dataCache.items = data;
                 dataCache.timestamp = Date.now();
                 dataCache.category = 'all';
               renderItems(data);
               })
               .withFailureHandler(function(error) {
                 // הסתרת אינדיקטור גם במקרה של שגיאה
                 hideLoader();
                 console.error('שגיאה בטעינת נתונים:', error);
               })
             : google.script.run
               .withSuccessHandler(function(data) {
                 // שמירה ב-cache
                 dataCache.items = data;
                 dataCache.timestamp = Date.now();
                 dataCache.category = currentSheet;
                 renderItems(data);
               })
               .withFailureHandler(function(error) {
                 // הסתרת אינדיקטור גם במקרה של שגיאה
                 hideLoader();
                 console.error('שגיאה בטעינת נתונים:', error);
               });
           
           if (!currentSheet || currentSheet === '') {
             loadFunction.getAllItemsFromAllSheets();
           } else {
             loadFunction.getDataFromSheet(currentSheet);
           }
         }
         
         function getTrafficLightHTML(status) {
           const s = parseInt(status) || 0;
           return `
             <div class="traffic-light-container" title="${statusLabels[s]}">
               <div class="dot dot-0 ${s === 0 ? 'active' : ''}"></div>
               <div class="dot dot-1 ${s === 1 ? 'active' : ''}"></div>
               <div class="dot dot-2 ${s === 2 ? 'active' : ''}"></div>
               <div class="dot dot-3 ${s === 3 ? 'active' : ''}"></div>
             </div>
           `;
         }
         
         function formatPrice(price) {
           if (price === null || price === undefined || price === '') return '0.00 ₪';
           const numPrice = parseFloat(price);
           if (isNaN(numPrice)) return '0.00 ₪';
           return numPrice.toFixed(2) + ' ₪';
         }
         
         function openImageViewer(imageSrc, event) {
           if(event) event.stopPropagation();
           
           const viewer = document.getElementById('imageViewer');
           const img = document.getElementById('fullImage');
           const hint = document.getElementById('viewerHint');
           
           img.src = imageSrc;
           
           viewer.classList.remove('active-zoom');
           viewer.style.display = 'flex'; 
           hint.innerText = 'לחץ להגדלה';
         }
         
         function closeImageViewer(event) {
           if(event && event.stopPropagation) event.stopPropagation();
           
           const viewer = document.getElementById('imageViewer');
           
           if (event && event.target && event.target.id === 'fullImage') return;
         
           viewer.style.display = 'none';
           viewer.classList.remove('active-zoom');
         }
         
         function toggleZoom(event) {
           if(event) event.stopPropagation();
           
           const viewer = document.getElementById('imageViewer');
           const hint = document.getElementById('viewerHint');
           
           viewer.classList.toggle('active-zoom');
           
           if (viewer.classList.contains('active-zoom')) {
             viewer.style.display = 'block'; 
             hint.innerText = 'גרור להזזה | לחץ להקטנה';
           } else {
             viewer.style.display = 'flex'; 
             hint.innerText = 'לחץ להגדלה';
           }
         }
         
         // משתנים ל-pagination
         let currentPage = 1;
         const itemsPerPage = 20; // 20 מוצרים בכל עמוד
         let filteredData = [];
         
         function renderItems(data) {
           allData = data;
           currentPage = 1; // איפוס לעמוד ראשון
           // עדכון רשימת הקטגוריות בסינון
           updateCategoryFilter();
           // הפעלת סינון ומיון
           filterItems();
           
           // הסתרת אינדיקטור טעינה אחרי שהנתונים נטענו
           hideLoader();
         }
         
         // פונקציה לעדכון כרטיסיה בודדת במקום לטעון מחדש את כל הרשימה
         function updateSingleItemCard(updatedItem, rowIndex, sourceCategory, targetCategory, imageData) {
           // אם הקטגוריה השתנתה, נטען מחדש את הרשימה (זה מורכב יותר)
           if (targetCategory !== sourceCategory) {
             invalidateCache('all');
             setTimeout(() => {
               loadData();
             }, 300);
             return;
           }
           
           // עדכון באותה קטגוריה - נמצא את הכרטיסיה ונעדכן אותה
           const cards = document.querySelectorAll('.card-item');
           let cardFound = false;
           
           // קביעת התמונה הסופית
           const finalImage = imageData || originalImageUrl || updatedItem.image;
           
           cards.forEach(card => {
             const cardElement = card.querySelector('[onclick*="openModal"]');
             if (cardElement) {
               try {
                 // ננסה למצוא את הכרטיסיה לפי ה-rowIndex
                 const onclickAttr = cardElement.getAttribute('onclick');
                 if (onclickAttr && onclickAttr.includes('rowIndex":' + rowIndex)) {
                   cardFound = true;
                   
                   // עדכון התמונה
                   const imgElement = card.querySelector('.card-img-top');
                   if (imgElement) {
                     if (finalImage) {
                       imgElement.src = finalImage;
                       imgElement.style.display = '';
                       // הסתרת placeholder אם יש
                       const placeholder = imgElement.nextElementSibling;
                       if (placeholder && placeholder.classList && placeholder.classList.contains('d-flex')) {
                         placeholder.style.display = 'none';
                       }
                     }
                   }
                   
                   // עדכון שם המוצר
                   const titleElement = card.querySelector('.card-title');
                   if (titleElement) {
                     titleElement.textContent = updatedItem.name;
                   }
                   
                   // עדכון הערות
                   const notesElement = card.querySelector('.card-text');
                   if (notesElement) {
                     notesElement.textContent = updatedItem.notes || '&nbsp;';
                   }
                   
                   // עדכון כמות במלאי
                   const quantityBadges = card.querySelectorAll('.badge');
                   quantityBadges.forEach(badge => {
                     if (badge.textContent && badge.textContent.includes('במלאי:')) {
                       badge.textContent = 'במלאי: ' + updatedItem.quantity;
                     }
                   });
                   
                   // עדכון מחיר
                   const priceElement = card.querySelector('.price-badge');
                   if (updatedItem.price && updatedItem.price > 0) {
                     if (priceElement) {
                       priceElement.textContent = formatPrice(updatedItem.price);
                     } else {
                       // אם אין אלמנט מחיר, נוסיף אותו
                       const priceDisplay = `<div class="mb-2"><span class="price-badge">${formatPrice(updatedItem.price)}</span></div>`;
                       const notesEl = card.querySelector('.card-text');
                       if (notesEl && notesEl.parentElement) {
                         notesEl.insertAdjacentHTML('beforebegin', priceDisplay);
                       }
                     }
                   } else if (priceElement && priceElement.parentElement) {
                     priceElement.parentElement.remove();
                   }
                   
                   // עדכון company badge
                   const companyBadge = card.querySelector('.company-badge');
                   if (updatedItem.company) {
                     if (companyBadge) {
                       companyBadge.textContent = updatedItem.company;
                     } else {
                       // הוספת company badge אם אין
                       const titleEl = card.querySelector('.card-title');
                       if (titleEl && titleEl.parentElement) {
                         titleEl.insertAdjacentHTML('afterend', `<span class="company-badge border">${updatedItem.company}</span>`);
                       }
                     }
                   } else if (companyBadge) {
                     companyBadge.remove();
                   }
                   
                   // עדכון ה-onclick עם הנתונים החדשים
                   updatedItem.rowIndex = rowIndex;
                   updatedItem.category = targetCategory;
                   updatedItem.image = finalImage;
                   updatedItem.soldQuantity = currentEditingItem ? (currentEditingItem.soldQuantity || 0) : 0;
                   const newOnclick = `openModal("edit", ${JSON.stringify(updatedItem).replace(/'/g, "&#39;")})`;
                   cardElement.setAttribute('onclick', newOnclick);
                   
                   // עדכון כפתור המכירה
                   const sellButton = card.querySelector('button[onclick*="sellItem"]');
                   if (sellButton) {
                     if (updatedItem.quantity > 0) {
                       sellButton.disabled = false;
                       sellButton.className = 'btn btn-sm w-100';
                       sellButton.style.cssText = 'background: linear-gradient(135deg, #4caf50, #388e3c); color: white; border: none;';
                       sellButton.innerHTML = '<i class="bi bi-cart-check me-1"></i>מכירה';
                       sellButton.setAttribute('onclick', `event.stopPropagation(); sellItem(${rowIndex}, '${(updatedItem.name || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;")}', '${targetCategory}')`);
                     } else {
                       sellButton.disabled = true;
                       sellButton.className = 'btn btn-sm w-100 btn-secondary';
                       sellButton.style.cssText = '';
                       sellButton.innerHTML = 'אין במלאי';
                       sellButton.removeAttribute('onclick');
                     }
                   }
                   
                   // עדכון הנתונים ב-allData
                   const dataIndex = allData.findIndex(d => d.rowIndex === rowIndex && (d.category === sourceCategory || !d.category));
                   if (dataIndex !== -1) {
                     allData[dataIndex] = {...allData[dataIndex], ...updatedItem, rowIndex: rowIndex, category: targetCategory, image: finalImage};
                   }
                 }
               } catch (e) {
                 // שגיאה בעדכון כרטיסיה - נטען מחדש
               }
             }
           });
           
           // אם לא מצאנו את הכרטיסיה, נטען מחדש את הרשימה (למקרה שהכרטיסיה לא נטענה עדיין)
           if (!cardFound) {
             invalidateCache(sourceCategory);
             setTimeout(() => {
               loadData();
             }, 300);
           }
         }
         
         // פונקציה להוספת מוצר חדש ישירות ל-DOM
         function addNewItemToDOM(item, category, imageUrl) {
           const container = document.getElementById('contentArea');
           if (!container) return;
           
           // אם הקטגוריה הנוכחית לא תואמת, לא נוסיף
           if (currentSheet && currentSheet !== '' && category !== currentSheet) {
             return; // המוצר לא שייך לקטגוריה הנוכחית
           }
           
           // תמיד נטען מחדש את הרשימה עם pagination נכון
           // זה מבטיח שהפריט החדש יופיע במקום הנכון והעמודים יעבדו נכון
             loadData();
             return;
         }
         
         function updateCategoryFilter() {
           const filterCategory = document.getElementById('filterCategory');
           if (!filterCategory) return;
           
           // איסוף כל הקטגוריות מהנתונים
           const categories = [...new Set(allData.map(item => item.category).filter(cat => cat))];
           categories.sort();
           
           // שמירת הערך הנוכחי
           const currentValue = filterCategory.value;
           
           // עדכון הרשימה
           filterCategory.innerHTML = '<option value="all">כל הקטגוריות</option>';
           categories.forEach(cat => {
             const option = document.createElement('option');
             option.value = cat;
             option.textContent = cat;
             filterCategory.appendChild(option);
           });
           
           // שחזור הערך הקודם אם הוא עדיין קיים
           if (currentValue && categories.includes(currentValue)) {
             filterCategory.value = currentValue;
           }
         }
         
         function renderList(data, page = 1) {
           const container = document.getElementById('contentArea');
           if (!data || data.length === 0) {
             container.innerHTML = '<div class="text-center mt-5 py-5"><i class="bi bi-inbox display-1 text-muted opacity-25"></i><p class="mt-3 text-muted">אין מוצרים להצגה</p></div>';
             return;
           }
           
           // עדכון רשימת הקטגוריות בסינון
           updateCategoryFilter();
         
           // חישוב pagination - וידוא שאנחנו מציגים בדיוק itemsPerPage פריטים
           const totalPages = Math.ceil(data.length / itemsPerPage);
           const startIndex = (page - 1) * itemsPerPage;
           const endIndex = Math.min(startIndex + itemsPerPage, data.length);
           let pageData = data.slice(startIndex, endIndex);
           currentPage = page;
           
           // וידוא שאנחנו מציגים בדיוק את מספר הפריטים הנכון (לא יותר מ-itemsPerPage)
           if (pageData.length > itemsPerPage) {
             console.warn('אזהרה: יותר מ-' + itemsPerPage + ' פריטים בעמוד! מציגים רק ' + itemsPerPage);
             pageData = pageData.slice(0, itemsPerPage);
           }
           
           // לוג לבדיקה
           console.log('Pagination Debug:', {
             totalItems: data.length,
             page: page,
             itemsPerPage: itemsPerPage,
             startIndex: startIndex,
             endIndex: endIndex,
             pageDataLength: pageData.length,
             totalPages: totalPages
           });
         
           let html = '<div class="row g-2">';
           pageData.forEach((item, index) => {
             const actualIndex = startIndex + index;
             
             let imgTag;
             if (item.image) {
               // lazy loading לתמונות - נטען רק כשהן נכנסות למסך
               imgTag = `<img src="${item.image}" class="card-img-top" alt="${item.name}" onclick="openImageViewer('${item.image}', event)" loading="lazy" decoding="async">`;
             } else {
               imgTag = `<div class="card-img-top d-flex align-items-center justify-content-center bg-light text-secondary"><i class="bi bi-image fs-1 opacity-25"></i></div>`;
             }
         
             const companyBadge = item.company 
                ? `<span class="company-badge border">${item.company}</span>` 
                : '';
         
             const sizeBadge = item.size && item.size.trim() !== ''
                ? `<span class="size-badge">${item.size}</span>` 
                : '';
         
             const priceDisplay = item.price && item.price > 0
                ? `<div class="mb-2"><span class="price-badge">${formatPrice(item.price)}</span></div>`
                : '';
         
             html += `
               <div class="col-6 col-md-4 col-lg-3">
                 <div class="card card-item h-100 shadow-sm position-relative">
                   <div onclick='openModal("edit", ${JSON.stringify(item).replace(/'/g, "&#39;")})' style="display: flex; flex-direction: column; height: 100%;">
                     ${imgTag}
                     <div class="card-body p-2 d-flex flex-column" style="flex: 1; min-height: 0;">
                       
                       <div class="d-flex justify-content-between align-items-start mb-1 gap-1">
                         <h6 class="card-title fw-bold text-dark mb-0 text-truncate" style="flex: 1;">${item.name}</h6>
                         ${companyBadge}
                       </div>
         
                       ${sizeBadge ? `<div class="mb-2">${sizeBadge}</div>` : ''}
         
                       ${priceDisplay}
         
                       <p class="card-text text-muted small text-truncate mb-2" style="font-size: 0.75rem; min-height: 1.2em;">
                         ${item.notes || '&nbsp;'}
                       </p>
         
                       <div class="mt-auto border-top pt-2" style="margin-top: auto !important;">
                         <div class="d-flex justify-content-between align-items-center mb-2">
                           <span class="badge rounded-pill fw-bold" style="font-size: 0.8rem; background: #D4A574; color: white;">
                             במלאי: ${item.quantity}
                           </span>
                           ${item.soldQuantity > 0 ? `<span class="badge rounded-pill fw-bold" style="font-size: 0.75rem; background: rgba(212, 165, 116, 0.2); color: #8d6e63;">
                             נמכר: ${item.soldQuantity}
                           </span>` : ''}
                         </div>
                         ${item.quantity > 0 ? `                      <button class="btn btn-sm w-100" style="background: #4caf50; color: white; border: none;" onclick="event.stopPropagation(); sellItem(${item.rowIndex}, '${(item.name || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;")}', '${item.category || currentSheet}')">
                           <i class="bi bi-cart-check me-1"></i>מכירה
                         </button>` : '<button class="btn btn-sm w-100 btn-secondary" disabled>אין במלאי</button>'}
                       </div>
                     </div>
                   </div>
                 </div>
               </div>
             `;
           });
           html += '</div>';
           
           // הוספת pagination אם יש יותר מ-itemsPerPage מוצרים
           if (data.length > itemsPerPage) {
             const pageNumbers = getPageNumbers(page, totalPages);
             
             html += `
               <div class="pagination-wrapper mt-4 mb-3">
                 <div class="d-flex justify-content-between align-items-center w-100 mb-3">
                 <div class="text-muted small">
                     <i class="bi bi-info-circle me-1"></i>מציג ${startIndex + 1}-${endIndex} מתוך ${data.length} מוצרים
                 </div>
                   <div class="text-muted small">
                         עמוד ${page} מתוך ${totalPages}
                   </div>
                 </div>
                 
                 <div class="ali-pagination-container">
                   <!-- כפתור קודם -->
                   <button 
                     class="ali-pagination-btn ${page === 1 ? 'disabled' : ''}" 
                     onclick="changePage(${page - 1})"
                     ${page === 1 ? 'disabled' : ''}
                     title="עמוד קודם">
                     <i class="bi bi-chevron-right"></i>
                     <span class="d-none d-sm-inline ms-1">קודם</span>
                   </button>
                   
                   <!-- מספרי עמודים -->
                   ${pageNumbers.map((pageNum, idx) => {
                     if (pageNum === '...') {
                       return `<span class="ali-pagination-ellipsis">...</span>`;
                     }
                     const isActive = pageNum === page;
                     return `
                       <button 
                         class="ali-pagination-btn ${isActive ? 'active' : ''}" 
                         onclick="changePage(${pageNum})"
                         ${isActive ? 'disabled' : ''}
                         title="עמוד ${pageNum}">
                         ${pageNum}
                       </button>
                     `;
                   }).join('')}
                   
                   <!-- כפתור הבא -->
                   <button 
                     class="ali-pagination-btn ${page === totalPages ? 'disabled' : ''}" 
                     onclick="changePage(${page + 1})"
                     ${page === totalPages ? 'disabled' : ''}
                     title="עמוד הבא">
                     <span class="d-none d-sm-inline me-1">הבא</span>
                     <i class="bi bi-chevron-left"></i>
                   </button>
                   
                   <!-- קפיצה לעמוד מסוים -->
                   <div class="ali-pagination-jump">
                     <span class="ali-pagination-jump-text">קפוץ ל:</span>
                     <input 
                       type="number" 
                       id="jumpToPageInput" 
                       class="ali-pagination-input" 
                       min="1" 
                       max="${totalPages}" 
                       value="${page}"
                       onkeypress="if(event.key === 'Enter') { const pageNum = parseInt(this.value); if(pageNum >= 1 && pageNum <= ${totalPages}) changePage(pageNum); }"
                       title="הקש Enter לקפיצה לעמוד">
                   </div>
                 </div>
               </div>
             `;
           }
           
           container.innerHTML = html;
           
           // גלילה חלקה לראש אזור התוכן אחרי טעינה (רק אם זה לא אותו עמוד)
           if (page !== currentPage) {
             setTimeout(function() {
               const contentArea = document.getElementById('contentArea');
               if (contentArea) {
                 contentArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
               }
             }, 100);
           }
         }
         
         // פונקציה לחישוב אילו מספרי עמודים להציג (עם elipsis בסגנון AliExpress)
         function getPageNumbers(currentPage, totalPages) {
           const pages = [];
           const maxVisible = 7; // מספר מקסימלי של כפתורים להצגה
           
           if (totalPages <= maxVisible) {
             // אם יש מעט עמודים, הצג את כולם
             for (let i = 1; i <= totalPages; i++) {
               pages.push(i);
             }
           } else {
             // הצג עמוד ראשון
             pages.push(1);
             
             if (currentPage <= 3) {
               // אם אנחנו קרוב להתחלה, הצג 1,2,3,4,...
               for (let i = 2; i <= 4; i++) {
                 pages.push(i);
               }
               pages.push('...');
               pages.push(totalPages);
             } else if (currentPage >= totalPages - 2) {
               // אם אנחנו קרוב לסוף, הצג ..., N-3, N-2, N-1, N
               pages.push('...');
               for (let i = totalPages - 3; i <= totalPages; i++) {
                 pages.push(i);
               }
             } else {
               // אם אנחנו באמצע, הצג 1, ..., current-1, current, current+1, ..., N
               pages.push('...');
               for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                 pages.push(i);
               }
               pages.push('...');
               pages.push(totalPages);
             }
           }
           
           return pages;
         }
         
         function changePage(newPage) {
           if (newPage < 1) return;
           const dataToRender = filteredData.length > 0 ? filteredData : allData;
           const totalPages = Math.ceil(dataToRender.length / itemsPerPage);
           if (newPage > totalPages) return;
           
           // עדכון העמוד הנוכחי לפני הרינדור
           const oldPage = currentPage;
           renderList(dataToRender, newPage);
           
           // עדכון שדה הקלט לאחר מעבר עמוד (אם הוא קיים)
           setTimeout(function() {
           const jumpInput = document.getElementById('jumpToPageInput');
           if (jumpInput) {
             jumpInput.value = newPage;
           }
           }, 100);
         }
         
         // פונקציה לקפיצה לעמוד ספציפי
         function handlePageJump(event, totalPages) {
           if (event.key === 'Enter') {
             const input = event.target;
             const pageNumber = parseInt(input.value);
             if (pageNumber >= 1 && pageNumber <= totalPages) {
               changePage(pageNumber);
             } else {
               // אם המספר לא תקין, נחזיר את הערך הקודם
               input.value = currentPage;
               Swal.fire({
                 title: 'מספר עמוד לא תקין',
                 text: `אנא הזן מספר בין 1 ל-${totalPages}`,
                 icon: 'warning',
                 timer: 2000,
                 showConfirmButton: false
               });
             }
           }
         }
         
         function filterItems() {
             const term = document.getElementById('searchInput')?.value.toLowerCase().trim() || '';
             const sortBy = document.getElementById('sortBy')?.value || 'all';
             const filterStock = document.getElementById('filterStock')?.value || 'all';
             const filterImage = document.getElementById('filterImage')?.value || 'all';
             const filterCategory = document.getElementById('filterCategory')?.value || 'all';
             
             // סינון בסיסי לפי חיפוש
             let filtered = allData.filter(item => {
               // חיפוש טקסט
               const matchesSearch = term === '' || 
               item.name.toLowerCase().includes(term) ||
               (item.company && item.company.toLowerCase().includes(term)) ||
               (item.notes && item.notes.toLowerCase().includes(term)) ||
                 (item.category && item.category.toLowerCase().includes(term)) ||
                 (item.size && item.size.toLowerCase().includes(term));
               
               // סינון לפי מלאי
               const quantity = parseInt(item.quantity) || 0;
               let matchesStock = true;
               if (filterStock === 'in-stock') matchesStock = quantity > 0;
               else if (filterStock === 'out-of-stock') matchesStock = quantity === 0;
               else if (filterStock === 'low-stock') matchesStock = quantity > 0 && quantity < 5;
               else if (filterStock === 'zero') matchesStock = quantity === 0;
               
               // סינון לפי תמונה
               let matchesImage = true;
               if (filterImage === 'with-image') matchesImage = item.image && item.image.trim() !== '';
               else if (filterImage === 'no-image') matchesImage = !item.image || item.image.trim() === '';
               
               // סינון לפי קטגוריה
               let matchesCategory = true;
               if (filterCategory !== 'all') matchesCategory = item.category === filterCategory;
               
               return matchesSearch && matchesStock && matchesImage && matchesCategory;
             });
             
             // מיון - רק אם לא נבחר "הכל"
             if (sortBy !== 'all') {
             filtered.sort((a, b) => {
               let aVal, bVal;
               
               if (sortBy.startsWith('name')) {
                 aVal = (a.name || '').toLowerCase();
                 bVal = (b.name || '').toLowerCase();
                 return sortBy.includes('desc') ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
               } else if (sortBy.startsWith('sold')) {
                 aVal = parseInt(a.soldQuantity) || 0;
                 bVal = parseInt(b.soldQuantity) || 0;
                 return sortBy.includes('desc') ? aVal - bVal : bVal - aVal;
               } else if (sortBy.startsWith('quantity')) {
                 aVal = parseInt(a.quantity) || 0;
                 bVal = parseInt(b.quantity) || 0;
                 return sortBy.includes('desc') ? aVal - bVal : bVal - aVal;
               } else if (sortBy.startsWith('price')) {
                 aVal = parseFloat(a.price) || 0;
                 bVal = parseFloat(b.price) || 0;
                 return sortBy.includes('desc') ? aVal - bVal : bVal - aVal;
               } else if (sortBy.startsWith('profit')) {
                 // רווח = (מחיר מכירה - מחיר קנייה) * כמות נמכרת
                 const aProfit = ((parseFloat(a.price) || 0) - (parseFloat(a.purchasePrice) || 0)) * (parseInt(a.soldQuantity) || 0);
                 const bProfit = ((parseFloat(b.price) || 0) - (parseFloat(b.purchasePrice) || 0)) * (parseInt(b.soldQuantity) || 0);
                 return sortBy.includes('desc') ? aProfit - bProfit : bProfit - aProfit;
               } else if (sortBy.startsWith('value')) {
                 // ערך כולל = מחיר * כמות במלאי
                 aVal = (parseFloat(a.price) || 0) * (parseInt(a.quantity) || 0);
                 bVal = (parseFloat(b.price) || 0) * (parseInt(b.quantity) || 0);
                 return sortBy.includes('desc') ? aVal - bVal : bVal - aVal;
               }
               return 0;
             });
             }
             
             filteredData = filtered;
             
             renderList(filteredData, 1);
         }
         
         function handleImageSelect(input) {
           if (input.files && input.files[0]) {
             const file = input.files[0];
             if (!file.type.match('image.*')) {
               Swal.fire('שגיאה', 'אנא בחר קובץ תמונה בלבד', 'error');
               return;
             }
         
             const reader = new FileReader();
             reader.onload = function(event) {
               originalImageForEdit = event.target.result;
               openImageEditor(event.target.result);
             }
             reader.readAsDataURL(file);
           }
         }
         
         function openImageEditor(imageSrc) {
           if (!imageEditorModal) {
             const modalElement = document.getElementById('imageEditorModal');
             imageEditorModal = new bootstrap.Modal(modalElement);
             
             // ניקוי בעת סגירת ה-modal
             modalElement.addEventListener('hidden.bs.modal', function() {
               if (imageEditor) {
                 imageEditor.destroy();
                 imageEditor = null;
               }
               originalImageForEdit = null;
             });
           }
           
           const imageElement = document.getElementById('imageToEdit');
           imageElement.src = imageSrc;
           
           // סגירת עורך קודם אם קיים
           if (imageEditor) {
             imageEditor.destroy();
             imageEditor = null;
           }
           
           // פתיחת ה-modal
           imageEditorModal.show();
           
           // אתחול Cropper אחרי שה-modal נפתח
           setTimeout(() => {
             imageEditor = new Cropper(imageElement, {
               aspectRatio: NaN, // ללא יחס גובה-רוחב קבוע
               viewMode: 1,
               dragMode: 'move',
               autoCropArea: 0.8,
               restore: false,
               guides: true,
               center: true,
               highlight: false,
               cropBoxMovable: true,
               cropBoxResizable: true,
               toggleDragModeOnDblclick: false,
               responsive: true,
               ready: function() {
                 // התמונה מוכנה לעריכה
               }
             });
           }, 300);
         }
         
         function rotateImage(degrees) {
           if (imageEditor) {
             imageEditor.rotate(degrees);
           }
         }
         
         function resetImage() {
           if (imageEditor && originalImageForEdit) {
             imageEditor.destroy();
             const imageElement = document.getElementById('imageToEdit');
             imageElement.src = originalImageForEdit;
             setTimeout(() => {
               imageEditor = new Cropper(imageElement, {
                 aspectRatio: NaN,
                 viewMode: 1,
                 dragMode: 'move',
                 autoCropArea: 0.8,
                 restore: false,
                 guides: true,
                 center: true,
                 highlight: false,
                 cropBoxMovable: true,
                 cropBoxResizable: true,
                 toggleDragModeOnDblclick: false,
                 responsive: true
               });
             }, 100);
           }
         }
         
         function saveEditedImage() {
           if (!imageEditor) {
             Swal.fire('שגיאה', 'אין תמונה לעריכה', 'error');
             return;
           }
         
           // קבלת התמונה המעובדת
           const canvas = imageEditor.getCroppedCanvas({
             maxWidth: 800,
             maxHeight: 800,
             imageSmoothingEnabled: true,
             imageSmoothingQuality: 'high'
           });
         
           if (!canvas) {
             Swal.fire('שגיאה', 'לא ניתן לעבד את התמונה', 'error');
             return;
           }
         
           // המרה ל-base64 עם דחיסה
           const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
         
           // עדכון התצוגה המקדימה
                 const preview = document.getElementById('imagePreviewContainer');
                 preview.style.backgroundImage = `url(${compressedDataUrl})`;
                 preview.style.backgroundColor = '#ffffff';
                 preview.classList.add('has-image');
                 currentImageBase64 = compressedDataUrl;
           
           // הצגת כפתור עריכה
           const editButtonContainer = document.getElementById('editImageButtonContainer');
           if (editButtonContainer) {
             editButtonContainer.style.display = 'block';
           }
         
           // סגירת ה-modal
           imageEditorModal.hide();
           
           // ניקוי
           if (imageEditor) {
             imageEditor.destroy();
             imageEditor = null;
           }
           originalImageForEdit = null;
         }
         
         function editCurrentImage() {
           // קבלת התמונה הנוכחית
           const preview = document.getElementById('imagePreviewContainer');
           const currentImageSrc = preview.style.backgroundImage;
           
           let imageToEdit = null;
           
           if (currentImageSrc && currentImageSrc !== 'none') {
             // הסרת url() מהמחרוזת
             imageToEdit = currentImageSrc.replace('url("', '').replace('")', '').replace('url(', '').replace(')', '').replace(/"/g, '');
           } else if (currentImageBase64) {
             imageToEdit = currentImageBase64;
           } else if (originalImageUrl) {
             imageToEdit = originalImageUrl;
           }
           
           if (!imageToEdit) {
             Swal.fire('שגיאה', 'אין תמונה לעריכה', 'error');
             return;
           }
           
           // אם זה URL חיצוני (לא base64), נמיר אותו ל-base64
           if (imageToEdit.startsWith('http://') || imageToEdit.startsWith('https://')) {
             // טעינת התמונה והמרה ל-base64
             const img = new Image();
             img.crossOrigin = 'anonymous';
             img.onload = function() {
               const canvas = document.createElement('canvas');
               canvas.width = img.width;
               canvas.height = img.height;
               const ctx = canvas.getContext('2d');
               ctx.drawImage(img, 0, 0);
               const base64 = canvas.toDataURL('image/jpeg', 0.9);
               openImageEditor(base64);
             };
             img.onerror = function() {
               // אם לא ניתן לטעון את התמונה, ננסה לפתוח אותה ישירות
               openImageEditor(imageToEdit);
             };
             img.src = imageToEdit;
           } else {
             // זה כבר base64 או data URL
             openImageEditor(imageToEdit);
           }
         }
         
         function cancelImageEdit() {
           if (imageEditorModal) {
             imageEditorModal.hide();
           }
           if (imageEditor) {
             imageEditor.destroy();
             imageEditor = null;
           }
           originalImageForEdit = null;
         }
         
         function selectStatus(index) {
           document.getElementById('itemStatus').value = index;
           document.getElementById('statusText').innerText = statusLabels[index];
           document.querySelectorAll('.status-option').forEach(el => el.classList.remove('selected'));
           document.getElementById('opt-' + index).classList.add('selected');
         }
         
         function openModal(mode, item = null) {
           // איפוס משתני תמונה
           document.getElementById('imagePreviewContainer').style.backgroundImage = '';
           document.getElementById('imagePreviewContainer').classList.remove('has-image');
           document.getElementById('itemImageInput').value = ''; 
           currentImageBase64 = null;
           originalImageUrl = null; // איפוס תמונה מקורית
           const editButtonContainer = document.getElementById('editImageButtonContainer');
           if (editButtonContainer) {
             editButtonContainer.style.display = 'none';
           }
         
           const title = document.getElementById('modalTitle');
           const rowIndex = document.getElementById('itemRowIndex');
           const name = document.getElementById('itemName');
           const qty = document.getElementById('itemQuantity');
           const company = document.getElementById('itemCompany');
           const price = document.getElementById('itemPrice');
           const purchasePrice = document.getElementById('itemPurchasePrice');
           const size = document.getElementById('itemSize');
           const notes = document.getElementById('itemNotes');
           
           // טעינת קטגוריות
           loadCategoriesForSelect();
           
           const deleteButtonContainer = document.getElementById('deleteItemButtonContainer');
           
           if (mode === 'add') {
             title.innerText = 'הוסף מוצר';
             // איפוס הפריט המקורי בעת הוספה
             currentEditingItem = null;
             originalCategory = null;
             
             rowIndex.value = '';
             name.value = '';
             qty.value = '';
             company.value = '';
             price.value = '';
             purchasePrice.value = '';
             size.value = '';
             notes.value = '';
             document.getElementById('itemCategory').value = currentSheet || '';
             document.getElementById('newCategoryInput').style.display = 'none';
             // הסתרת כפתור המחיקה בעת הוספת פריט חדש
             if (deleteButtonContainer) deleteButtonContainer.style.display = 'none';
             
             // הסתרת כפתור "עדכן רק שינויים" בעת הוספת פריט חדש
             const updateButtonContainer = document.getElementById('updateButtonContainer');
             if (updateButtonContainer) {
               updateButtonContainer.style.display = 'none';
             }
           } else {
             title.innerText = 'ערוך מוצר';
             // שמירת הפריט המקורי לעדכון soldQuantity
             currentEditingItem = item;
             // שמירת הקטגוריה המקורית של הפריט - חשוב לשמור את הקטגוריה המקורית
             originalCategory = item.category || currentSheet || null;
             
             rowIndex.value = item.rowIndex;
             name.value = item.name;
             qty.value = item.quantity;
             company.value = item.company || '';
             price.value = item.price || '';
             purchasePrice.value = item.purchasePrice || '';
             size.value = item.size || '';
             notes.value = item.notes || '';
             // קביעת הקטגוריה הנוכחית לפי item.category (הקטגוריה המקורית)
             // חשוב: נשמור את הקטגוריה המקורית גם אם היא ריקה
             const categorySelect = document.getElementById('itemCategory');
             if (categorySelect) {
               // נשתמש בקטגוריה מהמוצר, ואם אין - בקטגוריה הנוכחית
               const categoryToSet = item.category || currentSheet || '';
               categorySelect.value = categoryToSet;
               // אם הקטגוריה לא נטענה מהמוצר, נשמור את הקטגוריה הנוכחית
               if (!item.category && currentSheet) {
                 originalCategory = currentSheet;
               } else if (item.category) {
                 originalCategory = item.category;
               }
             }
             document.getElementById('newCategoryInput').style.display = 'none';
             // הצגת כפתור המחיקה בעת עריכת פריט
             if (deleteButtonContainer) deleteButtonContainer.style.display = 'block';
             // שמירת פרטי הפריט למחיקה
             deleteButtonContainer.setAttribute('data-item-row', item.rowIndex);
             deleteButtonContainer.setAttribute('data-item-name', item.name);
             deleteButtonContainer.setAttribute('data-item-category', item.category || currentSheet);
             
             // הצגת כפתור "עדכן רק שינויים"
             const updateButtonContainer = document.getElementById('updateButtonContainer');
             if (updateButtonContainer) {
               updateButtonContainer.style.display = 'block';
             }
         
             // שמירת התמונה המקורית
             if (item.image) {
               originalImageUrl = item.image; // שמירת URL התמונה המקורית
               const preview = document.getElementById('imagePreviewContainer');
               preview.style.backgroundImage = `url(${item.image})`;
               preview.style.backgroundColor = '#ffffff';
               preview.classList.add('has-image');
               // הצגת כפתור עריכה
               const editButtonContainer = document.getElementById('editImageButtonContainer');
               if (editButtonContainer) {
                 editButtonContainer.style.display = 'block';
               }
               // שמירת התמונה גם ב-currentImageBase64 אם זה base64
               if (item.image.startsWith('data:image')) {
                 currentImageBase64 = item.image;
               }
             } else {
               originalImageUrl = null;
               const editButtonContainer = document.getElementById('editImageButtonContainer');
               if (editButtonContainer) {
                 editButtonContainer.style.display = 'none';
               }
             }
           }
           itemModal.show();
         }
         
         // משתנה לשמירת הפריט המקורי בעת עריכה
         let currentEditingItem = null;
         let originalCategory = null; // שמירת הקטגוריה המקורית
         let originalImageUrl = null; // שמירת התמונה המקורית
         
         function submitItem() {
           const rowIndex = document.getElementById('itemRowIndex').value;
           const categorySelect = document.getElementById('itemCategory');
           let category = categorySelect ? categorySelect.value : '';
           
           // אם אין קטגוריה נבחרת, נשתמש בקטגוריה המקורית (אם יש)
           if (!category || category === '') {
             if (originalCategory) {
               category = originalCategory;
             } else if (currentSheet) {
               category = currentSheet;
             } else {
             Swal.fire('שגיאה', 'חובה לבחור קטגוריה', 'error');
             return;
             }
           }
           
           // קביעת קטגוריה סופית - אם זה עדכון ולא נבחרה קטגוריה, נשתמש במקורית
           let finalCategory = category;
           if (!finalCategory || finalCategory === '') {
             if (rowIndex && originalCategory) {
               // זה עדכון - נשתמש בקטגוריה המקורית
               finalCategory = originalCategory;
             } else if (currentSheet) {
               // נשתמש בקטגוריה הנוכחית
               finalCategory = currentSheet;
             }
           }
           
           const item = {
             name: document.getElementById('itemName').value,
             quantity: document.getElementById('itemQuantity').value,
             notes: document.getElementById('itemNotes').value,
             company: document.getElementById('itemCompany').value,
             status: parseInt(document.getElementById('itemStatus').value),
             price: parseFloat(document.getElementById('itemPrice').value) || 0,
             purchasePrice: parseFloat(document.getElementById('itemPurchasePrice').value) || 0,
             // שמירת הערך הקיים של soldQuantity בעת עדכון, או 0 בעת הוספה
             soldQuantity: currentEditingItem ? (currentEditingItem.soldQuantity || 0) : 0,
             category: finalCategory
           };
         
           if(!item.name) {
              Swal.fire('שגיאה', 'חובה להזין שם', 'error');
              return;
           }
         
           itemModal.hide();
           
           // הוספת timeout למניעת תקיעות
           let timeoutId = setTimeout(() => {
             Swal.fire({
               icon: 'warning',
               title: 'התהליך לוקח זמן...',
               text: 'אם זה נמשך יותר מדקה, נסה לרענן את הדף',
               showConfirmButton: true,
               confirmButtonText: 'אישור'
             });
           }, 30000); // 30 שניות
           
           let requestStarted = false;
           Swal.fire({
             title: 'שומר נתונים...',
             didOpen: () => { Swal.showLoading() },
             allowOutsideClick: false,
             allowEscapeKey: false,
             didOpen: () => {
               Swal.showLoading();
               requestStarted = true;
             }
           });
         
           const onSuccess = (response) => {
             clearTimeout(timeoutId);
             if (Swal.isVisible()) {
               Swal.close();
             }
             Swal.fire({icon: 'success', title: response.message || 'המוצר נשמר בהצלחה!', timer: 1500, showConfirmButton: false});
             
             // אם זה עדכון מוצר קיים, נעדכן רק את הכרטיסיה הספציפית
             if (rowIndex && sourceCategory) {
               // עדכון רק את הכרטיסיה הספציפית
               updateSingleItemCard(item, rowIndex, sourceCategory, targetCategory, imageToSend);
               // איפוס cache רק לקטגוריה הספציפית
               invalidateCache(sourceCategory);
               if (targetCategory !== sourceCategory) {
                 invalidateCache(targetCategory);
               }
             } else {
               // הוספה חדשה - נוסיף את המוצר החדש ישירות ל-DOM עם rowIndex החדש
               if (response && response.rowIndex) {
                 item.rowIndex = response.rowIndex;
               }
               addNewItemToDOM(item, targetCategory, imageToSend);
             }
           };
         
           const onFailure = (error) => {
             clearTimeout(timeoutId);
             // שגיאה בהוספת/עדכון מוצר - ההודעה מוצגת למשתמש ב-Swal
             if (Swal.isVisible()) {
               Swal.close();
             }
             Swal.fire({
               icon: 'error', 
               title: 'שגיאה', 
               html: '<div style="text-align: right; direction: rtl;">' + 
                     (error.message || 'אירעה שגיאה. נסה שוב או רענן את הדף.') + 
                     '<br><br><small>אם הבעיה נמשכת, נסה לרענן את הדף (F5)</small></div>',
               confirmButtonText: 'אישור',
               confirmButtonColor: '#D4A574',
               allowOutsideClick: true
             });
           };
         
           // קביעת קטגוריה סופית - אם זה עדכון ולא נבחרה קטגוריה, נשתמש במקורית
           let targetCategory = finalCategory;
           const sourceCategory = originalCategory || currentSheet || finalCategory;
           
           // עדכון הקטגוריה ב-item
           item.category = targetCategory;
           
           // טיפול בתמונה - אם לא העלו תמונה חדשה, נשלח null כדי שהתמונה הקיימת תישמר
           // אם העלו תמונה חדשה, נשלח את ה-base64
           let imageToSend = null;
           if (currentImageBase64 && currentImageBase64.length > 0 && currentImageBase64 !== 'null') {
             // יש תמונה חדשה - נשלח אותה
             imageToSend = currentImageBase64;
           } else if (rowIndex) {
             // זה עדכון - נשלח null כדי שהתמונה הקיימת תישמר (אם יש)
             imageToSend = null; // null אומר לשמור את התמונה הקיימת
           }
           
           if (rowIndex && sourceCategory) {
             // עדכון מוצר קיים
             // אם הקטגוריה השתנתה, מוסיפים לקטגוריה החדשה ומוחקים מהישנה
             if (targetCategory && targetCategory !== sourceCategory) {
               // מוחק מהישן ומוסיף לחדש
               google.script.run.withSuccessHandler(function() {
                 google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure)
                   .addItem(targetCategory, item, imageToSend);
               }).withFailureHandler(onFailure).deleteItem(sourceCategory, rowIndex);
             } else {
               // עדכון באותה קטגוריה
               google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure)
                 .updateItem(sourceCategory, rowIndex, item, imageToSend);
             }
           } else {
             // הוספה חדשה (אין rowIndex)
             google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure)
               .addItem(targetCategory, item, imageToSend);
           }
           
           // איפוס המשתנים
           originalCategory = null;
           originalImageUrl = null;
         }
         
         function updateItemOnlyChanges() {
           const rowIndex = document.getElementById('itemRowIndex').value;
           if (!rowIndex) {
             Swal.fire('שגיאה', 'לא נמצא מוצר לעדכון', 'error');
             return;
           }
           
           if (!currentEditingItem) {
             Swal.fire('שגיאה', 'לא נמצא מידע על המוצר המקורי', 'error');
             return;
           }
           
           const categorySelect = document.getElementById('itemCategory');
           let category = categorySelect ? categorySelect.value : '';
           if (!category || category === '') {
             category = originalCategory || currentSheet;
           }
           
           if (!category) {
             Swal.fire('שגיאה', 'חובה לבחור קטגוריה', 'error');
             return;
           }
           
           // השוואת הערכים הנוכחיים עם המקוריים - עדכון רק מה שהשתנה
           const changes = {};
           const currentName = document.getElementById('itemName').value;
           const currentQuantity = parseFloat(document.getElementById('itemQuantity').value) || 0;
           const currentNotes = document.getElementById('itemNotes').value;
           const currentCompany = document.getElementById('itemCompany').value;
           const currentPrice = parseFloat(document.getElementById('itemPrice').value) || 0;
           const currentPurchasePrice = parseFloat(document.getElementById('itemPurchasePrice').value) || 0;
           const currentStatus = parseInt(document.getElementById('itemStatus').value);
           const currentSize = document.getElementById('itemSize').value || '';
           
           // עדכון כל השדות שהשתנו (כולל כמות ומידה)
           if (currentName !== currentEditingItem.name) changes.name = currentName;
           if (currentQuantity !== (parseFloat(currentEditingItem.quantity) || 0)) changes.quantity = currentQuantity;
           if (currentNotes !== (currentEditingItem.notes || '')) changes.notes = currentNotes;
           if (currentCompany !== (currentEditingItem.company || '')) changes.company = currentCompany;
           if (currentPrice !== (parseFloat(currentEditingItem.price) || 0)) changes.price = currentPrice;
           if (currentPurchasePrice !== (parseFloat(currentEditingItem.purchasePrice) || 0)) changes.purchasePrice = currentPurchasePrice;
           if (currentStatus !== (parseInt(currentEditingItem.status) || 0)) changes.status = currentStatus;
           if (currentSize !== (currentEditingItem.size || '')) changes.size = currentSize;
           
           // אם הקטגוריה השתנתה
           if (category !== (originalCategory || currentSheet)) {
             changes.category = category;
           }
           
           // אם אין שינויים
           if (Object.keys(changes).length === 0 && !currentImageBase64) {
             Swal.fire('מידע', 'לא בוצעו שינויים', 'info');
             return;
           }
           
           // בניית item עם הערכים המקוריים + השינויים
           const item = {
             name: changes.name !== undefined ? changes.name : currentEditingItem.name,
             quantity: changes.quantity !== undefined ? changes.quantity : (parseFloat(currentEditingItem.quantity) || 0),
             notes: changes.notes !== undefined ? changes.notes : (currentEditingItem.notes || ''),
             company: changes.company !== undefined ? changes.company : (currentEditingItem.company || ''),
             status: changes.status !== undefined ? changes.status : (parseInt(currentEditingItem.status) || 0),
             price: changes.price !== undefined ? changes.price : (parseFloat(currentEditingItem.price) || 0),
             purchasePrice: changes.purchasePrice !== undefined ? changes.purchasePrice : (parseFloat(currentEditingItem.purchasePrice) || 0),
             soldQuantity: currentEditingItem.soldQuantity || 0, // נשאר כמו שהיה
             size: changes.size !== undefined ? changes.size : (currentEditingItem.size || ''),
             category: changes.category !== undefined ? changes.category : (originalCategory || currentSheet)
           };
           
           itemModal.hide();
           
           Swal.fire({
             title: 'מעדכן רק שינויים...',
             didOpen: () => { Swal.showLoading() },
             allowOutsideClick: false
           });
           
           const sourceCategory = originalCategory || currentSheet;
           const targetCategory = item.category;
           
           let imageToSend = null;
           if (currentImageBase64 && currentImageBase64.length > 0 && currentImageBase64 !== 'null') {
             imageToSend = currentImageBase64;
           }
           
           const onSuccess = (response) => {
             Swal.fire({icon: 'success', title: response.message || 'המוצר עודכן בהצלחה!', timer: 1500, showConfirmButton: false});
             invalidateCache('all');
             setTimeout(() => {
               loadData();
             }, 300);
           };
           
           const onFailure = (error) => {
             // שגיאה בעדכון מוצר - ההודעה מוצגת למשתמש ב-Swal
             Swal.fire({icon: 'error', title: 'שגיאה', text: error.message || 'אירעה שגיאה בעדכון המוצר'});
           };
           
           if (targetCategory && targetCategory !== sourceCategory) {
             // הקטגוריה השתנתה - מוסיפים לקטגוריה החדשה ומוחקים מהישנה
             google.script.run.withSuccessHandler(function() {
               google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure)
                 .addItem(targetCategory, item, imageToSend);
             }).withFailureHandler(onFailure).deleteItem(sourceCategory, rowIndex);
           } else {
             // עדכון באותה קטגוריה
             google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure)
               .updateItem(sourceCategory, rowIndex, item, imageToSend);
           }
           
           originalCategory = null;
           originalImageUrl = null;
         }
         
         function deleteItemFromModal() {
           const deleteButtonContainer = document.getElementById('deleteItemButtonContainer');
           if (!deleteButtonContainer) return;
           
           const rowIndex = deleteButtonContainer.getAttribute('data-item-row');
           const itemName = deleteButtonContainer.getAttribute('data-item-name');
           const category = deleteButtonContainer.getAttribute('data-item-category');
           
           if (rowIndex && itemName) {
             itemModal.hide();
             deleteItemConfirm(rowIndex, itemName, category);
           }
         }
         
         function deleteItemConfirm(rowIndex, itemName, category) {
           Swal.fire({
             title: 'האם אתה בטוח?',
             text: `האם אתה רוצה למחוק את "${itemName}" לגמרי?`,
             icon: 'warning',
             showCancelButton: true,
             confirmButtonColor: '#d33',
             cancelButtonColor: '#8d6e63',
             confirmButtonText: 'כן, מחק!',
             cancelButtonText: 'ביטול',
             reverseButtons: true
           }).then((result) => {
             if (result.isConfirmed) {
               Swal.fire({
                 title: 'מוחק...',
                 didOpen: () => { Swal.showLoading() },
                 allowOutsideClick: false
               });
               
               google.script.run
                 .withSuccessHandler(function(response) {
                   Swal.fire({icon: 'success', title: response.message, timer: 1000, showConfirmButton: false});
                   // איפוס cache כדי לטעון נתונים מעודכנים
                   invalidateCache('all');
                   loadData();
                 })
                 .withFailureHandler(function(error) {
                   Swal.fire({icon: 'error', title: 'שגיאה', text: error.message});
                 })
                 .deleteItem(category || currentSheet, rowIndex);
             }
           });
         }
         
         function loadCategoriesForSelect(selectCategoryName) {
           google.script.run.withSuccessHandler(function(sheetNames) {
             const select = document.getElementById('itemCategory');
             select.innerHTML = '<option value="">בחר קטגוריה...</option>';
             
             // סינון גיליונות לא רצויים
             const hiddenCategories = ['כרטיסי קרבה ולקוחות', 'היסטוריית מכירות'];
             const filteredNames = sheetNames.filter(name => {
               if (hiddenCategories.includes(name)) return false;
               // הסתרת גיליונות זמניים של ייצוא
               if (name.startsWith('ייצוא_')) return false;
               return true;
             });
             
             filteredNames.forEach(name => {
               const option = document.createElement('option');
               option.value = name;
               option.textContent = name;
               // אם יש קטגוריה לבחירה אוטומטית, נבחר אותה
               if (selectCategoryName && name === selectCategoryName) {
                 option.selected = true;
               } else if (!selectCategoryName && name === currentSheet) {
                 option.selected = true;
               }
               select.appendChild(option);
             });
             
             // אם יש קטגוריה לבחירה אוטומטית, נבחר אותה גם דרך value
             if (selectCategoryName) {
               select.value = selectCategoryName;
             }
           }).getSheetNames();
         }
         
         function showAddCategoryInput() {
           const inputDiv = document.getElementById('newCategoryInput');
           inputDiv.style.display = inputDiv.style.display === 'none' ? 'block' : 'none';
           if (inputDiv.style.display === 'block') {
             document.getElementById('newCategoryName').focus();
           }
         }
         
         function addNewCategory() {
           const categoryName = document.getElementById('newCategoryName').value.trim();
           if (!categoryName) {
             Swal.fire('שגיאה', 'חובה להזין שם קטגוריה', 'error');
             return;
           }
           
           google.script.run
             .withSuccessHandler(function(response) {
               if (response.success) {
                 document.getElementById('newCategoryName').value = '';
                 document.getElementById('newCategoryInput').style.display = 'none';
                 
                 // עדכון רשימת הקטגוריות עם בחירה אוטומטית של הקטגוריה החדשה
                 loadCategoriesForSelect(categoryName);
                 loadCategoriesMenu();
                 
                 // עדכון גם את originalCategory אם יש מוצר פתוח לעריכה
                 const rowIndex = document.getElementById('itemRowIndex').value;
                 if (rowIndex) {
                   originalCategory = categoryName;
                 }
                 
                 Swal.fire({icon: 'success', title: response.message, timer: 1000, showConfirmButton: false});
               }
             })
             .withFailureHandler(function(error) {
               Swal.fire({icon: 'error', title: 'שגיאה', text: error.message});
             })
             .createCategory(categoryName);
         }
         
         function loadCategories() {
           google.script.run.withSuccessHandler(function(sheetNames) {
             const container = document.getElementById('categoriesList');
             
             // סינון גיליונות לא רצויים
             const hiddenCategories = ['כרטיסי קרבה ולקוחות', 'היסטוריית מכירות'];
             const filteredNames = sheetNames.filter(name => {
               if (hiddenCategories.includes(name)) return false;
               // הסתרת גיליונות זמניים של ייצוא
               if (name.startsWith('ייצוא_')) return false;
               return true;
             });
             
             let html = '';
             
             // הוספת כפתורי איפוס
             html += `
               <div class="card shadow-sm mb-4 border-danger">
                 <div class="card-header bg-danger text-white">
                   <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>אפשרויות איפוס</h6>
                 </div>
                 <div class="card-body">
                   <div class="row g-2">
                     <div class="col-12 col-md-6 col-lg-4">
                       <button class="btn btn-outline-danger w-100" onclick="resetHistoryConfirm()">
                         <i class="bi bi-clock-history me-2"></i>איפוס היסטוריית מכירות
                       </button>
                     </div>
                     <div class="col-12 col-md-6 col-lg-4">
                       <button class="btn btn-outline-danger w-100" onclick="resetAddedItemsHistoryConfirm()">
                         <i class="bi bi-plus-circle me-2"></i>איפוס היסטוריית הוספות
                       </button>
                     </div>
                     <div class="col-12 col-md-6 col-lg-4">
                       <button class="btn btn-outline-danger w-100" onclick="deleteAllItemsConfirm()">
                         <i class="bi bi-trash me-2"></i>מחיקת כל המוצרים
                       </button>
                     </div>
                     <div class="col-12 col-md-6 col-lg-4">
                       <button class="btn btn-outline-danger w-100" onclick="resetSoldQuantitiesConfirm()">
                         <i class="bi bi-arrow-counterclockwise me-2"></i>איפוס כמות נמכרת
                       </button>
                     </div>
                     <div class="col-12 col-md-6 col-lg-4">
                       <button class="btn btn-outline-danger w-100" onclick="resetAllHistoryConfirm()">
                         <i class="bi bi-arrow-repeat me-2"></i>איפוס כל ההיסטוריה
                       </button>
                     </div>
                     <div class="col-12 col-md-6 col-lg-4">
                       <button class="btn btn-outline-danger w-100" onclick="resetToInitialStateConfirm()">
                         <i class="bi bi-arrow-left-circle me-2"></i>איפוס למצב התחלתי
                       </button>
                     </div>
                   </div>
                   <div class="alert alert-warning mt-3 mb-0">
                     <i class="bi bi-exclamation-triangle me-2"></i>
                     <strong>אזהרה:</strong> פעולות האיפוס הן בלתי הפיכות! ודא שיש לך גיבוי לפני ביצוע פעולות אלה.
                   </div>
                 </div>
               </div>
             `;
             
             if (filteredNames.length === 0) {
               html += `
                 <div class="text-center text-muted py-5">
                   <i class="bi bi-folder display-1 opacity-25"></i>
                   <p class="mt-3">אין מדורים</p>
                   <small class="text-muted">הוסף מדור חדש כדי להתחיל</small>
                 </div>
               `;
               container.innerHTML = html;
               return;
             }
             
             html += '<div class="row g-2">';
             filteredNames.forEach(name => {
               html += `
                 <div class="col-12 col-md-6 col-lg-4">
                   <div class="card shadow-sm">
                     <div class="card-body">
                       <h6 class="card-title fw-bold mb-2">
                         <i class="bi bi-folder me-2"></i>${name}
                       </h6>
                       <div class="d-flex gap-2">
                         <button class="btn btn-sm" style="background: #D4A574; color: white; border: none;" onclick="showEditCategoryModal('${name}')">
                           <i class="bi bi-pencil me-1"></i>ערוך
                         </button>
                         <button class="btn btn-sm btn-danger" onclick="deleteCategoryConfirm('${name}')">
                           <i class="bi bi-trash me-1"></i>מחק
                         </button>
                       </div>
                     </div>
                   </div>
                 </div>
               `;
             });
             html += '</div>';
             container.innerHTML = html;
           }).getSheetNames();
         }
         
         function showAddCategoryModal() {
           document.getElementById('categoryModalTitle').innerText = 'הוסף מדור חדש';
           document.getElementById('categoryName').value = '';
           document.getElementById('oldCategoryName').value = '';
           categoryModal.show();
         }
         
         function showEditCategoryModal(oldName) {
           document.getElementById('categoryModalTitle').innerText = 'ערוך שם מדור';
           document.getElementById('categoryName').value = oldName;
           document.getElementById('oldCategoryName').value = oldName;
           categoryModal.show();
         }
         
         function saveCategory() {
           const categoryName = document.getElementById('categoryName').value.trim();
           const oldCategoryName = document.getElementById('oldCategoryName').value.trim();
           
           if (!categoryName) {
             Swal.fire('שגיאה', 'חובה להזין שם מדור', 'error');
             return;
           }
           
           categoryModal.hide();
           
           // אם יש שם ישן, זה עריכה. אחרת זה הוספה חדשה
           if (oldCategoryName) {
             // עריכת שם מדור
             Swal.fire({
               title: 'מעדכן שם מדור...',
               didOpen: () => { Swal.showLoading() },
               allowOutsideClick: false
             });
             
             google.script.run
               .withSuccessHandler(function(response) {
                 if (response.success) {
                   Swal.fire({icon: 'success', title: response.message, timer: 1000, showConfirmButton: false});
                   // איפוס cache
                   invalidateCache('all');
                   loadCategories();
                   loadCategoriesForSelect();
                   loadCategoriesMenu();
                   
                   // אם הקטגוריה הנוכחית היא זו שעודכנה, עדכן את currentSheet
                   if (currentSheet === oldCategoryName) {
                     currentSheet = categoryName;
                     loadData();
                   }
                 } else {
                   Swal.fire({icon: 'error', title: 'שגיאה', text: response.message});
                 }
               })
               .withFailureHandler(function(error) {
                 Swal.fire({icon: 'error', title: 'שגיאה', text: error.message});
               })
               .renameCategory(oldCategoryName, categoryName);
           } else {
             // הוספת מדור חדש
             Swal.fire({
               title: 'יוצר מדור...',
               didOpen: () => { Swal.showLoading() },
               allowOutsideClick: false
             });
             
             google.script.run
               .withSuccessHandler(function(response) {
                 Swal.fire({icon: 'success', title: response.message, timer: 1000, showConfirmButton: false});
                 // איפוס cache
                 invalidateCache('all');
                 loadCategories();
                 loadCategoriesForSelect();
                 // עדכון רשימת הקטגוריות בתפריט הנפתח
                 loadCategoriesMenu();
               })
               .withFailureHandler(function(error) {
                 Swal.fire({icon: 'error', title: 'שגיאה', text: error.message});
               })
               .createCategory(categoryName);
           }
         }
         
         // פונקציות איפוס
         function resetHistoryConfirm() {
           Swal.fire({
             title: 'האם אתה בטוח?',
             html: '<div style="text-align: right; direction: rtl;">פעולה זו תמחק את כל היסטוריית המכירות.<br><strong>פעולה זו בלתי הפיכה!</strong></div>',
             icon: 'warning',
             showCancelButton: true,
             confirmButtonColor: '#d33',
             cancelButtonColor: '#8d6e63',
             confirmButtonText: 'כן, אפס!',
             cancelButtonText: 'ביטול',
             reverseButtons: true,
             input: 'text',
             inputPlaceholder: 'הקלד "איפוס" לאישור',
             inputValidator: (value) => {
               if (value !== 'איפוס') {
                 return 'עליך להקליד "איפוס" לאישור';
               }
             }
           }).then((result) => {
             if (result.isConfirmed) {
               Swal.fire({
                 title: 'מאפס...',
                 didOpen: () => { Swal.showLoading() },
                 allowOutsideClick: false
               });
               google.script.run
                 .withSuccessHandler(function(response) {
                   Swal.fire({icon: 'success', title: response.message, timer: 2000, showConfirmButton: false});
                   invalidateCache('all');
                 })
                 .withFailureHandler(function(error) {
                   Swal.fire({icon: 'error', title: 'שגיאה', text: error.message});
                 })
                 .resetSalesHistory();
             }
           });
         }
         
         function resetAddedItemsHistoryConfirm() {
           Swal.fire({
             title: 'האם אתה בטוח?',
             html: '<div style="text-align: right; direction: rtl;">פעולה זו תמחק את כל היסטוריית ההוספות.<br><strong>פעולה זו בלתי הפיכה!</strong></div>',
             icon: 'warning',
             showCancelButton: true,
             confirmButtonColor: '#d33',
             cancelButtonColor: '#8d6e63',
             confirmButtonText: 'כן, אפס!',
             cancelButtonText: 'ביטול',
             reverseButtons: true,
             input: 'text',
             inputPlaceholder: 'הקלד "איפוס" לאישור',
             inputValidator: (value) => {
               if (value !== 'איפוס') {
                 return 'עליך להקליד "איפוס" לאישור';
               }
             }
           }).then((result) => {
             if (result.isConfirmed) {
               Swal.fire({
                 title: 'מאפס...',
                 didOpen: () => { Swal.showLoading() },
                 allowOutsideClick: false
               });
               google.script.run
                 .withSuccessHandler(function(response) {
                   Swal.fire({icon: 'success', title: response.message, timer: 2000, showConfirmButton: false});
                   invalidateCache('all');
                 })
                 .withFailureHandler(function(error) {
                   Swal.fire({icon: 'error', title: 'שגיאה', text: error.message});
                 })
                 .resetAddedItemsHistory();
             }
           });
         }
         
         function deleteAllItemsConfirm() {
           Swal.fire({
             title: 'האם אתה בטוח?',
             html: '<div style="text-align: right; direction: rtl;">פעולה זו תמחק את כל המוצרים מכל הקטגוריות.<br><strong>פעולה זו בלתי הפיכה!</strong></div>',
             icon: 'warning',
             showCancelButton: true,
             confirmButtonColor: '#d33',
             cancelButtonColor: '#8d6e63',
             confirmButtonText: 'כן, מחק הכל!',
             cancelButtonText: 'ביטול',
             reverseButtons: true,
             input: 'text',
             inputPlaceholder: 'הקלד "מחיקה" לאישור',
             inputValidator: (value) => {
               if (value !== 'מחיקה') {
                 return 'עליך להקליד "מחיקה" לאישור';
               }
             }
           }).then((result) => {
             if (result.isConfirmed) {
               Swal.fire({
                 title: 'מוחק...',
                 didOpen: () => { Swal.showLoading() },
                 allowOutsideClick: false
               });
               google.script.run
                 .withSuccessHandler(function(response) {
                   Swal.fire({icon: 'success', title: response.message, timer: 2000, showConfirmButton: false});
                   invalidateCache('all');
                   loadData();
                 })
                 .withFailureHandler(function(error) {
                   Swal.fire({icon: 'error', title: 'שגיאה', text: error.message});
                 })
                 .deleteAllItems();
             }
           });
         }
         
         function resetSoldQuantitiesConfirm() {
           Swal.fire({
             title: 'האם אתה בטוח?',
             html: '<div style="text-align: right; direction: rtl;">פעולה זו תאפס את כל הכמויות הנמכרות של כל המוצרים.<br><strong>פעולה זו בלתי הפיכה!</strong></div>',
             icon: 'warning',
             showCancelButton: true,
             confirmButtonColor: '#d33',
             cancelButtonColor: '#8d6e63',
             confirmButtonText: 'כן, אפס!',
             cancelButtonText: 'ביטול',
             reverseButtons: true,
             input: 'text',
             inputPlaceholder: 'הקלד "איפוס" לאישור',
             inputValidator: (value) => {
               if (value !== 'איפוס') {
                 return 'עליך להקליד "איפוס" לאישור';
               }
             }
           }).then((result) => {
             if (result.isConfirmed) {
               Swal.fire({
                 title: 'מאפס...',
                 didOpen: () => { Swal.showLoading() },
                 allowOutsideClick: false
               });
               google.script.run
                 .withSuccessHandler(function(response) {
                   Swal.fire({icon: 'success', title: response.message, timer: 2000, showConfirmButton: false});
                   invalidateCache('all');
                   loadData();
                 })
                 .withFailureHandler(function(error) {
                   Swal.fire({icon: 'error', title: 'שגיאה', text: error.message});
                 })
                 .resetSoldQuantities();
             }
           });
         }
         
         function resetAllHistoryConfirm() {
           Swal.fire({
             title: 'האם אתה בטוח?',
             html: '<div style="text-align: right; direction: rtl;">פעולה זו תמחק את כל ההיסטוריה (מכירות והוספות).<br><strong>פעולה זו בלתי הפיכה!</strong></div>',
             icon: 'warning',
             showCancelButton: true,
             confirmButtonColor: '#d33',
             cancelButtonColor: '#8d6e63',
             confirmButtonText: 'כן, אפס הכל!',
             cancelButtonText: 'ביטול',
             reverseButtons: true,
             input: 'text',
             inputPlaceholder: 'הקלד "איפוס הכל" לאישור',
             inputValidator: (value) => {
               if (value !== 'איפוס הכל') {
                 return 'עליך להקליד "איפוס הכל" לאישור';
               }
             }
           }).then((result) => {
             if (result.isConfirmed) {
               Swal.fire({
                 title: 'מאפס...',
                 didOpen: () => { Swal.showLoading() },
                 allowOutsideClick: false
               });
               google.script.run
                 .withSuccessHandler(function(response) {
                   Swal.fire({icon: 'success', title: response.message, timer: 2000, showConfirmButton: false});
                   invalidateCache('all');
                 })
                 .withFailureHandler(function(error) {
                   Swal.fire({icon: 'error', title: 'שגיאה', text: error.message});
                 })
                 .resetAllHistory();
             }
           });
         }
         
         function resetToInitialStateConfirm() {
           Swal.fire({
             title: 'האם אתה בטוח?',
             html: '<div style="text-align: right; direction: rtl;">פעולה זו תאפס את כל התוכנה למצב התחלתי:<br>- מחיקת כל המוצרים<br>- מחיקת כל ההיסטוריה<br>- איפוס כל הכמויות הנמכרות<br><strong>פעולה זו בלתי הפיכה!</strong></div>',
             icon: 'warning',
             showCancelButton: true,
             confirmButtonColor: '#d33',
             cancelButtonColor: '#8d6e63',
             confirmButtonText: 'כן, אפס הכל!',
             cancelButtonText: 'ביטול',
             reverseButtons: true,
             input: 'text',
             inputPlaceholder: 'הקלד "איפוס מלא" לאישור',
             inputValidator: (value) => {
               if (value !== 'איפוס מלא') {
                 return 'עליך להקליד "איפוס מלא" לאישור';
               }
             }
           }).then((result) => {
             if (result.isConfirmed) {
               Swal.fire({
                 title: 'מאפס...',
                 didOpen: () => { Swal.showLoading() },
                 allowOutsideClick: false
               });
               google.script.run
                 .withSuccessHandler(function(response) {
                   Swal.fire({icon: 'success', title: response.message, timer: 2000, showConfirmButton: false});
                   invalidateCache('all');
                   loadData();
                   loadCategories();
                 })
                 .withFailureHandler(function(error) {
                   Swal.fire({icon: 'error', title: 'שגיאה', text: error.message});
                 })
                 .resetToInitialState();
             }
           });
         }
         
         function deleteCategoryConfirm(categoryName) {
           Swal.fire({
             title: 'האם אתה בטוח?',
             text: `האם אתה רוצה למחוק את המדור "${categoryName}"? כל המוצרים במדור זה יועברו למדור 'ללא קטגוריה'.`,
             icon: 'warning',
             showCancelButton: true,
             confirmButtonColor: '#d33',
             cancelButtonColor: '#8d6e63',
             confirmButtonText: 'כן, מחק!',
             cancelButtonText: 'ביטול',
             reverseButtons: true
           }).then((result) => {
             if (result.isConfirmed) {
               Swal.fire({
                 title: 'מוחק...',
                 didOpen: () => { Swal.showLoading() },
                 allowOutsideClick: false
               });
               
               google.script.run
                 .withSuccessHandler(function(response) {
                   Swal.fire({icon: 'success', title: response.message, timer: 1000, showConfirmButton: false});
                   // איפוס cache
                   invalidateCache('all');
                   loadCategories();
                   loadCategoriesForSelect();
                   // עדכון רשימת הקטגוריות בתפריט הנפתח
                   loadCategoriesMenu();
                   if (currentSheet === categoryName) {
                     // אם הקטגוריה שנמחקה היא הנוכחית, טען את הראשונה
                     google.script.run.withSuccessHandler(function(sheetNames) {
                       if (sheetNames.length > 0) {
                         currentSheet = sheetNames[0];
                         loadData();
                       } else {
                         document.getElementById('contentArea').innerHTML = '<div class="text-center text-muted py-5"><p>אין מוצרים</p></div>';
                       }
                     }).getSheetNames();
                   }
                 })
                 .withFailureHandler(function(error) {
                   Swal.fire({icon: 'error', title: 'שגיאה', text: error.message});
                 })
                 .deleteCategory(categoryName);
             }
           });
         }
         
         function loadStatistics() {
           if (dataCache.statistics) {
             renderStatistics(dataCache.statistics);
             return;
           }
           
           document.getElementById('statTotalItems').innerText = '...';
           document.getElementById('statTotalQuantity').innerText = '...';
           document.getElementById('statTotalValue').innerText = '...';
           document.getElementById('statLowStock').innerText = '...';
           document.getElementById('statTotalSold').innerText = '...';
           document.getElementById('statStockPercentage').innerText = '...';
           document.getElementById('statTotalCategories').innerText = '...';
           document.getElementById('statAveragePrice').innerText = '...';
           document.getElementById('statTopProduct').innerText = '...';
           document.getElementById('outOfStockCount').innerText = '...';
           
           // הוספת timeout למניעת תקיעות
           let statsTimeoutId = setTimeout(function() {
             const statsContent = statsView ? statsView.querySelector('.content-overlay') : null;
             if (statsContent && statsContent.querySelector('.spinner-border')) {
               statsContent.innerHTML = '<div class="alert alert-warning">הטעינה לוקחת זמן רב. נסה לרענן את הדף (F5) או לנסות שוב.</div>';
             }
           }, 30000); // 30 שניות
           
           google.script.run.withSuccessHandler(function(stats) {
             clearTimeout(statsTimeoutId);
             // שמירה ב-cache עם timestamp
             dataCache.statistics = stats;
             dataCache.statisticsTimestamp = Date.now();
             renderStatistics(stats);
           }).withFailureHandler(function(error) {
             clearTimeout(statsTimeoutId);
             // שגיאה בטעינת סטטיסטיקות - ההודעה מוצגת למשתמש
             const statsView = document.getElementById('statsView');
             if (statsView) {
               const statsContent = statsView.querySelector('.content-overlay');
               if (statsContent) {
                 statsContent.innerHTML = '<div class="alert alert-danger">שגיאה בטעינת הנתונים: ' + (error.message || 'נסה לרענן את הדף') + '</div>';
               }
             }
           }).getAllStatistics();
         }
         
         let allProductsData = []; // משתנה גלובלי לשמירת כל המוצרים
         let allProductsLoaded = false; // האם כל המוצרים נטענו
         
         function renderStatistics(stats) {
           // שמירת כל המוצרים
           allProductsData = {
             byQuantity: stats.allItemsByQuantity || [],
             byValue: stats.allItemsByValue || []
           };
           allProductsLoaded = false;
           
           // חישוב סטטיסטיקות נוספות
           const allItemsByQty = stats.allItemsByQuantity || [];
           const allItemsByVal = stats.allItemsByValue || [];
           const totalSold = allItemsByQty.reduce((sum, item) => sum + (parseInt(item.soldQuantity) || 0), 0);
           const totalWithPrice = allItemsByVal.filter(item => parseFloat(item.price) > 0);
           const averagePrice = totalWithPrice.length > 0 
             ? totalWithPrice.reduce((sum, item) => sum + parseFloat(item.price || 0), 0) / totalWithPrice.length 
             : 0;
           const stockPercentage = stats.totalQuantity > 0 && (stats.totalQuantity + totalSold) > 0
             ? ((stats.totalQuantity / (stats.totalQuantity + totalSold)) * 100).toFixed(1)
             : '0.0';
           const topProduct = (stats.topByQuantity && stats.topByQuantity.length > 0) ? stats.topByQuantity[0].name : '-';
           const totalCategories = Object.keys(stats.byCategory || {}).length;
           
           // עדכון כרטיסי KPI
           document.getElementById('statTotalItems').innerText = stats.totalItems;
           document.getElementById('statTotalQuantity').innerText = stats.totalQuantity;
           document.getElementById('statTotalValue').innerText = '₪' + parseFloat(stats.totalValue).toFixed(2);
           document.getElementById('statLowStock').innerText = stats.lowStockCount;
           document.getElementById('statTotalSold').innerText = totalSold;
           document.getElementById('statStockPercentage').innerText = stockPercentage + '%';
           document.getElementById('statTotalCategories').innerText = totalCategories;
           document.getElementById('statAveragePrice').innerText = '₪' + averagePrice.toFixed(2);
           document.getElementById('statTopProduct').innerText = topProduct.length > 20 ? topProduct.substring(0, 20) + '...' : topProduct;
           
           // עדכון פילוח קטגוריות
           const categoryBreakdownBody = document.getElementById('categoryBreakdownBody');
           if (categoryBreakdownBody && stats.byCategory) {
             let categoryHTML = '';
             const categories = Object.entries(stats.byCategory).sort((a, b) => b[1].totalValue - a[1].totalValue);
             categories.forEach(([name, data]) => {
               categoryHTML += `
                 <tr>
                   <td><strong>${name}</strong></td>
                   <td class="text-center">${data.totalItems || 0}</td>
                   <td class="text-center">${data.totalQuantity || 0}</td>
                   <td class="text-end">₪${parseFloat(data.totalValue || 0).toFixed(2)}</td>
                 </tr>
               `;
             });
             categoryBreakdownBody.innerHTML = categoryHTML || '<tr><td colspan="4" class="text-center text-muted">אין נתונים</td></tr>';
           }
         
           // רשימת פריטים עם מלאי נמוך
           const lowStockList = document.getElementById('lowStockList');
           if (stats.lowStockItems.length === 0) {
             lowStockList.innerHTML = `
               <div class="text-center text-muted py-3">
                 <i class="bi bi-check-circle fs-1 opacity-25"></i>
                 <p class="mt-2">אין פריטים עם מלאי נמוך</p>
               </div>
             `;
           } else {
             let html = '';
             stats.lowStockItems.forEach(item => {
               const isDanger = item.quantity === 0;
               html += `
                 <div class="low-stock-item ${isDanger ? 'danger' : ''}">
                   <div class="d-flex justify-content-between align-items-center">
                     <div>
                       <strong>${item.name}</strong>
                       ${item.company ? `<span class="badge bg-secondary ms-2">${item.company}</span>` : ''}
                       ${item.category ? `<span class="badge bg-info ms-1">${item.category}</span>` : ''}
                       <div class="small text-muted mt-1">
                         כמות: <strong>${item.quantity}</strong>
                         ${item.price > 0 ? ` | מחיר: ₪${parseFloat(item.price).toFixed(2)}` : ''}
                       </div>
                     </div>
                     <i class="bi bi-exclamation-triangle-fill text-warning fs-4"></i>
                   </div>
                 </div>
               `;
             });
             lowStockList.innerHTML = html;
           }
         
           // רשימת מוצרים שחסרים לגמרי
           const outOfStockList = document.getElementById('outOfStockList');
           const outOfStockCount = document.getElementById('outOfStockCount');
           const outOfStockItems = stats.outOfStockItems || [];
           
           outOfStockCount.innerText = outOfStockItems.length;
           
           if (outOfStockItems.length === 0) {
             outOfStockList.innerHTML = `
               <div class="text-center text-muted py-3">
                 <i class="bi bi-check-circle fs-1 opacity-25"></i>
                 <p class="mt-2">אין מוצרים חסרים</p>
               </div>
             `;
           } else {
             let html = '';
             outOfStockItems.forEach(item => {
               html += `
                 <div class="low-stock-item danger" style="border-left: 4px solid #dc3545;">
                   <div class="d-flex justify-content-between align-items-center">
                     <div style="flex: 1;">
                       <strong style="color: #dc3545;">${item.name}</strong>
                       ${item.company ? `<span class="badge bg-secondary ms-2">${item.company}</span>` : ''}
                       ${item.category ? `<span class="badge bg-info ms-1">${item.category}</span>` : ''}
                       <div class="small text-muted mt-1">
                         כמות: <strong style="color: #dc3545;">0</strong>
                         ${item.price > 0 ? ` | מחיר: ₪${parseFloat(item.price).toFixed(2)}` : ''}
                         ${item.notes ? ` | ${item.notes}` : ''}
                       </div>
                     </div>
                     <i class="bi bi-x-circle-fill text-danger fs-4"></i>
                   </div>
                 </div>
               `;
             });
             outOfStockList.innerHTML = html;
           }
         
           // גרף כמות
           const quantityCtx = document.getElementById('quantityChart').getContext('2d');
           if (quantityChart) quantityChart.destroy();
           
           const quantityLabels = stats.topByQuantity.map(item => item.name.length > 15 ? item.name.substring(0, 15) + '...' : item.name);
           const quantityData = stats.topByQuantity.map(item => item.quantity);
           
           quantityChart = new Chart(quantityCtx, {
             type: 'bar',
             data: {
               labels: quantityLabels,
               datasets: [{
                 label: 'כמות',
                 data: quantityData,
                 backgroundColor: 'rgba(212, 165, 116, 0.6)',
                 borderColor: 'rgba(212, 165, 116, 1)',
                 borderWidth: 2,
                 borderRadius: 8
               }]
             },
             options: {
               responsive: true,
               maintainAspectRatio: false,
               plugins: {
                 legend: {
                   display: false
                 }
               },
               scales: {
                 y: {
                   beginAtZero: true,
                   ticks: {
                     stepSize: 1
                   }
                 }
               }
             }
           });
         
           // גרף ערך
           const valueCtx = document.getElementById('valueChart').getContext('2d');
           if (valueChart) valueChart.destroy();
           
           const valueLabels = stats.topByValue.map(item => item.name.length > 15 ? item.name.substring(0, 15) + '...' : item.name);
           const valueData = stats.topByValue.map(item => item.value);
           
           valueChart = new Chart(valueCtx, {
             type: 'line',
             data: {
               labels: valueLabels,
               datasets: [{
                 label: 'ערך כולל (₪)',
                 data: valueData,
                 borderColor: 'rgba(212, 165, 116, 1)',
                 backgroundColor: 'rgba(212, 165, 116, 0.1)',
                 borderWidth: 3,
                 fill: true,
                 tension: 0.4,
                 pointRadius: 5,
                 pointBackgroundColor: 'rgba(212, 165, 116, 1)',
                 pointBorderColor: '#fff',
                 pointBorderWidth: 2
               }]
             },
             options: {
               responsive: true,
               maintainAspectRatio: false,
               plugins: {
                 legend: {
                   display: false
                 }
               },
               scales: {
                 y: {
                   beginAtZero: true,
                   ticks: {
                     callback: function(value) {
                       return '₪' + value.toFixed(0);
                     }
                   }
                 }
               }
             }
           });
         
           // הסרת הצגת מוצרים מובילים
         }
         
         function renderTopProducts(products) {
           const container = document.getElementById('topProductsList');
           if (!products || products.length === 0) {
             container.innerHTML = `
               <div class="text-center text-muted py-5 w-100">
                 <i class="bi bi-box display-1 opacity-25"></i>
                 <p class="mt-2">אין מוצרים להצגה</p>
               </div>
             `;
             return;
           }
         
           let html = '';
           products.forEach(product => {
             const imageHtml = product.image 
               ? `<img src="${product.image}" alt="${product.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />`
               : '';
             const placeholderHtml = `<div style="display: ${product.image ? 'none' : 'flex'}; width: 100%; height: 150px; background: linear-gradient(135deg, #D4A574, #B8956A); border-radius: 8px; align-items: center; justify-content: center; color: white; font-size: 2.5rem;"><i class="bi bi-image"></i></div>`;
             
             html += `
               <div class="product-card-carousel">
                 ${imageHtml}
                 ${placeholderHtml}
                 <div class="product-name" title="${product.name}">${product.name}</div>
                 <div class="product-info">קטגוריה: ${product.category || 'ללא'}</div>
                 <div class="product-info">כמות: ${product.quantity}</div>
                 <div class="product-value">ערך: ₪${parseFloat(product.value || 0).toFixed(2)}</div>
               </div>
             `;
           });
           container.innerHTML = html;
         }
         
         function loadAllProducts() {
           if (!allProductsData || !allProductsData.byQuantity || allProductsData.byQuantity.length === 0) {
             Swal.fire('שגיאה', 'אין מוצרים לטעינה', 'error');
             return;
           }
         
           const section = document.getElementById('allProductsSection');
           const container = document.getElementById('allProductsList');
           const countSpan = document.getElementById('allProductsCount');
           
           section.style.display = 'block';
           countSpan.innerText = allProductsData.byQuantity.length;
           
           // הצגת טעינה
           container.innerHTML = `
             <div class="text-center text-muted py-5 w-100">
               <div class="spinner-border spinner-border-sm" role="status" style="color: #D4A574;"></div>
               <p class="mt-2 small">טוען ${allProductsData.byQuantity.length} מוצרים...</p>
             </div>
           `;
         
           // גלילה לסקציה
           setTimeout(() => {
             section.scrollIntoView({ behavior: 'smooth', block: 'start' });
             
             // טעינת כל המוצרים
             renderAllProducts(allProductsData.byQuantity);
           }, 300);
         }
         
         function renderAllProducts(products) {
           const container = document.getElementById('allProductsList');
           if (!products || products.length === 0) {
             container.innerHTML = `
               <div class="text-center text-muted py-5 w-100">
                 <i class="bi bi-box display-1 opacity-25"></i>
                 <p class="mt-2">אין מוצרים להצגה</p>
               </div>
             `;
             return;
           }
         
           let html = '';
           products.forEach(product => {
             const imageHtml = product.image 
               ? `<img src="${product.image}" alt="${product.name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />`
               : '';
             const placeholderHtml = `<div style="display: ${product.image ? 'none' : 'flex'}; width: 100%; height: 150px; background: linear-gradient(135deg, #D4A574, #B8956A); border-radius: 8px; align-items: center; justify-content: center; color: white; font-size: 2.5rem;"><i class="bi bi-image"></i></div>`;
             
             html += `
               <div class="product-card-carousel">
                 ${imageHtml}
                 ${placeholderHtml}
                 <div class="product-name" title="${product.name}">${product.name}</div>
                 <div class="product-info">קטגוריה: ${product.category || 'ללא'}</div>
                 <div class="product-info">כמות: ${product.quantity}</div>
                 <div class="product-value">ערך: ₪${parseFloat(product.value || 0).toFixed(2)}</div>
               </div>
             `;
           });
           container.innerHTML = html;
           allProductsLoaded = true;
         }
         
         function hideAllProducts() {
           document.getElementById('allProductsSection').style.display = 'none';
         }
         
         function scrollProductsCarousel(direction) {
           const carousel = document.getElementById('topProductsList');
           const scrollAmount = 220; // רוחב כרטיס + gap
           // ב-RTL, prev זה ימינה (חיובי) ו-next זה שמאלה (שלילי)
           if (direction === 'prev') {
             carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
           } else {
             carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
           }
         }
         
         function scrollAllProductsCarousel(direction) {
           const carousel = document.getElementById('allProductsList');
           const scrollAmount = 220; // רוחב כרטיס + gap
           // ב-RTL, prev זה ימינה (חיובי) ו-next זה שמאלה (שלילי)
           if (direction === 'prev') {
             carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
           } else {
             carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
           }
         }
         
         // פונקציה לסנכרון עם מערכות המכירה
         function syncWithSalesSystems() {
           const syncButton = document.getElementById('syncButton');
           const originalHTML = syncButton.innerHTML;
           
           // הצגת מצב טעינה
           syncButton.disabled = true;
           syncButton.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> <span class="d-none d-md-inline">מסנכרן...</span>';
           
           // קריאה לשרת לסנכרון
           google.script.run
             .withSuccessHandler(function(result) {
               syncButton.disabled = false;
               syncButton.innerHTML = originalHTML;
               
               if (result && result.success) {
                 Swal.fire({
                   icon: 'success',
                   title: 'סנכרון הושלם',
                   text: result.message || 'הנתונים עודכנו בהצלחה',
                   timer: 2000,
                   showConfirmButton: false,
                   confirmButtonColor: '#D4A574'
                 });
                 
                 // רענון הנתונים אם צריך
                 if (typeof loadItems === 'function') {
                   loadItems();
                 }
               } else {
                 Swal.fire({
                   icon: 'error',
                   title: 'שגיאה בסנכרון',
                   text: result ? (result.message || result.error || 'אירעה שגיאה בעת הסנכרון') : 'אירעה שגיאה בעת הסנכרון',
                   confirmButtonColor: '#D4A574'
                 });
               }
             })
             .withFailureHandler(function(error) {
               syncButton.disabled = false;
               syncButton.innerHTML = originalHTML;
               
               Swal.fire({
                 icon: 'error',
                 title: 'שגיאה בסנכרון',
                 text: error ? (error.message || 'אירעה שגיאה בעת הסנכרון') : 'אירעה שגיאה בעת הסנכרון',
                 confirmButtonColor: '#D4A574'
               });
             })
             .syncSalesSystems();
         }
         
         // הוספת CSS לאנימציה
         if (!document.getElementById('sync-spin-style')) {
           const style = document.createElement('style');
           style.id = 'sync-spin-style';
           style.textContent = `
             @keyframes spin {
               from { transform: rotate(0deg); }
               to { transform: rotate(360deg); }
             }
             .spin {
               animation: spin 1s linear infinite;
             }
           `;
           document.head.appendChild(style);
         }
      </script>
   </body>
</html>
